<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phân Tích Chứng Khoán VN30</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600&family=JetBrains+Mono:wght@500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #0a0c10;
            --card: #12151c;
            --text: #e6edf3;
            --muted: #7d8590;
            --accent: #2f81f7;
            --up: #3fb950;
            --down: #f85149;
            --border: #30363d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lexend', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 20px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            position: relative;
        }

        .stat-card:hover .tooltip {
            display: block;
        }

        .stat-label {
            color: var(--muted);
            font-size: 0.8rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .tooltip {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            background: #21262d;
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            width: 250px;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .tooltip b {
            color: var(--accent);
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 15px;
            border-radius: 8px;
            outline: none;
            font-family: 'JetBrains Mono', monospace;
            width: 150px;
        }

        button.btn-refresh {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
        }

        button.btn-refresh:hover {
            background: var(--border);
        }

        button.btn-refresh:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 25px;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .stock-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .stock-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .stock-card.active {
            border-color: var(--accent);
            background: rgba(47, 129, 247, 0.05);
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .ticker-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .price-big {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .change-tag {
            font-size: 0.85rem;
            padding: 2px 8px;
            border-radius: 4px;
            margin-top: 5px;
            display: inline-block;
        }

        .up-bg {
            background: rgba(63, 185, 80, 0.15);
            color: var(--up);
        }

        .down-bg {
            background: rgba(248, 81, 73, 0.15);
            color: var(--down);
        }

        .investment-mini {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }

        /* Analysis Area */
        .analysis-view {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            min-height: 600px;
        }

        .chart-wrap {
            height: 400px;
            margin: 20px 0;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 30px;
        }

        .advice-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .badge-buy {
            background: var(--up);
            color: white;
        }

        .badge-sell {
            background: var(--down);
            color: white;
        }

        .badge-hold {
            background: var(--muted);
            color: white;
        }

        .calc-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid var(--border);
        }

        .calc-item label {
            display: block;
            color: var(--muted);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .pnl-display {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .remove-icon {
            position: absolute;
            top: 10px;
            right: 15px;
            color: var(--muted);
            opacity: 0;
        }

        .stock-card:hover .remove-icon {
            opacity: 1;
        }

        .up {
            color: var(--up);
        }

        .down {
            color: var(--down);
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <div class="logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18" />
                    <path d="m19 9-5 5-4-4-3 3" />
                </svg>
                VN30 Insights
            </div>
            <div class="search-box">
                <button class="btn-refresh" id="refresh-btn" onclick="updateAllPrices()">
                    <svg id="refresh-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path
                            d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                    </svg>
                    <span id="refresh-text">Làm mới</span>
                </button>
                <input type="text" id="ticker-input" placeholder="Mã (VD: VCB)" maxlength="3">
                <button onclick="addTicker()">Thêm Mã</button>
            </div>
        </header>

        <div class="main-grid">
            <div class="sidebar" id="sidebar">
                <!-- Cards will be here -->
            </div>

            <div class="analysis-view" id="analysis-view" style="display: none;">
                <div class="info-bar">
                    <div>
                        <h1 id="active-ticker" style="font-size: 3rem; font-family: 'JetBrains Mono';">---</h1>
                        <p id="active-name" style="color: var(--muted);">Công ty Cổ phần</p>
                    </div>
                    <div style="text-align: right;">
                        <div id="active-price" style="font-size: 2.5rem; font-weight: 600;">---</div>
                        <div id="active-change" style="font-size: 1.2rem;">---</div>
                    </div>
                </div>

                <div class="advice-box">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                        <span id="advice-badge" class="badge">CHỜ...</span>
                        <strong style="font-size: 1.1rem;">Nhận định từ AI</strong>
                    </div>
                    <p id="advice-text" style="line-height: 1.6; color: var(--text);">Đang phân tích dữ liệu thị
                        trường...</p>
                </div>

                <div class="stats-grid" id="stats-grid">
                    <!-- Stats will be here -->
                </div>

                <div class="chart-wrap">
                    <canvas id="stockChart"></canvas>
                </div>

                <div class="calc-section">
                    <div class="calc-item">
                        <label>Giá vốn của bạn (ngàn VND):</label>
                        <input type="number" id="buy-price-input" style="width: 200px; font-size: 1.2rem;"
                            placeholder="Nhập giá mua..." onchange="saveInvestment()">
                    </div>
                    <div class="calc-item" style="text-align: right;">
                        <label>Ước tính Lời/Lỗ:</label>
                        <div id="pnl-result" class="pnl-display">---</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration & State
        let tickers = JSON.parse(localStorage.getItem('stocks_list')) || ['VIC', 'VHM', 'FPT'];
        let investments = JSON.parse(localStorage.getItem('stocks_invest')) || {};
        let activeTicker = null;
        let priceData = {};
        let chartObj = null;

        async function init() {
            renderSidebar();
            await updateAllPrices();
            if (tickers.length > 0) selectTicker(tickers[0]);
        }

        async function updateAllPrices() {
            const btn = document.getElementById('refresh-btn');
            const icon = document.getElementById('refresh-icon');
            const text = document.getElementById('refresh-text');

            try {
                // Hiển thị trạng thái loading
                btn.disabled = true;
                icon.classList.add('spinning');
                text.innerText = 'Đang tải...';

                const res = await fetch(`/api/quote?tickers=${tickers.join(',')}`);
                const json = await res.json();
                if (json.data) {
                    json.data.forEach(d => {
                        priceData[d.ticker] = d;
                    });
                }
                renderSidebar();

                // Cập nhật lại thông tin cổ phiếu đang xem nếu có
                if (activeTicker) {
                    await selectTicker(activeTicker);
                }
            } catch (e) {
                console.error("Lỗi cập nhật giá:", e);
                alert("Không thể làm mới dữ liệu. Vui lòng thử lại sau.");
            } finally {
                // Kết thúc loading
                btn.disabled = false;
                icon.classList.remove('spinning');
                text.innerText = 'Làm mới';
            }
        }

        function renderSidebar() {
            const side = document.getElementById('sidebar');
            side.innerHTML = '';

            tickers.forEach(t => {
                const d = priceData[t] || {};
                const price = d.price ? (d.price / 1000).toFixed(2) : '---';
                const change = d.dayChangePercent ? (d.dayChangePercent * 100).toFixed(2) : '0.00';
                const isUp = parseFloat(change) >= 0;

                const card = document.createElement('div');
                card.className = `stock-card ${activeTicker === t ? 'active' : ''}`;
                card.onclick = () => selectTicker(t);

                // PnL mini
                let pnlHtml = '<div style="color: var(--muted)">Chưa nhập giá mua</div>';
                if (investments[t] && d.price) {
                    const buy = investments[t];
                    const current = d.price / 1000;
                    const diff = ((current - buy) / buy * 100).toFixed(2);
                    const cls = diff >= 0 ? 'up' : 'down';
                    pnlHtml = `Lời/Lỗ: <span class="${cls}">${diff >= 0 ? '+' : ''}${diff}%</span>`;
                }

                card.innerHTML = `
                <span class="remove-icon" onclick="removeTicker('${t}', event)">✕</span>
                <div class="card-top">
                    <span class="ticker-name">${t}</span>
                    <div style="text-align: right;">
                        <div class="price-big">${price}</div>
                        <div class="change-tag ${isUp ? 'up-bg' : 'down-bg'}">
                            ${isUp ? '▲' : '▼'} ${change}%
                        </div>
                    </div>
                </div>
                <div class="investment-mini">
                    ${pnlHtml}
                </div>
            `;
                side.appendChild(card);
            });
        }

        async function selectTicker(t) {
            activeTicker = t;
            document.getElementById('analysis-view').style.display = 'block';

            // Cập nhật UI ngay lập tức
            const d = priceData[t] || {};
            document.getElementById('active-ticker').innerText = t;
            document.getElementById('active-price').innerText = d.price ? (d.price / 1000).toFixed(2) : '---';

            const change = d.dayChangePercent ? (d.dayChangePercent * 100).toFixed(2) : '0.00';
            const isUp = parseFloat(change) >= 0;
            document.getElementById('active-change').innerText = `${isUp ? '+' : ''}${change}%`;
            document.getElementById('active-change').className = isUp ? 'up' : 'down';

            // Load giá mua
            document.getElementById('buy-price-input').value = investments[t] || '';
            calculatePnL();

            // Highligh card
            document.querySelectorAll('.stock-card').forEach(c => c.classList.remove('active'));
            renderSidebar();

            // Load stats & history
            await Promise.all([
                loadStats(t),
                loadHistory(t)
            ]);
        }

        async function loadStats(t) {
            try {
                const res = await fetch(`/api/stats?ticker=${t}`);
                const json = await res.json();
                const d = json.data;

                const grid = document.getElementById('stats-grid');
                grid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">P/E ⓘ
                        <div class="tooltip">
                            <b>P/E (Price-to-Earnings):</b> Giá gấp bao nhiêu lần lợi nhuận.<br><br>
                            - <b>Thấp (&lt; 10):</b> Cổ phiếu rẻ hoặc doanh nghiệp đang suy giảm.<br>
                            - <b>Cao (&gt; 20):</b> Cổ phiếu kỳ vọng tăng trưởng cao hoặc đang bị thổi giá.<br>
                            - <b>Tốt:</b> 10 - 15 (với thị trường VN).
                        </div>
                    </div>
                    <div class="stat-value">${d.pe ? d.pe.toFixed(2) : '---'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">P/B ⓘ
                        <div class="tooltip">
                            <b>P/B (Price-to-Book):</b> Giá gấp bao nhiêu lần giá trị sổ sách.<br><br>
                            - <b>&lt; 1.0:</b> Giá thị trường thấp hơn giá trị tài sản ròng.<br>
                            - <b>&gt; 2.5:</b> Rủi ro nếu doanh nghiệp không có lợi thế cạnh tranh cực lớn.<br>
                            - <b>Tốt:</b> Quanh 1.2 - 1.8.
                        </div>
                    </div>
                    <div class="stat-value">${d.pb ? d.pb.toFixed(2) : '---'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ROE ⓘ
                        <div class="tooltip">
                            <b>ROE (Return on Equity):</b> Lợi nhuận trên vốn chủ sở hữu.<br><br>
                            - <b>Mức tốt:</b> &gt; 15% liên tục trong nhiều năm.<br>
                            - <b>&lt; 7%:</b> Không hiệu quả bằng gửi tiết kiệm ngân hàng.
                        </div>
                    </div>
                    <div class="stat-value">${d.roe ? (d.roe * 100).toFixed(2) : '---'}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Vốn hóa ⓘ
                        <div class="tooltip">
                            <b>Market Cap:</b> Tổng giá trị thị trường của doanh nghiệp.<br><br>
                            - <b>Large Cap:</b> &gt; 10.000 tỷ VND (An toàn cao).<br>
                            - <b>Mid Cap:</b> 1.000 - 10.000 tỷ.<br>
                            - <b>Small Cap:</b> &lt; 1.000 tỷ (Biến động mạnh).
                        </div>
                    </div>
                    <div class="stat-value">${d.marketCap ? (d.marketCap / 1000).toFixed(1) : '---'}k Tỷ</div>
                </div>
            `;
            } catch (e) {
                console.error("Lỗi stats", e);
            }
        }

        async function loadHistory(t) {
            const res = await fetch(`/api/history?ticker=${t}`);
            const json = await res.json();
            const history = json.data || [];

            const labels = history.map(h => {
                const date = new Date(h.tradingDate);
                return `${date.getDate()}/${date.getMonth() + 1}`;
            }).reverse();

            const prices = history.map(h => h.close / 1000).reverse();

            drawChart(labels, prices);
            generateAI(prices);
        }

        function drawChart(labels, data) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            if (chartObj) chartObj.destroy();

            const grad = ctx.createLinearGradient(0, 0, 0, 400);
            grad.addColorStop(0, 'rgba(47, 129, 247, 0.4)');
            grad.addColorStop(1, 'rgba(47, 129, 247, 0)');

            chartObj = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: '#2f81f7',
                        borderWidth: 2,
                        fill: true,
                        backgroundColor: grad,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#7d8590', maxTicksLimit: 8 }, grid: { display: false } },
                        y: { ticks: { color: '#7d8590' }, grid: { color: '#30363d' } }
                    }
                }
            });
        }

        function generateAI(prices) {
            if (prices.length < 5) return;

            const last = prices[prices.length - 1];
            const prev = prices[prices.length - 2];
            const avg = prices.reduce((a, b) => a + b, 0) / prices.length;

            let status = 'hold';
            let text = '';

            if (last > avg * 1.05) {
                status = 'sell';
                text = "Giá đang ở vùng cao hơn 5% so với trung bình 100 phiên. Bạn có thể cân nhắc chốt lời một phần hoặc tạm ngưng mua mới để quan sát.";
            } else if (last < avg * 0.95) {
                status = 'buy';
                text = "Cổ phiếu đang chiết khấu tốt (thấp hơn 5% so với trung bình). Đây có thể là vùng mua tích lũy an toàn cho dài hạn.";
            } else {
                status = 'hold';
                text = "Giá đang dao động quanh vùng cân bằng. Chiến thuật hợp lý hiện tại là nắm giữ và quan sát thêm các tín hiệu từ khối lượng giao dịch.";
            }

            const badge = document.getElementById('advice-badge');
            badge.innerText = status === 'buy' ? 'MUA' : (status === 'sell' ? 'BÁN' : 'NẮM GIỮ');
            badge.className = `badge badge-${status}`;
            document.getElementById('advice-text').innerText = text;
        }

        function saveInvestment() {
            const val = parseFloat(document.getElementById('buy-price-input').value);
            if (activeTicker) {
                if (isNaN(val)) delete investments[activeTicker];
                else investments[activeTicker] = val;
                localStorage.setItem('stocks_invest', JSON.stringify(investments));
                calculatePnL();
                renderSidebar();
            }
        }

        function calculatePnL() {
            const val = investments[activeTicker];
            const current = priceData[activeTicker]?.price / 1000;
            const res = document.getElementById('pnl-result');

            if (!val || !current) {
                res.innerText = '---';
                res.className = 'pnl-display';
                return;
            }

            const diff = ((current - val) / val * 100).toFixed(2);
            res.innerText = `${diff >= 0 ? '+' : ''}${diff}%`;
            res.className = `pnl-display ${diff >= 0 ? 'up' : 'down'}`;
        }

        function addTicker() {
            const input = document.getElementById('ticker-input');
            const code = input.value.toUpperCase().trim();
            if (code && !tickers.includes(code)) {
                tickers.push(code);
                localStorage.setItem('stocks_list', JSON.stringify(tickers));
                input.value = '';
                updateAllPrices();
            }
        }

        function removeTicker(t, e) {
            e.stopPropagation();
            tickers = tickers.filter(x => x !== t);
            localStorage.setItem('stocks_list', JSON.stringify(tickers));
            if (activeTicker === t) activeTicker = null;
            renderSidebar();
        }

        init();
        setInterval(updateAllPrices, 30000); // Tự động cập nhật mỗi 30s
    </script>
</body>

</html>