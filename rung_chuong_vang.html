<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rung ChuÃ´ng VÃ ng Kids Pro V7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Baloo 2', cursive;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 20px 20px;
            overscroll-behavior: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.96);
            border-radius: 24px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
            border: 4px solid #fff;
        }
        .btn-3d { transition: all 0.1s; border-bottom-width: 5px; position: relative; }
        .btn-3d:active { transform: translateY(4px); border-bottom-width: 1px; }

        .avatar-option { transition: transform 0.2s; }
        .avatar-option:hover { transform: scale(1.15); }
        .avatar-selected { border: 4px solid #FBBF24; border-radius: 50%; background-color: #FFFBEB; transform: scale(1.2); }
        @keyframes ring { 0%,100%{transform:rotate(0)} 10%,30%,50%,70%,90%{transform:rotate(15deg)} 20%,40%,60%,80%{transform:rotate(-15deg)} }
        .bell-ringing { animation: ring 2s ease infinite; }
        .correct-anim { background-color: #86efac !important; border-color: #22c55e !important; transform: scale(1.02); }
        .wrong-anim { background-color: #fca5a5 !important; border-color: #ef4444 !important; animation: shake 0.5s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-10px)} 75%{transform:translateX(10px)} }

        .perspective { perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 12px; border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-front { background: linear-gradient(135deg, #60a5fa, #3b82f6); }
        .card-back { background-color: white; transform: rotateY(180deg); flex-direction: column; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-3 selection:bg-yellow-200 overflow-hidden">

    <div class="fixed top-2 z-10 pointer-events-none">
        <div class="bg-white px-5 py-1.5 rounded-full shadow-xl border-b-4 border-yellow-400 flex items-center gap-3">
            <i class="fa-solid fa-bell text-yellow-500 text-2xl bell-ringing"></i>
            <h1 class="text-xl font-bold text-yellow-600 tracking-wider">RUNG CHUÃ”NG VÃ€NG</h1>
        </div>
    </div>

    <div id="app" class="w-full max-w-lg relative z-0 mt-12 h-full max-h-[850px] flex flex-col pb-safe">

        <!-- 1. LOGIN -->
        <div id="screen-user" class="glass-panel p-5 flex flex-col h-full overflow-hidden">
            <h2 class="text-xl font-bold text-blue-600 text-center mb-2">Ai Ä‘ang chÆ¡i Ä‘áº¥y nhá»‰?</h2>
            <div id="user-list" class="flex-grow overflow-y-auto space-y-3 p-1 mb-2"></div>
            <div class="flex-shrink-0 pt-2 border-t border-dashed border-gray-300">
                <h3 class="text-sm font-bold text-gray-400 mb-2 text-center uppercase">Táº¡o ngÆ°á»i chÆ¡i má»›i</h3>
                <div class="flex justify-center gap-4 mb-3 overflow-x-auto pb-2 px-1" id="avatar-selector"></div>
                <div class="flex flex-col gap-3">
                    <input type="text" id="new-username" placeholder="Nháº­p tÃªn bÃ©..." class="w-full p-3 rounded-xl border-2 border-blue-200 font-bold text-blue-800 text-center text-lg focus:outline-none focus:border-blue-500">
                    <button onclick="handleUserAction()" id="btn-create-user" class="btn-3d w-full bg-green-500 border-green-700 text-white font-bold py-3 rounded-xl text-lg shadow-lg">
                        <i class="fa-solid fa-play mr-2"></i> Báº¯t Ä‘áº§u ngay
                    </button>
                    <button onclick="cancelEdit()" id="btn-cancel-edit" class="hidden text-gray-400 font-bold text-sm">Há»§y bá»</button>
                </div>
            </div>
        </div>

        <!-- 2. MENU -->
        <div id="screen-topic" class="glass-panel p-5 hidden flex flex-col gap-3 h-full">
            <div class="flex justify-between items-center bg-blue-50 p-3 rounded-2xl border-2 border-blue-100">
                <div class="flex items-center gap-3">
                    <div id="display-avatar" class="text-4xl bg-white p-1 rounded-full shadow-sm"></div>
                    <div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Xin chÃ o,</p>
                        <p id="display-username" class="text-xl font-black text-blue-600 leading-none truncate max-w-[140px]"></p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="showDashboard()" class="bg-yellow-400 text-white w-10 h-10 rounded-full shadow-md flex items-center justify-center border-b-4 border-yellow-600 active:border-b-0 active:translate-y-1"><i class="fa-solid fa-chart-pie"></i></button>
                    <button onclick="logout()" class="bg-gray-200 text-gray-500 w-10 h-10 rounded-full shadow-md flex items-center justify-center border-b-4 border-gray-400 active:border-b-0 active:translate-y-1"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
            <div class="flex-grow flex flex-col gap-2 overflow-hidden">
                <div onclick="showMemoryDifficultyModal()" class="cursor-pointer bg-gradient-to-r from-teal-400 to-emerald-500 p-3 rounded-2xl shadow-lg border-b-4 border-teal-700 active:border-b-0 active:translate-y-1 flex items-center gap-3 text-white shrink-0 mt-1">
                    <div class="bg-white/20 p-2 rounded-full h-14 w-14 flex items-center justify-center text-3xl">ğŸ§ </div>
                    <div class="flex-grow"><h3 class="text-lg font-black uppercase">SiÃªu TrÃ­ Nhá»›</h3><p class="text-xs opacity-90">Luyá»‡n nÃ£o & Tá»« vá»±ng</p></div>
                    <i class="fa-solid fa-play text-xl opacity-50 mr-2"></i>
                </div>
                <div class="relative py-2"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div><div class="relative flex justify-center"><span class="bg-white px-2 text-xs font-bold text-gray-400 uppercase">Hoáº·c thi Ä‘áº¥u Quiz</span></div></div>
                <div class="grid grid-cols-2 gap-3 overflow-y-auto pb-2">
                    <button onclick="startGame('toan')" class="btn-3d bg-blue-500 border-blue-700 text-white p-3 rounded-2xl flex flex-col items-center justify-center h-20"><i class="fa-solid fa-calculator text-2xl"></i><span class="font-bold text-sm">ToÃ¡n Há»c</span></button>
                    <button onclick="startGame('tiengviet')" class="btn-3d bg-red-500 border-red-700 text-white p-3 rounded-2xl flex flex-col items-center justify-center h-20"><i class="fa-solid fa-book text-2xl"></i><span class="font-bold text-sm">Tiáº¿ng Viá»‡t</span></button>
                    <button onclick="startGame('tienganh')" class="btn-3d bg-purple-500 border-purple-700 text-white p-3 rounded-2xl flex flex-col items-center justify-center h-20"><i class="fa-solid fa-language text-2xl"></i><span class="font-bold text-sm">Tiáº¿ng Anh</span></button>
                    <button onclick="startGame('tunhien')" class="btn-3d bg-green-500 border-green-700 text-white p-3 rounded-2xl flex flex-col items-center justify-center h-20"><i class="fa-solid fa-leaf text-2xl"></i><span class="font-bold text-sm">Tháº¿ Giá»›i</span></button>
                    <button onclick="startGame('logic')" class="btn-3d bg-orange-500 border-orange-700 text-white p-3 rounded-2xl flex flex-col items-center justify-center h-20"><i class="fa-solid fa-puzzle-piece text-2xl"></i><span class="font-bold text-sm">TÆ° Duy</span></button>
                    <button onclick="startGame('tonghop')" class="btn-3d bg-indigo-500 border-indigo-700 text-white p-3 rounded-2xl flex flex-col items-center justify-center h-20"><i class="fa-solid fa-star text-2xl"></i><span class="font-bold text-sm">Tá»•ng Há»£p</span></button>
                </div>
            </div>
        </div>

        <!-- 3. QUIZ SCREEN -->
        <div id="screen-game" class="glass-panel p-4 hidden flex flex-col h-full relative">
            <div class="flex justify-between items-center mb-2 gap-2">
                <button onclick="showExitModal()" class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-100 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-lg"></i></button>
                <div class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold text-xs border border-blue-200">
                    <span id="game-topic-name">ToÃ¡n</span> <span class="mx-1 text-blue-300">|</span> <span id="question-counter">1/15</span>
                </div>
                <div class="text-2xl font-black text-yellow-500 flex items-center gap-1"><span id="score">0</span><i class="fa-solid fa-star"></i></div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 mb-4 overflow-hidden"><div id="timer-bar" class="bg-green-500 h-3 rounded-full transition-all duration-1000 ease-linear w-full"></div></div>
            <div class="flex-grow flex flex-col justify-center items-center text-center mb-4 relative px-1">
                 <div id="question-image" class="text-6xl mb-4 animate-bounce hidden"></div>
                 <h2 id="question-text" class="text-2xl font-bold text-gray-800 leading-snug">CÃ¢u há»i?</h2>
            </div>
            <div id="answers-container" class="grid grid-cols-1 gap-2 pb-1"></div>
        </div>

        <!-- 4. MEMORY SCREEN (Added Timer) -->
        <div id="screen-memory" class="glass-panel p-4 hidden flex flex-col h-full relative">
            <div class="flex justify-between items-center mb-1">
                <button onclick="showExitModal('memory')" class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-100 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                <div class="text-center">
                    <div class="text-xs font-bold text-gray-400 uppercase" id="memory-level-display">Äá»˜ KHÃ“</div>
                    <div class="text-lg font-black text-teal-600">SiÃªu TrÃ­ Nhá»›</div>
                </div>
                <div class="w-9 h-9 flex items-center justify-center rounded-full bg-yellow-100 text-yellow-600 font-bold text-sm"><span id="memory-moves">0</span></div>
            </div>

            <!-- Memory Timer Bar -->
            <div class="w-full bg-gray-200 rounded-full h-2 mb-3 overflow-hidden">
                <div id="memory-timer-bar" class="bg-teal-500 h-2 rounded-full transition-all duration-1000 ease-linear w-full"></div>
            </div>

            <div id="memory-grid" class="grid gap-2 flex-grow content-center justify-center"></div>
        </div>

        <!-- 5. RESULT SCREEN -->
        <div id="screen-result" class="glass-panel p-6 hidden flex flex-col items-center justify-center h-full text-center">
            <div id="result-icon" class="text-8xl mb-4 animate-bounce">ğŸ‰</div>
            <h2 id="result-title" class="text-3xl font-bold text-yellow-500 mb-2">Tuyá»‡t vá»i!</h2>
            <div class="bg-yellow-50 w-full rounded-2xl p-6 border-2 border-yellow-200 mb-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">ğŸ†</div>
                <p class="text-xs text-gray-500 font-bold uppercase tracking-widest">Tá»•ng Ä‘iá»ƒm</p>
                <div class="text-6xl font-black text-blue-600 mt-2" id="final-score">100</div>
                <div class="text-sm text-gray-500 mt-2 font-bold italic" id="result-feedback"></div>
            </div>
            <div class="flex flex-col gap-3 w-full">
                <button onclick="backToTopics()" class="btn-3d bg-blue-500 border-blue-700 text-white font-bold py-3 rounded-xl text-lg"><i class="fa-solid fa-rotate-right mr-2"></i> ChÆ¡i láº¡i</button>
                <button onclick="showDashboard()" class="btn-3d bg-pink-500 border-pink-700 text-white font-bold py-3 rounded-xl text-lg"><i class="fa-solid fa-trophy mr-2"></i> Xáº¿p háº¡ng</button>
            </div>
        </div>

        <!-- 6. DASHBOARD -->
        <div id="screen-dashboard" class="glass-panel p-4 hidden h-full flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-700"><i class="fa-solid fa-chart-line text-blue-500"></i> Báº£ng ThÃ nh TÃ­ch</h2>
                <button onclick="backToTopics()" class="text-gray-500 bg-gray-100 rounded-full w-9 h-9 flex items-center justify-center"><i class="fa-solid fa-arrow-left"></i></button>
            </div>
            <div class="flex bg-gray-100 rounded-xl p-1 mb-4 shadow-inner">
                <button onclick="switchTab('chart')" id="tab-chart" class="flex-1 py-2 rounded-lg text-xs font-bold transition">Biá»ƒu Ä‘á»“</button>
                <button onclick="switchTab('rank')" id="tab-rank" class="flex-1 py-2 rounded-lg text-xs font-bold transition">Xáº¿p háº¡ng</button>
                <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-2 rounded-lg text-xs font-bold transition">Lá»‹ch sá»­</button>
            </div>
            <div class="flex-grow overflow-y-auto relative px-1">
                <div id="content-chart" class="h-full flex flex-col items-center justify-center">
                    <p class="text-center text-gray-500 text-sm mb-2">NÄƒng lá»±c cá»§a <span id="chart-username" class="font-bold text-blue-600"></span></p>
                    <div class="w-full h-72 relative"><canvas id="performanceChart"></canvas></div>
                </div>
                <div id="content-rank" class="hidden h-full">
                    <div class="flex gap-2 mb-3 overflow-x-auto pb-2 scrollbar-hide" id="rank-filters"></div>
                    <table class="w-full text-left bg-white rounded-xl shadow-sm border border-gray-100"><tbody id="rank-list" class="text-gray-700 text-sm font-bold divide-y"></tbody></table>
                </div>
                <div id="content-history" class="hidden"><table class="w-full text-left border-collapse"><tbody id="history-list" class="text-gray-700 text-sm"></tbody></table></div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-exit" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 text-center max-w-sm w-full shadow-2xl border-4 border-yellow-400">
            <i class="fa-solid fa-face-sad-tear text-5xl text-yellow-500 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-700 mb-2">Con muá»‘n dá»«ng chÆ¡i háº£?</h3>
            <div class="flex gap-3 justify-center mt-6">
                 <button onclick="closeExitModal()" class="flex-1 py-3 rounded-xl bg-gray-200 text-gray-700 font-bold">KhÃ´ng nha</button>
                 <button onclick="realExitGame()" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold border-b-4 border-red-700 active:border-b-0 active:translate-y-1">Dá»«ng láº¡i</button>
            </div>
        </div>
    </div>

    <div id="modal-memory-level" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 text-center max-w-sm w-full shadow-2xl border-4 border-teal-500">
            <h3 class="text-2xl font-black text-teal-600 mb-4 uppercase">Chá»n Ä‘á»™ khÃ³</h3>
            <div class="flex flex-col gap-3">
                <button onclick="startMemoryGame('easy')" class="btn-3d w-full bg-green-500 text-white py-4 rounded-2xl font-bold text-lg border-green-700 flex justify-between px-6">
                    <span>ğŸ£ Dá»…</span> <span class="text-green-100 text-sm mt-1">30 giÃ¢y</span>
                </button>
                <button onclick="startMemoryGame('medium')" class="btn-3d w-full bg-blue-500 text-white py-4 rounded-2xl font-bold text-lg border-blue-700 flex justify-between px-6">
                    <span>ğŸ° Vá»«a</span> <span class="text-blue-100 text-sm mt-1">60 giÃ¢y</span>
                </button>
                <button onclick="startMemoryGame('hard')" class="btn-3d w-full bg-red-500 text-white py-4 rounded-2xl font-bold text-lg border-red-700 flex justify-between px-6">
                    <span>ğŸ¦ KhÃ³</span> <span class="text-red-100 text-sm mt-1">120 giÃ¢y</span>
                </button>
            </div>
            <button onclick="document.getElementById('modal-memory-level').classList.add('hidden')" class="mt-4 text-gray-400 font-bold">Quay láº¡i</button>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq,type,dur,vol=0.1) {
            if(audioCtx.state==='suspended') audioCtx.resume();
            const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
            osc.type=type; osc.frequency.setValueAtTime(freq,audioCtx.currentTime);
            g.gain.setValueAtTime(vol,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+dur);
            osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+dur);
        }
        const sfx = {
            click:()=>playTone(400,'triangle',0.05), correct:()=>{playTone(600,'sine',0.1);setTimeout(()=>playTone(1200,'sine',0.2),100)},
            wrong:()=>{playTone(200,'sawtooth',0.3);setTimeout(()=>playTone(150,'sawtooth',0.3),150)},
            flip:()=>playTone(300,'sine',0.05), match:()=>{playTone(800,'sine',0.1);setTimeout(()=>playTone(1500,'sine',0.2),150)},
            win:()=>{playTone(500,'square',0.1);setTimeout(()=>playTone(700,'square',0.1),100);setTimeout(()=>playTone(900,'square',0.4),200)}
        };

        const genMath = (count) => {
            const arr=[];
            for(let i=0;i<count;i++){
                const type = Math.random();
                if(type<0.3){
                    const a=Math.floor(Math.random()*10), b=Math.floor(Math.random()*10);
                    arr.push({q:`${a} + ${b} = ?`, a:[`${a+b}`,`${a+b+1}`,`${Math.abs(a+b-1)}`,`${a+b+2}`].sort(()=>0.5-Math.random()), c:0, correctVal:`${a+b}`, icon:'â•'});
                } else if(type<0.6){
                    const a=Math.floor(Math.random()*10)+5, b=Math.floor(Math.random()*5);
                    arr.push({q:`${a} - ${b} = ?`, a:[`${a-b}`,`${a-b+1}`,`${a-b-1}`,`${a-b+2}`].sort(()=>0.5-Math.random()), c:0, correctVal:`${a-b}`, icon:'â–'});
                } else {
                    const a=Math.floor(Math.random()*20), b=Math.floor(Math.random()*20);
                    if(a==b){ i--; continue; }
                    const ans = a>b ? [`${a}`, `${b}`] : [`${b}`, `${a}`];
                    arr.push({q:`Sá»‘ nÃ o lá»›n hÆ¡n?`, a:ans, c:0, correctVal: Math.max(a,b)+"", icon:`${a}..${b}`});
                }
            }
            arr.forEach(x => { x.c = x.a.indexOf(x.correctVal); });
            return arr;
        };

        const staticQ = {
            tiengviet: [
                {q:"Con gÃ¬ kÃªu 'Meo meo'?",a:["MÃ¨o","ChÃ³","GÃ ","Lá»£n"],c:0,icon:"ğŸ±"},{q:"Con gÃ¬ giá»¯ nhÃ ?",a:["ChÃ³","MÃ¨o","Chuá»™t","Chim"],c:0,icon:"ğŸ¶"},{q:"Tá»« nÃ o viáº¿t Ä‘Ãºng?",a:["Xinh xáº¯n","Xinh sáº¯n","Sinh xáº¯n","Sinh sáº¯n"],c:0},
                {q:"'Ä‚n quáº£ nhá»› káº» trá»“ng...'",a:["cÃ¢y","hoa","lÃ¡","rá»«ng"],c:0,icon:"ğŸŒ³"},{q:"Ba cÃ²n gá»i lÃ  gÃ¬?",a:["Bá»‘","Máº¹","Ã”ng","ChÃº"],c:0},{q:"Máº¹ cá»§a máº¹ gá»i lÃ ?",a:["BÃ  ngoáº¡i","BÃ  ná»™i","DÃ¬","CÃ´"],c:0,icon:"ğŸ‘µ"},
                {q:"TrÃ¡i gÃ¬ vá» Ä‘á» ruá»™t tráº¯ng háº¡t Ä‘en?",a:["DÆ°a háº¥u","TÃ¡o","á»”i","Cam"],c:0,icon:"ğŸ‰"},{q:"Con vá»‹t kÃªu tháº¿ nÃ o?",a:["Cáº¡p cáº¡p","GÃ¢u gÃ¢u","Meo meo","Ã’ Ã³ o"],c:0,icon:"ğŸ¦†"},
                {q:"Chá»¯ cÃ¡i Ä‘áº§u tiÃªn?",a:["A","B","C","D"],c:0},{q:"Äiá»n tá»«: 'LÃ¡ lÃ nh Ä‘Ã¹m lÃ¡...'",a:["rÃ¡ch","nÃ¡t","hÃ©o","tÆ°Æ¡i"],c:0},{q:"Con gÃ  trá»‘ng kÃªu?",a:["Ã’ Ã³ o","Cá»¥c tÃ¡c","Chiáº¿p chiáº¿p","QuÃ¡c quÃ¡c"],c:0,icon:"ğŸ“"},
                {q:"'Chá»‹ ngÃ£ em...'",a:["nÃ¢ng","Ä‘á»¡","cÆ°á»i","khÃ³c"],c:0},{q:"Quáº£ gÃ¬ cay?",a:["á»št","Chanh","ÄÆ°á»ng","Muá»‘i"],c:0,icon:"ğŸŒ¶ï¸"},{q:"Tá»« trÃ¡i nghÄ©a vá»›i 'Cao'?",a:["Tháº¥p","DÃ i","To","BÃ©o"],c:0},
                {q:"Con trÃ¢u cÃ³ máº¥y chÃ¢n?",a:["4","2","6","8"],c:0,icon:"ğŸƒ"},{q:"'Há»c tháº§y khÃ´ng tÃ y há»c...'",a:["báº¡n","cha","máº¹","anh"],c:0},{q:"BÃ¡nh chÆ°ng hÃ¬nh gÃ¬?",a:["VuÃ´ng","TrÃ²n","Tam giÃ¡c","Chá»¯ nháº­t"],c:0,icon:"ğŸŸ©"},
                {q:"Ã”ng máº·t trá»i mÃ u gÃ¬?",a:["Äá»/VÃ ng","Xanh","TÃ­m","Äen"],c:0,icon:"â˜€ï¸"},{q:"Con gÃ¬ biáº¿t bay?",a:["Chim","CÃ¡","ChÃ³","MÃ¨o"],c:0,icon:"ğŸ¦"},{q:"Xe Ä‘áº¡p cÃ³ máº¥y bÃ¡nh?",a:["2","3","4","1"],c:0,icon:"ğŸš²"},
                {q:"MÃ¹a nÃ o nÃ³ng nháº¥t?",a:["HÃ¨","Thu","ÄÃ´ng","XuÃ¢n"],c:0,icon:"â˜€ï¸"},{q:"Em trai cá»§a bá»‘ gá»i lÃ ?",a:["ChÃº","BÃ¡c","Cáº­u","DÆ°á»£ng"],c:0},{q:"Chá»‹ gÃ¡i cá»§a máº¹ gá»i lÃ ?",a:["BÃ¡c","DÃ¬","CÃ´","Má»£"],c:0},
                {q:"CÃ¡i gÃ¬ dÃ¹ng Ä‘á»ƒ viáº¿t?",a:["BÃºt","ThÆ°á»›c","Táº©y","SÃ¡ch"],c:0,icon:"âœï¸"},{q:"CÃ¡i gÃ¬ dÃ¹ng Ä‘á»ƒ Ä‘á»™i Ä‘áº§u?",a:["MÅ©","GiÃ y","Ão","Quáº§n"],c:0,icon:"ğŸ§¢"},
                {q:"Con gÃ¬ Äƒn cá»?",a:["BÃ²","Há»•","ChÃ³","MÃ¨o"],c:0,icon:"ğŸ„"},{q:"Con gÃ¬ sá»‘ng dÆ°á»›i nÆ°á»›c?",a:["CÃ¡","Chim","GÃ ","Khá»‰"],c:0,icon:"ğŸŸ"},{q:"BÃ´ng hoa mÃ u gÃ¬?",a:["Äá»","Äen","XÃ¡m","NÃ¢u"],c:0,icon:"ğŸŒ¹"},
                {q:"Quáº£ chuá»‘i mÃ u gÃ¬?",a:["VÃ ng","Äá»","TÃ­m","Lam"],c:0,icon:"ğŸŒ"},{q:"CÃ¢y tre cÃ³ Ä‘á»‘t khÃ´ng?",a:["CÃ³","KhÃ´ng"],c:0,icon:"ğŸ"}
            ],
            tienganh: [
                {q:"Hello nghÄ©a lÃ ?",a:["Xin chÃ o","Táº¡m biá»‡t","Cáº£m Æ¡n","Xin lá»—i"],c:0},{q:"Cat lÃ  con gÃ¬?",a:["MÃ¨o","ChÃ³","Lá»£n","GÃ "],c:0,icon:"ğŸ±"},{q:"Dog lÃ  con gÃ¬?",a:["ChÃ³","MÃ¨o","Há»•","SÆ° tá»­"],c:0,icon:"ğŸ•"},
                {q:"Apple lÃ  quáº£ gÃ¬?",a:["TÃ¡o","Cam","Chuá»‘i","Nho"],c:0,icon:"ğŸ"},{q:"Red lÃ  mÃ u gÃ¬?",a:["Äá»","Xanh","VÃ ng","TÃ­m"],c:0,icon:"ğŸŸ¥"},{q:"One lÃ  sá»‘ máº¥y?",a:["1","2","3","4"],c:0,icon:"1ï¸âƒ£"},
                {q:"Thank you lÃ ?",a:["Cáº£m Æ¡n","Xin chÃ o","Xin lá»—i","Táº¡m biá»‡t"],c:0},{q:"Goodbye lÃ ?",a:["Táº¡m biá»‡t","Xin chÃ o","Ngá»§ ngon","Cáº£m Æ¡n"],c:0},{q:"Blue lÃ  mÃ u gÃ¬?",a:["Xanh dÆ°Æ¡ng","Äá»","VÃ ng","Cam"],c:0,icon:"ğŸŸ¦"},
                {q:"Banana lÃ  quáº£ gÃ¬?",a:["Chuá»‘i","TÃ¡o","DÆ°a","á»”i"],c:0,icon:"ğŸŒ"},{q:"Pig lÃ  con gÃ¬?",a:["Lá»£n","GÃ ","Vá»‹t","BÃ²"],c:0,icon:"ğŸ·"},{q:"Chicken lÃ  con gÃ¬?",a:["GÃ ","Vá»‹t","Ngá»—ng","Chim"],c:0,icon:"ğŸ”"},
                {q:"Father lÃ  ai?",a:["Bá»‘","Máº¹","Anh","Chá»‹"],c:0,icon:"ğŸ‘¨"},{q:"Mother lÃ  ai?",a:["Máº¹","Bá»‘","BÃ ","Ã”ng"],c:0,icon:"ğŸ‘©"},{q:"Car lÃ  cÃ¡i gÃ¬?",a:["Ã” tÃ´","Xe mÃ¡y","Xe Ä‘áº¡p","MÃ¡y bay"],c:0,icon:"ğŸš—"},
                {q:"Ball lÃ  cÃ¡i gÃ¬?",a:["Quáº£ bÃ³ng","BÃºp bÃª","CÃ¡i gháº¿","CÃ¡i bÃ n"],c:0,icon:"âš½"},{q:"Book lÃ  cÃ¡i gÃ¬?",a:["SÃ¡ch","BÃºt","Vá»Ÿ","ThÆ°á»›c"],c:0,icon:"ğŸ“–"},{q:"Pen lÃ  cÃ¡i gÃ¬?",a:["BÃºt má»±c","BÃºt chÃ¬","Táº©y","ThÆ°á»›c"],c:0,icon:"ğŸ–Šï¸"},
                {q:"School lÃ  Ä‘Ã¢u?",a:["TrÆ°á»ng há»c","Bá»‡nh viá»‡n","CÃ´ng viÃªn","NhÃ "],c:0,icon:"ğŸ«"},{q:"Teacher lÃ  ai?",a:["GiÃ¡o viÃªn","BÃ¡c sÄ©","CÃ´ng an","NÃ´ng dÃ¢n"],c:0,icon:"ğŸ‘©â€ğŸ«"},{q:"Doctor lÃ  ai?",a:["BÃ¡c sÄ©","Y tÃ¡","GiÃ¡o viÃªn","Ca sÄ©"],c:0,icon:"ğŸ‘¨â€âš•ï¸"},
                {q:"Eye lÃ  gÃ¬?",a:["Máº¯t","MÅ©i","Miá»‡ng","Tai"],c:0,icon:"ğŸ‘€"},{q:"Nose lÃ  gÃ¬?",a:["MÅ©i","Máº¯t","Miá»‡ng","Tay"],c:0,icon:"ğŸ‘ƒ"},{q:"Hand lÃ  gÃ¬?",a:["BÃ n tay","BÃ n chÃ¢n","Äáº§u","Cá»•"],c:0,icon:"ğŸ–ï¸"},
                {q:"Sun lÃ  gÃ¬?",a:["Máº·t trá»i","Máº·t trÄƒng","Sao","MÃ¢y"],c:0,icon:"â˜€ï¸"},{q:"Moon lÃ  gÃ¬?",a:["Máº·t trÄƒng","Máº·t trá»i","Äáº¥t","Biá»ƒn"],c:0,icon:"ğŸŒ™"},{q:"Fish lÃ  con gÃ¬?",a:["CÃ¡","TÃ´m","Cua","á»c"],c:0,icon:"ğŸŸ"},
                {q:"Bird lÃ  con gÃ¬?",a:["Chim","GÃ ","Vá»‹t","BÆ°á»›m"],c:0,icon:"ğŸ¦"},{q:"Flower lÃ  gÃ¬?",a:["BÃ´ng hoa","CÃ¡i cÃ¢y","Cá»","LÃ¡"],c:0,icon:"ğŸŒ¸"},{q:"Milk lÃ  gÃ¬?",a:["Sá»¯a","NÆ°á»›c","TrÃ ","BÃ¡nh"],c:0,icon:"ğŸ¥›"}
            ],
            tunhien: [
                {q:"Máº·t trá»i má»c hÆ°á»›ng nÃ o?",a:["ÄÃ´ng","TÃ¢y","Nam","Báº¯c"],c:0,icon:"ğŸŒ…"},{q:"CÃ¡ sá»‘ng á»Ÿ Ä‘Ã¢u?",a:["DÆ°á»›i nÆ°á»›c","TrÃªn cáº¡n","TrÃªn trá»i","Trong Ä‘áº¥t"],c:0,icon:"ğŸŸ"},
                {q:"ÄÃ¨n Ä‘á» pháº£i lÃ m gÃ¬?",a:["Dá»«ng láº¡i","Äi tiáº¿p","Cháº¡y nhanh","Báº¥m cÃ²i"],c:0,icon:"ğŸ”´"},{q:"Khi mÆ°a cáº§n gÃ¬?",a:["Ã” (dÃ¹)","KÃ­nh rÃ¢m","Kem chá»‘ng náº¯ng","Quáº¡t"],c:0,icon:"â˜”"},
                {q:"MÃ¹a nÃ o láº¡nh nháº¥t?",a:["ÄÃ´ng","HÃ¨","Thu","XuÃ¢n"],c:0,icon:"â›„"},{q:"Con há»• Äƒn gÃ¬?",a:["Thá»‹t","Cá»","CÆ¡m","Káº¹o"],c:0,icon:"ğŸ…"},{q:"NÆ°á»›c biá»ƒn vá»‹ gÃ¬?",a:["Máº·n","Ngá»t","Chua","Cay"],c:0,icon:"ğŸŒŠ"},
                {q:"Cáº§u vá»“ng máº¥y mÃ u?",a:["7","5","3","10"],c:0,icon:"ğŸŒˆ"},{q:"CÃ¢y cáº§n gÃ¬ Ä‘á»ƒ sá»‘ng?",a:["NÆ°á»›c & Ãnh sÃ¡ng","Káº¹o","Thá»‹t","BÃ¡nh"],c:0,icon:"ğŸŒ±"},{q:"Con gÃ¬ cho sá»¯a?",a:["BÃ²","GÃ ","Vá»‹t","Chim"],c:0,icon:"ğŸ„"},
                {q:"BÄƒng tuyáº¿t mÃ u gÃ¬?",a:["Tráº¯ng","Äen","Äá»","VÃ ng"],c:0,icon:"â„ï¸"},{q:"Máº·t trÄƒng tháº¥y khi nÃ o?",a:["Ban Ä‘Ãªm","Ban ngÃ y","Buá»•i trÆ°a","Cáº£ ngÃ y"],c:0,icon:"ğŸŒ™"},
                {q:"Con gÃ¬ cÃ³ vÃ²i dÃ i?",a:["Voi","Há»•","Khá»‰","Chuá»™t"],c:0,icon:"ğŸ˜"},{q:"Con gÃ¬ cá»• dÃ i nháº¥t?",a:["HÆ°Æ¡u cao cá»•","Ngá»±a","TrÃ¢u","BÃ²"],c:0,icon:"ğŸ¦’"},{q:"Con gÃ¬ chÃºa sÆ¡n lÃ¢m?",a:["Há»•/SÆ° tá»­","MÃ¨o","Thá»","GÃ "],c:0,icon:"ğŸ¦"},
                {q:"Gáº¡o náº¥u thÃ nh gÃ¬?",a:["CÆ¡m","ChÃ¡o","BÃºn","Phá»Ÿ"],c:0,icon:"ğŸš"},{q:"Con ong lÃ m gÃ¬?",a:["HÃºt máº­t","Ä‚n cá»","Báº¯t chuá»™t","Ngá»§"],c:0,icon:"ğŸ"},{q:"Con nhá»‡n giÄƒng gÃ¬?",a:["TÆ¡","LÆ°á»›i","DÃ¢y","Chá»‰"],c:0,icon:"ğŸ•¸ï¸"},
                {q:"MÃ¢y mÃ u gÃ¬?",a:["Tráº¯ng","Xanh","Äá»","VÃ ng"],c:0,icon:"â˜ï¸"},{q:"Lá»­a nÃ³ng hay láº¡nh?",a:["NÃ³ng","Láº¡nh"],c:0,icon:"ğŸ”¥"},{q:"ÄÃ¡ cá»©ng hay má»m?",a:["Cá»©ng","Má»m"],c:0,icon:"ğŸª¨"},
                {q:"BÃ´ng gÃ²n nháº¹ hay náº·ng?",a:["Nháº¹","Náº·ng"],c:0},{q:"Con áº¿ch sá»‘ng á»Ÿ Ä‘Ã¢u?",a:["Vá»«a nÆ°á»›c vá»«a cáº¡n","Chá»‰ dÆ°á»›i nÆ°á»›c","Chá»‰ trÃªn cÃ¢y","Trong nhÃ "],c:0,icon:"ğŸ¸"},
                {q:"Con rÃ¹a Ä‘i tháº¿ nÃ o?",a:["Cháº­m","Nhanh","Nháº£y","Bay"],c:0,icon:"ğŸ¢"},{q:"Con thá» thÃ­ch Äƒn gÃ¬?",a:["CÃ  rá»‘t","Thá»‹t","CÆ¡m","CÃ¡"],c:0,icon:"ğŸ¥•"}
            ],
            logic: [
                {q:"CÃ¡i gÃ¬ cÃ ng rá»­a cÃ ng báº©n?",a:["NÆ°á»›c","BÃ¡t","Quáº§n Ã¡o","Xe"],c:0,icon:"ğŸ’§"},{q:"SÃ¡ng 4 chÃ¢n, trÆ°a 2 chÃ¢n, chiá»u 3 chÃ¢n?",a:["Con ngÆ°á»i","Con bÃ²","Con chÃ³","Con gÃ "],c:0,icon:"ğŸ‘¶ğŸ‘¨ğŸ‘´"},
                {q:"1kg sáº¯t vÃ  1kg bÃ´ng cÃ¡i nÃ o náº·ng?",a:["Báº±ng nhau","Sáº¯t","BÃ´ng","KhÃ´ng biáº¿t"],c:0,icon:"âš–ï¸"},{q:"CÃ¡i gÃ¬ cÃ³ chÃ¢n khÃ´ng biáº¿t Ä‘i?",a:["CÃ¡i bÃ n","Con gÃ ","Em bÃ©","Con mÃ¨o"],c:0,icon:"ğŸª‘"},
                {q:"ThÃ¡ng 2 cÃ³ bao nhiÃªu ngÃ y?",a:["28 hoáº·c 29","30","31","25"],c:0},{q:"MÃ¨o con lÃ  con ai?",a:["MÃ¨o máº¹","ChÃ³ máº¹","GÃ  máº¹","Vá»‹t máº¹"],c:0,icon:"ğŸˆ"},
                {q:"CÃ¡i gÃ¬ báº¡n cÃ³ nhÆ°ng ngÆ°á»i khÃ¡c gá»i?",a:["TÃªn","Tiá»n","Xe","NhÃ "],c:0},{q:"TÃ¬m hÃ¬nh khÃ¡c loáº¡i?",a:["BÃ³ng Ä‘Ã¡","CÃ¡i bÃ¡t","CÃ¡i Ä‘Ä©a","CÃ¡i thÃ¬a"],c:0,icon:"âš½"},
                {q:"CÃ¡i gÃ¬ khÃ´ng cÃ¡nh mÃ  bay?",a:["BÃ³ng bay","MÃ¡y bay","Chim","Ong"],c:0,icon:"ğŸˆ"},{q:"NhÃ  Nam cÃ³ 3 anh em: TÃ­, TÃ¨o vÃ  ...?",a:["Nam","BÃ¬nh","An","TÃ¢m"],c:0},
                {q:"Con gÃ¬ sinh ra Ä‘Ã£ giÃ ?",a:["Con Ã”ng (Ong)","Con BÆ°á»›m","Con Muá»—i","Con Ruá»“i"],c:0,icon:"ğŸ"},{q:"CÃ¡i gÃ¬ Ä‘áº­p thÃ¬ sá»‘ng, khÃ´ng Ä‘áº­p thÃ¬ cháº¿t?",a:["TrÃ¡i tim","CÃ¡i trá»‘ng","Quáº£ trá»©ng","Con muá»—i"],c:0,icon:"â¤ï¸"},
                {q:"CÃ ng kÃ©o cÃ ng ngáº¯n lÃ  gÃ¬?",a:["Äiáº¿u thuá»‘c","Sá»£i dÃ¢y","CÃ¡i káº¹o","CÃ¢y thÆ°á»›c"],c:0},{q:"CÃ¡i gÃ¬ Ä‘i thÃ¬ náº±m, Ä‘á»©ng thÃ¬ náº±m, náº±m thÃ¬ Ä‘á»©ng?",a:["BÃ n chÃ¢n","BÃ n tay","CÃ¡i Ä‘áº§u","CÃ¡i bá»¥ng"],c:0,icon:"ğŸ¦¶"},
                {q:"Lá»‹ch nÃ o dÃ i nháº¥t?",a:["Lá»‹ch sá»­","Lá»‹ch treo tÆ°á»ng","Lá»‹ch bÃ n","Lá»‹ch váº¡n niÃªn"],c:0,icon:"ğŸ“š"},{q:"Quáº§n gÃ¬ rá»™ng nháº¥t?",a:["Quáº§n Ä‘áº£o","Quáº§n Ä‘Ã¹i","Quáº§n dÃ i","Quáº§n bÃ²"],c:0,icon:"ğŸï¸"},
                {q:"XÃ£ nÃ o Ä‘Ã´ng nháº¥t?",a:["XÃ£ há»™i","XÃ£ Ä‘Ã n","XÃ£ táº¯c","XÃ£ giao"],c:0},{q:"Con gÃ¬ Ä‘áº­p thÃ¬ cháº¿t, khÃ´ng Ä‘áº­p thÃ¬ sá»‘ng?",a:["Con tim","Con muá»—i","Con ruá»“i","Con kiáº¿n"],c:0},
                {q:"CÃ¡i gÃ¬ cÃ ng tháº¯ng cÃ ng thua?",a:["Äua xe Ä‘áº¡p (Tháº¯ng phanh)","ÄÃ¡nh bÃ i","ÄÃ¡ bÃ³ng","Cháº¡y thi"],c:0},{q:"Biá»ƒn nÃ o khÃ´ng cÃ³ nÆ°á»›c?",a:["Biá»ƒn bÃ¡o/Báº£n Ä‘á»“","Biá»ƒn ÄÃ´ng","Biá»ƒn há»“","Biá»ƒn cháº¿t"],c:0}
            ]
        };

        // === DYNAMIC WORD BANK FOR ENGLISH VOCAB ===
        const enVocabBank = [
            {e:'Elephant',v:'Con voi',i:'ğŸ˜',w:['Con há»•','Con khá»‰','Con chÃ³']},
            {e:'Rabbit',v:'Con thá»',i:'ğŸ°',w:['Con mÃ¨o','Con gÃ ','Con ráº¯n']},
            {e:'Horse',v:'Con ngá»±a',i:'ğŸ´',w:['Con bÃ²','Con dÃª','Con lá»«a']},
            {e:'Frog',v:'Con áº¿ch',i:'ğŸ¸',w:['Con ráº¯n','Con cÃ¡','Con tÃ´m']},
            {e:'Bear',v:'Con gáº¥u',i:'ğŸ»',w:['Con sÃ³i','Con há»•','Con bÃ¡o']},
            {e:'Duck',v:'Con vá»‹t',i:'ğŸ¦†',w:['Con gÃ ','Con ngá»—ng','Con chim']},
            {e:'Cow',v:'Con bÃ²',i:'ğŸ„',w:['Con trÃ¢u','Con dÃª','Con lá»£n']},
            {e:'Sheep',v:'Con cá»«u',i:'ğŸ‘',w:['Con dÃª','Con bÃ²','Con heo']},
            {e:'Snake',v:'Con ráº¯n',i:'ğŸ',w:['Con giun','Con áº¿ch','Con tháº±n láº±n']},
            {e:'Butterfly',v:'Con bÆ°á»›m',i:'ğŸ¦‹',w:['Con ong','Con kiáº¿n','Con chuá»“n chuá»“n']},
            {e:'Turtle',v:'Con rÃ¹a',i:'ğŸ¢',w:['Con á»‘c','Con cua','Con áº¿ch']},
            {e:'Dolphin',v:'CÃ¡ heo',i:'ğŸ¬',w:['CÃ¡ máº­p','CÃ¡ voi','CÃ¡ chÃ©p']},
            {e:'Ant',v:'Con kiáº¿n',i:'ğŸœ',w:['Con ong','Con bá»','Con ruá»“i']},
            {e:'Bee',v:'Con ong',i:'ğŸ',w:['Con kiáº¿n','Con bÆ°á»›m','Con muá»—i']},
            {e:'Banana',v:'Quáº£ chuá»‘i',i:'ğŸŒ',w:['Quáº£ tÃ¡o','Quáº£ cam','Quáº£ xoÃ i']},
            {e:'Orange',v:'Quáº£ cam',i:'ğŸŠ',w:['Quáº£ tÃ¡o','Quáº£ lÃª','Quáº£ á»•i']},
            {e:'Grape',v:'Quáº£ nho',i:'ğŸ‡',w:['Quáº£ máº­n','Quáº£ váº£i','Quáº£ Ä‘Ã o']},
            {e:'Watermelon',v:'DÆ°a háº¥u',i:'ğŸ‰',w:['DÆ°a lÆ°á»›i','Quáº£ bÃ­','Quáº£ dá»«a']},
            {e:'Strawberry',v:'DÃ¢u tÃ¢y',i:'ğŸ“',w:['Quáº£ mÃ¢m xÃ´i','Quáº£ cherry','Quáº£ nho']},
            {e:'Mango',v:'Quáº£ xoÃ i',i:'ğŸ¥­',w:['Quáº£ á»•i','Quáº£ Ä‘Ã o','Quáº£ lÃª']},
            {e:'Water',v:'NÆ°á»›c',i:'ğŸ’§',w:['Sá»¯a','NÆ°á»›c Ã©p','TrÃ ']},
            {e:'Bread',v:'BÃ¡nh mÃ¬',i:'ğŸ',w:['CÆ¡m','Phá»Ÿ','BÃºn']},
            {e:'Rice',v:'Gáº¡o/CÆ¡m',i:'ğŸš',w:['BÃºn','MÃ¬','Phá»Ÿ']},
            {e:'Egg',v:'Quáº£ trá»©ng',i:'ğŸ¥š',w:['Quáº£ bÃ³ng','Quáº£ cam','ViÃªn káº¹o']},
            {e:'Happy',v:'Vui váº»',i:'ğŸ˜Š',w:['Buá»“n','Giáº­n','Sá»£']},
            {e:'Sad',v:'Buá»“n',i:'ğŸ˜¢',w:['Vui','Giáº­n','Sá»£ hÃ£i']},
            {e:'Big',v:'To lá»›n',i:'ğŸ”µ',w:['Nhá» bÃ©','DÃ i','Ngáº¯n']},
            {e:'Small',v:'Nhá» bÃ©',i:'ğŸ”¹',w:['To lá»›n','DÃ i','Cao']},
            {e:'Hot',v:'NÃ³ng',i:'ğŸ”¥',w:['Láº¡nh','áº¤m','MÃ¡t']},
            {e:'Cold',v:'Láº¡nh',i:'â„ï¸',w:['NÃ³ng','áº¤m','MÃ¡t']},
            {e:'Rain',v:'MÆ°a',i:'ğŸŒ§ï¸',w:['Náº¯ng','GiÃ³','Tuyáº¿t']},
            {e:'Wind',v:'GiÃ³',i:'ğŸ’¨',w:['MÆ°a','Náº¯ng','MÃ¢y']},
            {e:'Table',v:'CÃ¡i bÃ n',i:'ğŸª‘',w:['CÃ¡i gháº¿','CÃ¡i giÆ°á»ng','CÃ¡i tá»§']},
            {e:'Door',v:'CÃ¡i cá»­a',i:'ğŸšª',w:['CÃ¡i bÃ n','Bá»©c tÆ°á»ng','SÃ n nhÃ ']},
            {e:'Shirt',v:'Ão sÆ¡ mi',i:'ğŸ‘•',w:['Quáº§n','GiÃ y','MÅ©']},
            {e:'Shoes',v:'ÄÃ´i giÃ y',i:'ğŸ‘Ÿ',w:['DÃ©p','MÅ©','Ão']},
            {e:'Hat',v:'CÃ¡i mÅ©',i:'ğŸ§¢',w:['GiÃ y','Ão','KÃ­nh']},
            {e:'Cake',v:'BÃ¡nh kem',i:'ğŸ‚',w:['Káº¹o','Kem','BÃ¡nh mÃ¬']},
            {e:'Ice cream',v:'Kem',i:'ğŸ¦',w:['BÃ¡nh','Sá»¯a','Káº¹o']},
            {e:'Pizza',v:'BÃ¡nh pizza',i:'ğŸ•',w:['Hamburger','Hotdog','Sandwich']},
            {e:'Family',v:'Gia Ä‘Ã¬nh',i:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦',w:['Báº¡n bÃ¨','TrÆ°á»ng há»c','CÃ´ng viÃªn']},
            {e:'Friend',v:'Báº¡n bÃ¨',i:'ğŸ¤',w:['Gia Ä‘Ã¬nh','NgÆ°á»i láº¡','HÃ ng xÃ³m']},
            {e:'House',v:'NgÃ´i nhÃ ',i:'ğŸ ',w:['TrÆ°á»ng há»c','Bá»‡nh viá»‡n','Cá»­a hÃ ng']},
            {e:'Garden',v:'Khu vÆ°á»n',i:'ğŸŒ»',w:['PhÃ²ng ngá»§','NhÃ  báº¿p','PhÃ²ng khÃ¡ch']},
            {e:'Clock',v:'Äá»“ng há»“',i:'ğŸ•',w:['Lá»‹ch','BÃºt','ThÆ°á»›c']},
            {e:'Phone',v:'Äiá»‡n thoáº¡i',i:'ğŸ“±',w:['MÃ¡y tÃ­nh','Ti vi','ÄÃ i radio']},
            {e:'Pencil',v:'BÃºt chÃ¬',i:'âœï¸',w:['BÃºt má»±c','ThÆ°á»›c káº»','Táº©y']},
            {e:'Kitchen',v:'NhÃ  báº¿p',i:'ğŸ³',w:['PhÃ²ng ngá»§','PhÃ²ng khÃ¡ch','NhÃ  táº¯m']},
            {e:'Bedroom',v:'PhÃ²ng ngá»§',i:'ğŸ›ï¸',w:['NhÃ  báº¿p','PhÃ²ng khÃ¡ch','NhÃ  vá»‡ sinh']},
            {e:'Tooth',v:'RÄƒng',i:'ğŸ¦·',w:['LÆ°á»¡i','MÃ´i','MÅ©i']},
            {e:'Ear',v:'Tai',i:'ğŸ‘‚',w:['Máº¯t','MÅ©i','Miá»‡ng']},
            {e:'Leg',v:'ChÃ¢n',i:'ğŸ¦µ',w:['Tay','Äáº§u','Bá»¥ng']},
            {e:'Hair',v:'TÃ³c',i:'ğŸ’‡',w:['Máº¯t','Tai','MÅ©i']},
            {e:'Brother',v:'Anh/Em trai',i:'ğŸ‘¦',w:['Chá»‹ gÃ¡i','Bá»‘','Máº¹']},
            {e:'Sister',v:'Chá»‹/Em gÃ¡i',i:'ğŸ‘§',w:['Anh trai','Bá»‘','Ã”ng']},
            {e:'Baby',v:'Em bÃ©',i:'ğŸ‘¶',w:['NgÆ°á»i lá»›n','Ã”ng bÃ ','CÃ´ chÃº']},
            {e:'Sing',v:'HÃ¡t',i:'ğŸ¤',w:['Nháº£y','Váº½','Äá»c']},
            {e:'Dance',v:'Nháº£y mÃºa',i:'ğŸ’ƒ',w:['HÃ¡t','Cháº¡y','Ngá»“i']},
            {e:'Sleep',v:'Ngá»§',i:'ğŸ˜´',w:['Ä‚n','ChÆ¡i','Há»c']},
            {e:'Eat',v:'Ä‚n',i:'ğŸ½ï¸',w:['Uá»‘ng','Ngá»§','Cháº¡y']},
            {e:'Run',v:'Cháº¡y',i:'ğŸƒ',w:['Äi bá»™','Ngá»“i','Äá»©ng']},
        ];
        function genTiengAnhFromBank(count) {
            const shuffled = [...enVocabBank].sort(() => 0.5 - Math.random()).slice(0, count);
            return shuffled.map(w => {
                if(Math.random() > 0.5) {
                    return { q:`"${w.e}" nghÄ©a lÃ  gÃ¬?`, a:[w.v,...w.w], c:0, icon:w.i };
                } else {
                    const wrongEn = enVocabBank.filter(x=>x.e!==w.e).sort(()=>0.5-Math.random()).slice(0,3).map(x=>x.e);
                    return { q:`"${w.v}" tiáº¿ng Anh lÃ ?`, a:[w.e,...wrongEn], c:0, icon:w.i };
                }
            });
        }

        // === EXTRA STATIC QUESTIONS ===
        const extraTiengViet = [
            {q:"Con gÃ¬ cÃ³ 8 chÃ¢n?",a:["Báº¡ch tuá»™c","ChÃ³","MÃ¨o","GÃ "],c:0,icon:"ğŸ™"},
            {q:"CÃ¡i gÃ¬ dÃ¹ng Ä‘á»ƒ cáº¯t giáº¥y?",a:["KÃ©o","Dao","BÃºa","ThÆ°á»›c"],c:0,icon:"âœ‚ï¸"},
            {q:"MÃ¹a nÃ o hoa ná»Ÿ nhiá»u?",a:["XuÃ¢n","ÄÃ´ng","Thu","HÃ¨"],c:0,icon:"ğŸŒ¸"},
            {q:"Quá»‘c ká»³ Viá»‡t Nam cÃ³ ngÃ´i sao gÃ¬?",a:["Sao vÃ ng","Sao báº¡c","Sao Ä‘á»","Sao xanh"],c:0,icon:"ğŸ‡»ğŸ‡³"},
            {q:"Con gÃ¬ cÃ³ mai cá»©ng?",a:["RÃ¹a","Thá»","Chuá»™t","MÃ¨o"],c:0,icon:"ğŸ¢"},
            {q:"'CÃ³ cÃ´ng mÃ i sáº¯t cÃ³ ngÃ y nÃªn...'",a:["kim","vÃ ng","báº¡c","dao"],c:0},
            {q:"Con gÃ¬ ngá»§ Ä‘Ã´ng?",a:["Gáº¥u","GÃ ","ChÃ³","MÃ¨o"],c:0,icon:"ğŸ»"},
            {q:"CÃ¡i gÃ¬ dÃ¹ng Ä‘á»ƒ xem giá»?",a:["Äá»“ng há»“","KÃ­nh","LÆ°á»£c","BÃºt"],c:0,icon:"â°"},
            {q:"'Gáº§n má»±c thÃ¬...'",a:["Ä‘en","sÃ¡ng","tá»‘i","tráº¯ng"],c:0},
            {q:"'Gáº§n Ä‘Ã¨n thÃ¬...'",a:["sÃ¡ng","Ä‘en","tá»‘i","má»"],c:0},
            {q:"Con gÃ¬ kÃªu 'Be be'?",a:["DÃª","BÃ²","TrÃ¢u","Ngá»±a"],c:0,icon:"ğŸ"},
            {q:"Tá»« Ä‘á»“ng nghÄ©a vá»›i 'xinh'?",a:["Äáº¹p","Xáº¥u","To","Nhá»"],c:0},
            {q:"Tá»« trÃ¡i nghÄ©a vá»›i 'nhanh'?",a:["Cháº­m","DÃ i","Ngáº¯n","Má»›i"],c:0},
            {q:"Tá»« trÃ¡i nghÄ©a vá»›i 'to'?",a:["Nhá»","DÃ i","Cao","Náº·ng"],c:0},
            {q:"Con gÃ¬ kÃªu 'á»¤m bÃ²'?",a:["áº¾ch","Chim","GÃ ","Vá»‹t"],c:0,icon:"ğŸ¸"},
            {q:"Quáº£ gÃ¬ cÃ³ gai?",a:["Sáº§u riÃªng","XoÃ i","Chuá»‘i","Cam"],c:0,icon:"ğŸŒ°"},
            {q:"Bá»‘n mÃ¹a: XuÃ¢n, Háº¡, Thu vÃ ?",a:["ÄÃ´ng","MÆ°a","Náº¯ng","GiÃ³"],c:0},
            {q:"Thá»§ Ä‘Ã´ Viá»‡t Nam lÃ ?",a:["HÃ  Ná»™i","Há»“ ChÃ­ Minh","ÄÃ  Náºµng","Huáº¿"],c:0,icon:"ğŸ›ï¸"},
            {q:"BÃ© Ä‘i há»c á»Ÿ Ä‘Ã¢u?",a:["TrÆ°á»ng","Chá»£","Bá»‡nh viá»‡n","CÃ´ng viÃªn"],c:0,icon:"ğŸ«"},
            {q:"CÃ¡i gÃ¬ dÃ¹ng Ä‘á»ƒ xÃ³a bÃºt chÃ¬?",a:["Táº©y","ThÆ°á»›c","KÃ©o","BÃºt"],c:0},
            {q:"'Äi má»™t ngÃ y Ä‘Ã ng, há»c má»™t...'",a:["sÃ ng khÃ´n","bÃ i há»c","cuá»‘n sÃ¡ch","cÃ¢u thÆ¡"],c:0},
            {q:"Táº¿t NguyÃªn ÄÃ¡n lÃ  táº¿t gÃ¬?",a:["Táº¿t cá»• truyá»n","Táº¿t Trung Thu","Táº¿t TÃ¢y","Táº¿t HÃ n Thá»±c"],c:0,icon:"ğŸ§§"},
            {q:"Con gÃ¬ cÃ³ sá»«ng?",a:["TrÃ¢u","MÃ¨o","GÃ ","CÃ¡"],c:0,icon:"ğŸƒ"},
            {q:"BÃ n tay cÃ³ máº¥y ngÃ³n?",a:["5","4","6","3"],c:0,icon:"ğŸ–ï¸"},
            {q:"CÆ¡ thá»ƒ cÃ³ máº¥y máº¯t?",a:["2","1","3","4"],c:0,icon:"ğŸ‘€"},
        ];

        const extraTuNhien = [
            {q:"HÃ nh tinh nÃ o gáº§n Máº·t Trá»i nháº¥t?",a:["Sao Thá»§y","Sao Kim","TrÃ¡i Äáº¥t","Sao Há»a"],c:0,icon:"â˜€ï¸"},
            {q:"Äá»™ng váº­t nÃ o lá»›n nháº¥t tháº¿ giá»›i?",a:["CÃ¡ voi xanh","Voi","HÆ°Æ¡u cao cá»•","CÃ¡ máº­p"],c:0,icon:"ğŸ‹"},
            {q:"Con gÃ¬ cháº¡y nhanh nháº¥t?",a:["BÃ¡o gÃª-pa","SÆ° tá»­","Ngá»±a","Thá»"],c:0,icon:"ğŸ†"},
            {q:"NÆ°á»›c Ä‘Ã¡ tan thÃ nh gÃ¬?",a:["NÆ°á»›c","HÆ¡i","KhÃ³i","KhÃ´ng khÃ­"],c:0,icon:"ğŸ§Š"},
            {q:"CÃ¢y lÃºa cho háº¡t gÃ¬?",a:["Gáº¡o","NgÃ´","Äáº­u","Láº¡c"],c:0,icon:"ğŸŒ¾"},
            {q:"Con sÃ¢u lá»›n lÃªn thÃ nh?",a:["BÆ°á»›m","Ong","Kiáº¿n","Ruá»“i"],c:0,icon:"ğŸ›"},
            {q:"TrÃ¡i Äáº¥t hÃ¬nh gÃ¬?",a:["HÃ¬nh cáº§u","HÃ¬nh vuÃ´ng","HÃ¬nh tam giÃ¡c","HÃ¬nh trá»¥"],c:0,icon:"ğŸŒ"},
            {q:"Äá»™ng váº­t nÃ o cÃ³ tÃºi?",a:["Kanguru","Gáº¥u","SÆ° tá»­","Voi"],c:0,icon:"ğŸ¦˜"},
            {q:"Máº·t trá»i láº·n hÆ°á»›ng nÃ o?",a:["TÃ¢y","ÄÃ´ng","Báº¯c","Nam"],c:0,icon:"ğŸŒ…"},
            {q:"SÃ´ng nÃ o dÃ i nháº¥t Viá»‡t Nam?",a:["SÃ´ng MÃª KÃ´ng","SÃ´ng Há»“ng","SÃ´ng ÄÃ ","SÃ´ng HÆ°Æ¡ng"],c:0,icon:"ğŸï¸"},
            {q:"CÃ¢y nÃ o cho quáº£ dá»«a?",a:["CÃ¢y dá»«a","CÃ¢y cam","CÃ¢y xoÃ i","CÃ¢y bÆ°á»Ÿi"],c:0,icon:"ğŸ¥¥"},
            {q:"Con gÃ¬ sá»‘ng á»Ÿ Báº¯c Cá»±c?",a:["Gáº¥u Báº¯c Cá»±c","SÆ° tá»­","Voi","Khá»‰"],c:0,icon:"ğŸ»â€â„ï¸"},
            {q:"Con gÃ¬ cÃ³ tÃºi má»±c?",a:["Má»±c","CÃ¡","TÃ´m","Cua"],c:0,icon:"ğŸ¦‘"},
            {q:"Gá»— láº¥y tá»« Ä‘Ã¢u?",a:["CÃ¢y","ÄÃ¡","Äáº¥t","NÆ°á»›c"],c:0,icon:"ğŸªµ"},
            {q:"Muá»‘i láº¥y tá»« Ä‘Ã¢u?",a:["Biá»ƒn","SÃ´ng","Suá»‘i","Há»“"],c:0,icon:"ğŸ§‚"},
            {q:"Con gÃ¬ cÃ³ 6 chÃ¢n?",a:["CÃ´n trÃ¹ng","ChÃ³","MÃ¨o","CÃ¡"],c:0,icon:"ğŸœ"},
            {q:"MÃ¹a thu lÃ¡ cÃ¢y thÆ°á»ng?",a:["Rá»¥ng","Má»c","Xanh tá»‘t","Ná»Ÿ hoa"],c:0,icon:"ğŸ‚"},
            {q:"Chim cÃ¡nh cá»¥t sá»‘ng á»Ÿ Ä‘Ã¢u?",a:["Nam Cá»±c","Rá»«ng","Sa máº¡c","Biá»ƒn nhiá»‡t Ä‘á»›i"],c:0,icon:"ğŸ§"},
            {q:"NÆ°á»›c sÃ´i á»Ÿ bao nhiÃªu Ä‘á»™ C?",a:["100","50","200","0"],c:0,icon:"â™¨ï¸"},
            {q:"NÃºi nÃ o cao nháº¥t Viá»‡t Nam?",a:["Fansipan","BÃ  Äen","Langbiang","Báº¡ch MÃ£"],c:0,icon:"ğŸ”ï¸"},
        ];

        const extraLogic = [
            {q:"Sá»‘ nÃ o lá»›n nháº¥t trong 15, 51, 55, 11?",a:["55","51","15","11"],c:0},
            {q:"Con gÃ¬ Ä‘áº§u mÃ¨o, Ä‘uÃ´i mÃ¨o mÃ  khÃ´ng pháº£i mÃ¨o?",a:["MÃ¨o con","ChÃ³","Chuá»™t","Thá»"],c:0,icon:"ğŸ±"},
            {q:"2 bá»‘ con cÃ¢u Ä‘Æ°á»£c 3 cÃ¡, má»—i ngÆ°á»i 1 con. VÃ¬ sao?",a:["CÃ³ Ã´ng-bá»‘-con","CÃ³ 3 ngÆ°á»i","Nháº§m láº«n","KhÃ´ng thá»ƒ"],c:0},
            {q:"CÃ¡i gÃ¬ cá»§a mÃ¬nh nhÆ°ng ngÆ°á»i khÃ¡c dÃ¹ng nhiá»u hÆ¡n?",a:["TÃªn","Tiá»n","Xe","NhÃ "],c:0},
            {q:"5 quáº£ tÃ¡o chia 5 bÃ©, sao cÃ²n 1 trong rá»•?",a:["1 bÃ© cáº§m cáº£ rá»•","Äáº¿m sai","CÃ³ 6 quáº£","KhÃ´ng thá»ƒ"],c:0,icon:"ğŸ"},
            {q:"ÄÃ¢u lÃ  sá»‘ láº»: 2, 4, 7, 8?",a:["7","2","4","8"],c:0},
            {q:"ÄÃ¢u lÃ  sá»‘ cháºµn: 1, 3, 6, 9?",a:["6","1","3","9"],c:0},
            {q:"HÃ¬nh tam giÃ¡c cÃ³ máº¥y cáº¡nh?",a:["3","4","5","2"],c:0,icon:"ğŸ”º"},
            {q:"HÃ¬nh vuÃ´ng cÃ³ máº¥y gÃ³c?",a:["4","3","5","6"],c:0,icon:"ğŸŸ¥"},
            {q:"NgÃ y cÃ³ máº¥y giá»?",a:["24","12","30","48"],c:0,icon:"ğŸ•"},
            {q:"Tuáº§n cÃ³ máº¥y ngÃ y?",a:["7","5","6","10"],c:0,icon:"ğŸ“…"},
            {q:"1 nÄƒm cÃ³ máº¥y thÃ¡ng?",a:["12","10","11","13"],c:0,icon:"ğŸ“†"},
            {q:"CÃ¡i gÃ¬ bay khÃ´ng cáº§n cÃ¡nh?",a:["Thá»i gian","Chim","MÃ¡y bay","BÃ³ng bay"],c:0,icon:"â°"},
            {q:"NÆ°á»›c nÃ o nhá» nháº¥t?",a:["NÆ°á»›c máº¯t","NÆ°á»›c Nga","NÆ°á»›c Má»¹","NÆ°á»›c PhÃ¡p"],c:0,icon:"ğŸ˜¢"},
            {q:"Con gÃ¬ cÃ ng táº¯m cÃ ng báº©n?",a:["Con nÆ°á»›c","Con mÃ¨o","Con chÃ³","Con voi"],c:0},
            {q:"CÃ¡i gÃ¬ cÃ³ 4 chÃ¢n mÃ  khÃ´ng biáº¿t Ä‘i?",a:["CÃ¡i bÃ n","Con bÃ²","Con chÃ³","Con vá»‹t"],c:0,icon:"ğŸª‘"},
        ];

        // === EXTRA MATH GENERATOR (multiplication & sequences) ===
        function genExtraMath(count) {
            const arr=[];
            for(let i=0;i<count;i++){
                const type = Math.random();
                if(type<0.35){
                    const a=Math.floor(Math.random()*5)+1, b=Math.floor(Math.random()*5)+1;
                    const correct=a*b;
                    arr.push({q:`${a} Ã— ${b} = ?`,a:[`${correct}`,`${correct+2}`,`${Math.abs(correct-2)}`,`${correct+3}`],c:0,correctVal:`${correct}`,icon:'âœ–ï¸'});
                } else if(type<0.7){
                    const start=Math.floor(Math.random()*5)+1; const step=Math.floor(Math.random()*3)+1;
                    const seq=[start,start+step,start+step*2]; const next=start+step*3;
                    arr.push({q:`${seq.join(', ')}, ... Sá»‘ tiáº¿p theo?`,a:[`${next}`,`${next+2}`,`${Math.abs(next-2)}`,`${next+step+2}`],c:0,correctVal:`${next}`,icon:'ğŸ”¢'});
                } else {
                    const a=Math.floor(Math.random()*10)+10, b=Math.floor(Math.random()*10)+10;
                    const sum=a+b;
                    arr.push({q:`${a} + ${b} = ?`,a:[`${sum}`,`${sum+1}`,`${sum-1}`,`${sum+2}`],c:0,correctVal:`${sum}`,icon:'â•'});
                }
            }
            arr.forEach(x => { x.c = x.a.indexOf(x.correctVal); });
            return arr;
        }

        let onlineQuestions = []; // Will be populated from online API

        const questionBank = {
            toan: [...genMath(40), ...genExtraMath(30)],
            tiengviet: [...staticQ.tiengviet, ...extraTiengViet],
            tienganh: [...staticQ.tienganh, ...genTiengAnhFromBank(30)],
            tunhien: [...staticQ.tunhien, ...extraTuNhien],
            logic: [...staticQ.logic, ...extraLogic]
        };

        const flashcardData = {
            animals: [ {id:'c',e:'Cat',v:'MÃ¨o',i:'ğŸ±'}, {id:'d',e:'Dog',v:'ChÃ³',i:'ğŸ¶'}, {id:'l',e:'Lion',v:'SÆ° tá»­',i:'ğŸ¦'}, {id:'p',e:'Pig',v:'Heo',i:'ğŸ·'}, {id:'b',e:'Bird',v:'Chim',i:'ğŸ¦'}, {id:'f',e:'Fish',v:'CÃ¡',i:'ğŸŸ'}, {id:'m',e:'Monkey',v:'Khá»‰',i:'ğŸµ'}, {id:'ti',e:'Tiger',v:'Há»•',i:'ğŸ¯'}, {id:'pa',e:'Panda',v:'Gáº¥u trÃºc',i:'ğŸ¼'}, {id:'ch',e:'Chicken',v:'GÃ ',i:'ğŸ”'} ],
            transport: [ {id:'ca',e:'Car',v:'Ã” tÃ´',i:'ğŸš—'}, {id:'bu',e:'Bus',v:'BuÃ½t',i:'ğŸšŒ'}, {id:'bi',e:'Bike',v:'Xe Ä‘áº¡p',i:'ğŸš²'}, {id:'pl',e:'Plane',v:'MÃ¡y bay',i:'âœˆï¸'}, {id:'tr',e:'Train',v:'TÃ u há»a',i:'ğŸš‚'}, {id:'sh',e:'Ship',v:'TÃ u thá»§y',i:'ğŸš¢'}, {id:'mo',e:'Moto',v:'Xe mÃ¡y',i:'ğŸ›µ'}, {id:'tru',e:'Truck',v:'Xe táº£i',i:'ğŸšš'}, {id:'amb',e:'Ambulance',v:'Cá»©u thÆ°Æ¡ng',i:'ğŸš‘'}, {id:'roc',e:'Rocket',v:'TÃªn lá»­a',i:'ğŸš€'} ],
            mix: [ {id:'su',e:'Sun',v:'Máº·t trá»i',i:'â˜€ï¸'}, {id:'moo',e:'Moon',v:'Máº·t trÄƒng',i:'ğŸŒ™'}, {id:'fl',e:'Flower',v:'Hoa',i:'ğŸŒ¸'}, {id:'tr',e:'Tree',v:'CÃ¢y',i:'ğŸŒ³'}, {id:'ap',e:'Apple',v:'TÃ¡o',i:'ğŸ'}, {id:'ba',e:'Ball',v:'BÃ³ng',i:'âš½'}, {id:'bo',e:'Book',v:'SÃ¡ch',i:'ğŸ“–'}, {id:'pe',e:'Pen',v:'BÃºt',i:'ğŸ–Šï¸'}, {id:'ho',e:'Home',v:'NhÃ ',i:'ğŸ '}, {id:'st',e:'Star',v:'Sao',i:'â­'} ]
        };

        const topics = { 'toan':'ToÃ¡n Há»c', 'tiengviet':'Tiáº¿ng Viá»‡t', 'tienganh':'Tiáº¿ng Anh', 'tunhien':'Tháº¿ Giá»›i', 'logic':'TÆ° Duy', 'tonghop':'Tá»•ng Há»£p', 'memory':'TrÃ­ Nhá»›' };
        const avatars = ['ğŸ±','ğŸ¦','ğŸ°','ğŸ¼','ğŸ¦„','ğŸ¤–','ğŸ¦–','ğŸ','ğŸ¦Š','ğŸ¸'];

        let users = JSON.parse(localStorage.getItem('rcv_users_v2')) || [];
        if(users.length===0){ users=[{id:Date.now(),name:"Kem",avatar:"ğŸ±"}]; localStorage.setItem('rcv_users_v2',JSON.stringify(users)); }
        let history = JSON.parse(localStorage.getItem('rcv_history_v2')) || [];

        let currentUser=null, selectedAvatar=avatars[0], editUserId=null, performanceChart=null, activeExitScreen=null;
        let quizState={topic:'',questions:[],currentIndex:0,score:0,timer:null,timeLeft:15,maxQuestions:15};
        let memoryState={cards:[],flipped:[],matched:[],moves:0,canFlip:true,level:'', timer: null, timeLeft: 30, totalTime: 30};

        const screens = { user:document.getElementById('screen-user'), topic:document.getElementById('screen-topic'), game:document.getElementById('screen-game'), memory:document.getElementById('screen-memory'), result:document.getElementById('screen-result'), dashboard:document.getElementById('screen-dashboard') };

        // --- INIT & USER ---
        function init(){ renderAvatarSelector(); renderUserList(); }
        function switchScreen(n){ sfx.click(); Object.values(screens).forEach(el=>el.classList.add('hidden')); screens[n].classList.remove('hidden'); }
        function renderAvatarSelector(){ const c=document.getElementById('avatar-selector'); c.innerHTML=''; avatars.forEach(av=>{ const d=document.createElement('div'); d.className=`avatar-option text-4xl p-2 select-none ${av===selectedAvatar?'avatar-selected':''}`; d.innerText=av; d.onclick=()=>{sfx.click();selectedAvatar=av;renderAvatarSelector();}; c.appendChild(d); }); }
        function renderUserList(){ const l=document.getElementById('user-list'); l.innerHTML=''; users.forEach(u=>{ l.innerHTML+=`<div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center justify-between shadow-sm active:border-blue-300 transition"><div class="flex items-center gap-3 cursor-pointer flex-grow w-full" onclick="login(${u.id})"><span class="text-3xl">${u.avatar}</span><span class="font-bold text-gray-700 text-lg">${u.name}</span></div><button onclick="startEditUser(${u.id},event)" class="text-gray-300 hover:text-blue-500 p-2"><i class="fa-solid fa-pen-to-square"></i></button></div>`; }); }
        function handleUserAction(){ const n=document.getElementById('new-username').value.trim(); if(!n) return alert("BÃ© chÆ°a nháº­p tÃªn!"); if(editUserId){ const i=users.findIndex(u=>u.id===editUserId); if(i!==-1){users[i].name=n;users[i].avatar=selectedAvatar;saveUsers();cancelEdit();} } else { const u={id:Date.now(),name:n,avatar:selectedAvatar}; users.push(u); saveUsers(); login(u.id); } document.getElementById('new-username').value=''; }
        function startEditUser(uid,e){ e.stopPropagation(); sfx.click(); const u=users.find(x=>x.id===uid); if(!u)return; editUserId=uid; document.getElementById('new-username').value=u.name; selectedAvatar=u.avatar; renderAvatarSelector(); const b=document.getElementById('btn-create-user'); b.innerHTML='<i class="fa-solid fa-check"></i> LÆ°u'; b.className='btn-3d w-full bg-orange-500 border-orange-700 text-white font-bold py-3 rounded-xl text-lg shadow-lg'; document.getElementById('btn-cancel-edit').classList.remove('hidden'); }
        function cancelEdit(){ editUserId=null; document.getElementById('new-username').value=''; const b=document.getElementById('btn-create-user'); b.innerHTML='<i class="fa-solid fa-play mr-2"></i> Báº¯t Ä‘áº§u ngay'; b.className='btn-3d w-full bg-green-500 border-green-700 text-white font-bold py-3 rounded-xl text-lg shadow-lg'; document.getElementById('btn-cancel-edit').classList.add('hidden'); selectedAvatar=avatars[0]; renderAvatarSelector(); }
        function saveUsers(){ localStorage.setItem('rcv_users_v2',JSON.stringify(users)); renderUserList(); }
        function login(uid){ currentUser=users.find(u=>u.id===uid); if(currentUser){ document.getElementById('display-avatar').innerText=currentUser.avatar; document.getElementById('display-username').innerText=currentUser.name; switchScreen('topic'); } }
        function logout(){ currentUser=null; cancelEdit(); switchScreen('user'); }

        // --- QUIZ LOGIC ---
        function startGame(tk){
            // Regenerate dynamic questions each game for variety
            questionBank.toan = [...genMath(40), ...genExtraMath(30)];
            questionBank.tienganh = [...staticQ.tienganh, ...genTiengAnhFromBank(30), ...onlineQuestions];
            let qs = (tk==='tonghop') ? Object.values(questionBank).flat() : [...questionBank[tk]];
            qs = qs.sort(()=>0.5-Math.random()).slice(0,15);
            // Fisher-Yates shuffle answer positions so correct answer is random
            qs.forEach(q => {
                const correctAns = q.a[q.c];
                for(let i = q.a.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [q.a[i], q.a[j]] = [q.a[j], q.a[i]];
                }
                q.c = q.a.indexOf(correctAns);
            });
            quizState={topic:tk,questions:qs,currentIndex:0,score:0,timer:null,timeLeft:15,maxQuestions:qs.length};
            document.getElementById('game-topic-name').innerText=topics[tk]; document.getElementById('score').innerText='0';
            switchScreen('game'); loadQuestion();
        }
        function loadQuestion(){
            if(quizState.currentIndex>=quizState.questions.length){ endQuizGame(); return; }
            const q=quizState.questions[quizState.currentIndex];
            document.getElementById('question-counter').innerText=`${quizState.currentIndex+1}/${quizState.maxQuestions}`;
            document.getElementById('question-text').innerText=q.q;
            const img=document.getElementById('question-image'); if(q.icon){img.innerText=q.icon;img.classList.remove('hidden');}else img.classList.add('hidden');
            const ac=document.getElementById('answers-container'); ac.innerHTML='';
            q.a.forEach((ans,i)=>{ const b=document.createElement('button'); b.className='btn-3d w-full bg-white text-blue-600 font-bold py-3 rounded-xl border-2 border-blue-200 hover:bg-blue-50 text-xl shadow-sm transition active:bg-blue-100'; b.innerText=ans; b.onclick=()=>checkAnswer(i,b,q.c); ac.appendChild(b); });
            quizState.timeLeft=15; updateTimerBar();
            if(quizState.timer) clearInterval(quizState.timer);
            quizState.timer=setInterval(()=>{ quizState.timeLeft--; updateTimerBar(); if(quizState.timeLeft<=0) handleTimeOut(); },1000);
        }
        function updateTimerBar(){ const b=document.getElementById('timer-bar'); b.style.width=`${(quizState.timeLeft/15)*100}%`; b.style.backgroundColor=quizState.timeLeft<5?'#ef4444':'#22c55e'; }
        function handleTimeOut(){ clearInterval(quizState.timer); sfx.wrong(); disableInputs(); setTimeout(()=>{quizState.currentIndex++; loadQuestion();},1500); }
        function checkAnswer(si,el,ci){ clearInterval(quizState.timer); disableInputs(); if(si===ci){ sfx.correct(); el.classList.add('correct-anim'); quizState.score+=10; document.getElementById('score').innerText=quizState.score; } else { sfx.wrong(); el.classList.add('wrong-anim'); document.getElementById('answers-container').children[ci].classList.add('correct-anim','opacity-80'); } setTimeout(()=>{quizState.currentIndex++; loadQuestion();},1500); }
        function disableInputs(){ Array.from(document.getElementById('answers-container').children).forEach(b=>b.disabled=true); }
        function endQuizGame(){ saveHistory(quizState.score, topics[quizState.topic], quizState.topic); showResult(quizState.score, quizState.maxQuestions*10); }

        // --- MEMORY LOGIC ---
        function showMemoryDifficultyModal(){ sfx.click(); document.getElementById('modal-memory-level').classList.remove('hidden'); }
        function startMemoryGame(level){
            document.getElementById('modal-memory-level').classList.add('hidden');
            let pairCount = 3; let gridClass = 'grid-cols-3'; let source = 'mix'; let time = 30;
            if(level==='easy') { pairCount=3; gridClass='grid-cols-3'; source=['animals','transport','mix'][Math.floor(Math.random()*3)]; time=30; }
            if(level==='medium') { pairCount=6; gridClass='grid-cols-3'; source='mix'; time=60; }
            if(level==='hard') { pairCount=10; gridClass='grid-cols-4'; source='mix'; time=120; }

            // Get data
            let pool = [];
            if(source==='mix') pool=[...flashcardData.animals, ...flashcardData.transport, ...flashcardData.mix];
            else pool = flashcardData[source];

            pool = pool.sort(()=>0.5-Math.random()).slice(0, pairCount);
            let cards = [];
            pool.forEach(x => { cards.push({...x}); cards.push({...x}); });
            cards = cards.sort(()=>0.5-Math.random());

            memoryState = { cards: cards, flipped: [], matched: [], moves: 0, canFlip: true, level: level, timeLeft: time, totalTime: time, timer: null };
            document.getElementById('memory-level-display').innerText = `Äá»˜ KHÃ“: ${level==='easy'?'Dá»„':(level==='medium'?'Vá»ªA':'KHÃ“')}`;
            document.getElementById('memory-moves').innerText = '0';

            const grid = document.getElementById('memory-grid');
            grid.className = `grid gap-2 flex-grow content-center justify-center ${gridClass}`;
            grid.innerHTML = '';

            cards.forEach((c,i) => {
                const el = document.createElement('div');
                el.className = `perspective w-full h-24 cursor-pointer card`;
                el.dataset.index = i; el.onclick = () => flipCard(i);
                el.innerHTML = `<div class="card-inner w-full h-full relative text-center"><div class="card-face card-front"></div><div class="card-face card-back bg-white border-2 border-blue-200"><div class="text-3xl mb-1">${c.i}</div><div class="text-[10px] font-bold text-blue-600 uppercase leading-none">${c.e}</div><div class="text-[9px] text-gray-400 leading-none mt-0.5">${c.v}</div></div></div>`;
                grid.appendChild(el);
            });
            switchScreen('memory');

            // Start Timer
            updateMemoryTimerBar();
            if(memoryState.timer) clearInterval(memoryState.timer);
            memoryState.timer = setInterval(()=>{
                memoryState.timeLeft--;
                updateMemoryTimerBar();
                if(memoryState.timeLeft <= 0) handleMemoryTimeOut();
            }, 1000);
        }

        function updateMemoryTimerBar() {
            const bar = document.getElementById('memory-timer-bar');
            const pct = (memoryState.timeLeft / memoryState.totalTime) * 100;
            bar.style.width = `${pct}%`;
            bar.style.backgroundColor = memoryState.timeLeft < 10 ? '#ef4444' : '#14b8a6'; // red : teal
        }

        function handleMemoryTimeOut() {
            clearInterval(memoryState.timer);
            sfx.wrong();
            // Show game over result
            showResult(0, 100, true, true); // true, true = isMemory, isTimeOut
        }

        function flipCard(i){
            if(!memoryState.canFlip || memoryState.flipped.includes(i) || memoryState.matched.includes(i) || memoryState.timeLeft <= 0) return;
            sfx.flip(); memoryState.flipped.push(i);
            document.querySelector(`.card[data-index="${i}"]`).classList.add('flipped');
            if(memoryState.flipped.length===2){
                memoryState.moves++; document.getElementById('memory-moves').innerText=memoryState.moves;
                checkMatch();
            }
        }
        function checkMatch(){
            memoryState.canFlip=false;
            const [i1, i2] = memoryState.flipped;
            if(memoryState.cards[i1].id === memoryState.cards[i2].id){
                sfx.match(); memoryState.matched.push(i1,i2); memoryState.flipped=[]; memoryState.canFlip=true;
                if(memoryState.matched.length===memoryState.cards.length) {
                    clearInterval(memoryState.timer); // Stop timer on win
                    setTimeout(endMemoryGame,800);
                }
            } else {
                setTimeout(()=>{
                    document.querySelector(`.card[data-index="${i1}"]`).classList.remove('flipped');
                    document.querySelector(`.card[data-index="${i2}"]`).classList.remove('flipped');
                    memoryState.flipped=[]; memoryState.canFlip=true;
                },1000);
            }
        }
        function endMemoryGame(){
            // Score based on level + bonus time
            let baseScore = memoryState.level==='easy'?50 : (memoryState.level==='medium'?100 : 150);
            // Bonus points for time left (1pt per second)
            let score = baseScore + memoryState.timeLeft;

            let displayLevel = memoryState.level==='easy'?' (Dá»…)':(memoryState.level==='medium'?' (Vá»«a)':' (KhÃ³)');
            saveHistory(score, "TrÃ­ Nhá»›"+displayLevel, "memory");
            showResult(score, score, true);
        }

        // --- COMMON ---
        function saveHistory(score, tName, tKey){
            const r = { userId:currentUser.id, date:new Date().toLocaleDateString('vi-VN'), topicKey:tKey, topicName:tName, score:score };
            history.unshift(r); localStorage.setItem('rcv_history_v2',JSON.stringify(history));
        }
        function showResult(score, max, isMem=false, isTimeOut=false){
            const t=document.getElementById('result-title'), i=document.getElementById('result-icon'), f=document.getElementById('result-feedback');
            document.getElementById('final-score').innerText=score;

            if(isTimeOut) {
                t.innerText = "Háº¿t giá» rá»“i!"; t.className="text-3xl font-bold text-gray-500 mb-2";
                i.innerText = "â°";
                f.innerText = "Tiáº¿c quÃ¡, láº§n sau nhanh tay hÆ¡n nhÃ©!";
            } else if(isMem){
                sfx.win();
                t.innerText="TrÃ­ nhá»› siÃªu phÃ m!"; t.className="text-3xl font-bold text-teal-500 mb-2";
                i.innerText="ğŸ§ âœ¨";
                f.innerText=`HoÃ n thÃ nh! CÃ²n dÆ° ${memoryState.timeLeft} giÃ¢y!`;
                confetti({particleCount:150,spread:70,origin:{y:0.6}});
            } else {
                sfx.win();
                const r=score/max;
                if(r>=0.8){ t.innerText="Xuáº¥t sáº¯c!"; t.className="text-3xl font-bold text-yellow-500 mb-2"; i.innerText="ğŸ†ğŸ””"; f.innerText="Con lÃ  thiÃªn tÃ i!"; confetti({particleCount:150,spread:70,origin:{y:0.6}}); }
                else if(r>=0.5){ t.innerText="LÃ m tá»‘t láº¯m!"; t.className="text-3xl font-bold text-blue-500 mb-2"; i.innerText="ğŸˆ"; f.innerText="Cá»‘ lÃªn háº¡ng nháº¥t nha!"; }
                else { t.innerText="Cá»‘ lÃªn nhÃ©!"; t.className="text-3xl font-bold text-gray-500 mb-2"; i.innerText="ğŸ’ª"; f.innerText="Luyá»‡n thÃªm xÃ­u ná»¯a!"; }
            }
            switchScreen('result');
        }

        // --- DASHBOARD ---
        function showExitModal(s='game'){ sfx.click(); activeExitScreen=s; document.getElementById('modal-exit').classList.remove('hidden'); }
        function closeExitModal(){ sfx.click(); document.getElementById('modal-exit').classList.add('hidden'); }
        function realExitGame(){
            sfx.click();
            document.getElementById('modal-exit').classList.add('hidden');
            if(activeExitScreen==='game') clearInterval(quizState.timer);
            if(activeExitScreen==='memory') clearInterval(memoryState.timer);
            switchScreen('topic');
        }
        function backToTopics(){ switchScreen('topic'); }
        function showDashboard(){ switchScreen('dashboard'); switchTab('chart'); }
        function switchTab(t){
            ['chart','rank','history'].forEach(x=>document.getElementById(`content-${x}`).classList.add('hidden')); document.getElementById(`content-${t}`).classList.remove('hidden');
            ['tab-chart','tab-rank','tab-history'].forEach(x=>document.getElementById(x).className="flex-1 py-2 rounded-lg text-xs font-bold transition text-gray-400 bg-gray-100");
            document.getElementById(`tab-${t}`).className="flex-1 py-2 rounded-lg text-xs font-bold transition bg-white shadow text-blue-600";
            if(t==='chart') setTimeout(renderChart,50); if(t==='rank') renderRank('tonghop'); if(t==='history') renderHistory();
        }
        function renderChart(){
            document.getElementById('chart-username').innerText=currentUser.name;
            const ctx=document.getElementById('performanceChart').getContext('2d');
            const keys=['toan','tiengviet','tienganh','tunhien','logic','memory'];
            const labels=['ToÃ¡n','T.Viá»‡t','T.Anh','T.Giá»›i','Logic','TrÃ­ Nhá»›'];
            const data=keys.map(k=>{
                const rs=history.filter(h=>h.userId===currentUser.id && h.topicKey===k);
                if(!rs.length) return 0;
                if(k==='memory') {
                    // Normalize memory scores to roughly 0-100 range for visualization
                    let total=0; rs.forEach(r=>{
                        let max=100; // Base baseline
                        if(r.topicName.includes('Dá»…')) max=50; if(r.topicName.includes('KhÃ³')) max=150;
                        let normalized = (r.score / max) * 100;
                        if(normalized > 100) normalized = 100; // Cap at 100 for graph beauty
                        total += normalized;
                    });
                    return Math.round(total/rs.length);
                }
                return Math.round(rs.reduce((a,b)=>a+b.score,0)/rs.length);
            });
            if(performanceChart) performanceChart.destroy();
            performanceChart=new Chart(ctx,{type:'radar',data:{labels:labels,datasets:[{label:'Äiá»ƒm TB',data:data,backgroundColor:'rgba(59,130,246,0.2)',borderColor:'rgba(59,130,246,1)',pointBackgroundColor:'#FBBF24',borderWidth:2}]},options:{scales:{r:{angleLines:{display:false},suggestedMin:0,suggestedMax:100,pointLabels:{font:{size:11,family:'Baloo 2'}},ticks:{display:false}}},plugins:{legend:{display:false}},maintainAspectRatio:false}});
        }
        function renderRank(k){
            const c=document.getElementById('rank-filters'); c.innerHTML='';
            ['tonghop',...Object.keys(topics)].forEach(key=>{
                const b=document.createElement('button'); b.className=`whitespace-nowrap px-3 py-1 rounded-full text-[10px] font-bold border ${key===k?'bg-blue-500 text-white border-blue-600 shadow-md':'bg-white text-gray-500 border-gray-200'}`;
                b.innerText=topics[key]||"Tá»•ng Há»£p"; b.onclick=()=>renderRank(key); c.appendChild(b);
            });
            const ums=[]; users.forEach(u=>{ const rs=history.filter(h=>h.userId===u.id&&(k==='tonghop'||h.topicKey===k)); if(rs.length) ums.push({u,s:Math.max(...rs.map(r=>r.score))}); });
            ums.sort((a,b)=>b.s-a.s);
            const l=document.getElementById('rank-list'); l.innerHTML=ums.length?'': '<tr><td colspan="3" class="p-4 text-center text-gray-400">ChÆ°a cÃ³ dá»¯ liá»‡u</td></tr>';
            ums.forEach((x,i)=>{ l.innerHTML+=`<tr class="${i<3?'bg-yellow-50':''}"><td class="p-3 align-middle">${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1}</td><td class="p-3 flex items-center gap-2"><span class="text-xl">${x.u.avatar}</span> <span>${x.u.name}</span></td><td class="p-3 text-right text-blue-600">${x.s}</td></tr>`; });
        }
        function renderHistory(){
            const h=history.filter(x=>x.userId===currentUser.id);
            const l=document.getElementById('history-list'); const e=document.getElementById('empty-history');
            if(!h.length){l.innerHTML=`<tr><td class="text-center p-4 text-gray-400"><i class="fa-solid fa-ghost text-2xl mb-1 block"></i>ChÆ°a cÃ³ lá»‹ch sá»­</td></tr>`;}
            else { l.innerHTML=h.map(x=>`<tr class="border-b border-gray-100"><td class="py-3 px-1"><div class="text-[10px] text-gray-400 font-bold">${x.date}</div><div class="font-bold text-blue-600 text-xs">${x.topicName}</div></td><td class="py-3 px-1 text-right"><span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-xs font-bold">${x.score}Ä‘</span></td></tr>`).join(''); }
        }

        // === ONLINE QUESTION FETCH (opentdb.com) ===
        async function fetchOnlineQuestions() {
            try {
                const resp = await fetch('https://opentdb.com/api.php?amount=30&difficulty=easy&type=multiple');
                const data = await resp.json();
                if(data.response_code === 0) {
                    const decode = s => { const t = document.createElement('textarea'); t.innerHTML = s; return t.value; };
                    onlineQuestions = data.results.map(r => ({
                        q: decode(r.question),
                        a: [decode(r.correct_answer), ...r.incorrect_answers.map(decode)],
                        c: 0,
                        icon: 'ğŸŒ'
                    }));
                    questionBank.tienganh.push(...onlineQuestions);
                    console.log('âœ… Loaded', onlineQuestions.length, 'online questions from opentdb');
                }
            } catch(e) {
                console.log('âš ï¸ Offline mode - using local questions only');
            }
        }

        init();
        fetchOnlineQuestions(); // Async enrichment - adds questions when ready
    </script>
</body>
</html>

