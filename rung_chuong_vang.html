<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rung Chu√¥ng V√†ng Kids Pro V7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Baloo 2', cursive;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 20px 20px;
            overscroll-behavior: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.96);
            border-radius: 24px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
            border: 4px solid #fff;
        }
        .btn-3d { transition: all 0.1s; border-bottom-width: 5px; position: relative; }
        .btn-3d:active { transform: translateY(4px); border-bottom-width: 1px; }
        
        .avatar-option { transition: transform 0.2s; }
        .avatar-option:hover { transform: scale(1.15); }
        .avatar-selected { border: 4px solid #FBBF24; border-radius: 50%; background-color: #FFFBEB; transform: scale(1.2); }
        @keyframes ring { 0%,100%{transform:rotate(0)} 10%,30%,50%,70%,90%{transform:rotate(15deg)} 20%,40%,60%,80%{transform:rotate(-15deg)} }
        .bell-ringing { animation: ring 2s ease infinite; }
        .correct-anim { background-color: #86efac !important; border-color: #22c55e !important; transform: scale(1.02); }
        .wrong-anim { background-color: #fca5a5 !important; border-color: #ef4444 !important; animation: shake 0.5s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-10px)} 75%{transform:translateX(10px)} }
        
        .perspective { perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 12px; border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-front { background: linear-gradient(135deg, #60a5fa, #3b82f6); }
        .card-back { background-color: white; transform: rotateY(180deg); flex-direction: column; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-3 selection:bg-yellow-200 overflow-hidden">

    <div class="fixed top-2 z-10 pointer-events-none">
        <div class="bg-white px-5 py-1.5 rounded-full shadow-xl border-b-4 border-yellow-400 flex items-center gap-3">
            <i class="fa-solid fa-bell text-yellow-500 text-2xl bell-ringing"></i>
            <h1 class="text-xl font-bold text-yellow-600 tracking-wider">RUNG CHU√îNG V√ÄNG</h1>
        </div>
    </div>

    <div id="app" class="w-full max-w-lg relative z-0 mt-12 h-full max-h-[850px] flex flex-col pb-safe">
        
        <!-- 1. LOGIN -->
        <div id="screen-user" class="glass-panel p-5 flex flex-col h-full overflow-hidden">
            <h2 class="text-xl font-bold text-blue-600 text-center mb-2">Ai ƒëang ch∆°i ƒë·∫•y nh·ªâ?</h2>
            <div id="user-list" class="flex-grow overflow-y-auto space-y-3 p-1 mb-2"></div>
            <div class="flex-shrink-0 pt-2 border-t border-dashed border-gray-300">
                <h3 class="text-sm font-bold text-gray-400 mb-2 text-center uppercase">T·∫°o ng∆∞·ªùi ch∆°i m·ªõi</h3>
                <div class="flex justify-center gap-4 mb-3 overflow-x-auto pb-2 px-1" id="avatar-selector"></div>
                <div class="flex flex-col gap-3">
                    <input type="text" id="new-username" placeholder="Nh·∫≠p t√™n b√©..." class="w-full p-3 rounded-xl border-2 border-blue-200 font-bold text-blue-800 text-center text-lg focus:outline-none focus:border-blue-500">
                    <button onclick="handleUserAction()" id="btn-create-user" class="btn-3d w-full bg-green-500 border-green-700 text-white font-bold py-3 rounded-xl text-lg shadow-lg">
                        <i class="fa-solid fa-play mr-2"></i> B·∫Øt ƒë·∫ßu ngay
                    </button>
                    <button onclick="cancelEdit()" id="btn-cancel-edit" class="hidden text-gray-400 font-bold text-sm">H·ªßy b·ªè</button>
                </div>
            </div>
        </div>

        <!-- 2. MENU -->
        <div id="screen-topic" class="glass-panel p-5 hidden flex flex-col gap-3 h-full">
            <div class="flex justify-between items-center bg-blue-50 p-3 rounded-2xl border-2 border-blue-100">
                <div class="flex items-center gap-3">
                    <div id="display-avatar" class="text-4xl bg-white p-1 rounded-full shadow-sm"></div>
                    <div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Xin ch√†o,</p>
                        <p id="display-username" class="text-xl font-black text-blue-600 leading-none truncate max-w-[140px]"></p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="showDashboard()" class="bg-yellow-400 text-white w-10 h-10 rounded-full shadow-md flex items-center justify-center border-b-4 border-yellow-600 active:border-b-0 active:translate-y-1"><i class="fa-solid fa-chart-pie"></i></button>
                    <button onclick="logout()" class="bg-gray-200 text-gray-500 w-10 h-10 rounded-full shadow-md flex items-center justify-center border-b-4 border-gray-400 active:border-b-0 active:translate-y-1"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
            <div class="flex-grow flex flex-col gap-2 overflow-hidden">
                <div onclick="showMemoryDifficultyModal()" class="cursor-pointer bg-gradient-to-r from-teal-400 to-emerald-500 p-3 rounded-2xl shadow-lg border-b-4 border-teal-700 active:border-b-0 active:translate-y-1 flex items-center gap-3 text-white shrink-0 mt-1">
                    <div class="bg-white/20 p-2 rounded-full h-14 w-14 flex items-center justify-center text-3xl">üß†</div>
                    <div class="flex-grow"><h3 class="text-lg font-black uppercase">Si√™u Tr√≠ Nh·ªõ</h3><p class="text-xs opacity-90">Luy·ªán n√£o & T·ª´ v·ª±ng</p></div>
                    <i class="fa-solid fa-play text-xl opacity-50 mr-2"></i>
                </div>
                <div class="relative py-2"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div><div class="relative flex justify-center"><span class="bg-white px-2 text-xs font-bold text-gray-400 uppercase">Ho·∫∑c thi ƒë·∫•u Quiz</span></div></div>
                <div class="grid grid-cols-2 gap-3 overflow-y-auto pb-2">
                    <button onclick="startGame('toan')" class="btn-3d bg-blue-500 border-blue-700 text-white p-3 rounded-2xl flex flex-col items-center justify-center h-20"><i class="fa-solid fa-calculator text-2xl"></i><span class="font-bold text-sm">To√°n H·ªçc</span></button>
                    <button onclick="startGame('tiengviet')" class="btn-3d bg-red-500 border-red-700 text-white p-3 rounded-2xl flex flex-col items-center justify-center h-20"><i class="fa-solid fa-book text-2xl"></i><span class="font-bold text-sm">Ti·∫øng Vi·ªát</span></button>
                    <button onclick="startGame('tienganh')" class="btn-3d bg-purple-500 border-purple-700 text-white p-3 rounded-2xl flex flex-col items-center justify-center h-20"><i class="fa-solid fa-language text-2xl"></i><span class="font-bold text-sm">Ti·∫øng Anh</span></button>
                    <button onclick="startGame('tunhien')" class="btn-3d bg-green-500 border-green-700 text-white p-3 rounded-2xl flex flex-col items-center justify-center h-20"><i class="fa-solid fa-leaf text-2xl"></i><span class="font-bold text-sm">Th·∫ø Gi·ªõi</span></button>
                    <button onclick="startGame('logic')" class="btn-3d bg-orange-500 border-orange-700 text-white p-3 rounded-2xl flex flex-col items-center justify-center h-20"><i class="fa-solid fa-puzzle-piece text-2xl"></i><span class="font-bold text-sm">T∆∞ Duy</span></button>
                    <button onclick="startGame('tonghop')" class="btn-3d bg-indigo-500 border-indigo-700 text-white p-3 rounded-2xl flex flex-col items-center justify-center h-20"><i class="fa-solid fa-star text-2xl"></i><span class="font-bold text-sm">T·ªïng H·ª£p</span></button>
                </div>
            </div>
        </div>

        <!-- 3. QUIZ SCREEN -->
        <div id="screen-game" class="glass-panel p-4 hidden flex flex-col h-full relative">
            <div class="flex justify-between items-center mb-2 gap-2">
                <button onclick="showExitModal()" class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-100 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-lg"></i></button>
                <div class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold text-xs border border-blue-200">
                    <span id="game-topic-name">To√°n</span> <span class="mx-1 text-blue-300">|</span> <span id="question-counter">1/15</span>
                </div>
                <div class="text-2xl font-black text-yellow-500 flex items-center gap-1"><span id="score">0</span><i class="fa-solid fa-star"></i></div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 mb-4 overflow-hidden"><div id="timer-bar" class="bg-green-500 h-3 rounded-full transition-all duration-1000 ease-linear w-full"></div></div>
            <div class="flex-grow flex flex-col justify-center items-center text-center mb-4 relative px-1">
                 <div id="question-image" class="text-6xl mb-4 animate-bounce hidden"></div>
                 <h2 id="question-text" class="text-2xl font-bold text-gray-800 leading-snug">C√¢u h·ªèi?</h2>
            </div>
            <div id="answers-container" class="grid grid-cols-1 gap-2 pb-1"></div>
        </div>

        <!-- 4. MEMORY SCREEN (Added Timer) -->
        <div id="screen-memory" class="glass-panel p-4 hidden flex flex-col h-full relative">
            <div class="flex justify-between items-center mb-1">
                <button onclick="showExitModal('memory')" class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-100 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                <div class="text-center">
                    <div class="text-xs font-bold text-gray-400 uppercase" id="memory-level-display">ƒê·ªò KH√ì</div>
                    <div class="text-lg font-black text-teal-600">Si√™u Tr√≠ Nh·ªõ</div>
                </div>
                <div class="w-9 h-9 flex items-center justify-center rounded-full bg-yellow-100 text-yellow-600 font-bold text-sm"><span id="memory-moves">0</span></div>
            </div>
            
            <!-- Memory Timer Bar -->
            <div class="w-full bg-gray-200 rounded-full h-2 mb-3 overflow-hidden">
                <div id="memory-timer-bar" class="bg-teal-500 h-2 rounded-full transition-all duration-1000 ease-linear w-full"></div>
            </div>

            <div id="memory-grid" class="grid gap-2 flex-grow content-center justify-center"></div>
        </div>

        <!-- 5. RESULT SCREEN -->
        <div id="screen-result" class="glass-panel p-6 hidden flex flex-col items-center justify-center h-full text-center">
            <div id="result-icon" class="text-8xl mb-4 animate-bounce">üéâ</div>
            <h2 id="result-title" class="text-3xl font-bold text-yellow-500 mb-2">Tuy·ªát v·ªùi!</h2>
            <div class="bg-yellow-50 w-full rounded-2xl p-6 border-2 border-yellow-200 mb-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">üèÜ</div>
                <p class="text-xs text-gray-500 font-bold uppercase tracking-widest">T·ªïng ƒëi·ªÉm</p>
                <div class="text-6xl font-black text-blue-600 mt-2" id="final-score">100</div>
                <div class="text-sm text-gray-500 mt-2 font-bold italic" id="result-feedback"></div>
            </div>
            <div class="flex flex-col gap-3 w-full">
                <button onclick="backToTopics()" class="btn-3d bg-blue-500 border-blue-700 text-white font-bold py-3 rounded-xl text-lg"><i class="fa-solid fa-rotate-right mr-2"></i> Ch∆°i l·∫°i</button>
                <button onclick="showDashboard()" class="btn-3d bg-pink-500 border-pink-700 text-white font-bold py-3 rounded-xl text-lg"><i class="fa-solid fa-trophy mr-2"></i> X·∫øp h·∫°ng</button>
            </div>
        </div>

        <!-- 6. DASHBOARD -->
        <div id="screen-dashboard" class="glass-panel p-4 hidden h-full flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-700"><i class="fa-solid fa-chart-line text-blue-500"></i> B·∫£ng Th√†nh T√≠ch</h2>
                <button onclick="backToTopics()" class="text-gray-500 bg-gray-100 rounded-full w-9 h-9 flex items-center justify-center"><i class="fa-solid fa-arrow-left"></i></button>
            </div>
            <div class="flex bg-gray-100 rounded-xl p-1 mb-4 shadow-inner">
                <button onclick="switchTab('chart')" id="tab-chart" class="flex-1 py-2 rounded-lg text-xs font-bold transition">Bi·ªÉu ƒë·ªì</button>
                <button onclick="switchTab('rank')" id="tab-rank" class="flex-1 py-2 rounded-lg text-xs font-bold transition">X·∫øp h·∫°ng</button>
                <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-2 rounded-lg text-xs font-bold transition">L·ªãch s·ª≠</button>
            </div>
            <div class="flex-grow overflow-y-auto relative px-1">
                <div id="content-chart" class="h-full flex flex-col items-center justify-center">
                    <p class="text-center text-gray-500 text-sm mb-2">NƒÉng l·ª±c c·ªßa <span id="chart-username" class="font-bold text-blue-600"></span></p>
                    <div class="w-full h-72 relative"><canvas id="performanceChart"></canvas></div>
                </div>
                <div id="content-rank" class="hidden h-full">
                    <div class="flex gap-2 mb-3 overflow-x-auto pb-2 scrollbar-hide" id="rank-filters"></div>
                    <table class="w-full text-left bg-white rounded-xl shadow-sm border border-gray-100"><tbody id="rank-list" class="text-gray-700 text-sm font-bold divide-y"></tbody></table>
                </div>
                <div id="content-history" class="hidden"><table class="w-full text-left border-collapse"><tbody id="history-list" class="text-gray-700 text-sm"></tbody></table></div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-exit" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 text-center max-w-sm w-full shadow-2xl border-4 border-yellow-400">
            <i class="fa-solid fa-face-sad-tear text-5xl text-yellow-500 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-700 mb-2">Con mu·ªën d·ª´ng ch∆°i h·∫£?</h3>
            <div class="flex gap-3 justify-center mt-6">
                 <button onclick="closeExitModal()" class="flex-1 py-3 rounded-xl bg-gray-200 text-gray-700 font-bold">Kh√¥ng nha</button>
                 <button onclick="realExitGame()" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold border-b-4 border-red-700 active:border-b-0 active:translate-y-1">D·ª´ng l·∫°i</button>
            </div>
        </div>
    </div>

    <div id="modal-memory-level" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 text-center max-w-sm w-full shadow-2xl border-4 border-teal-500">
            <h3 class="text-2xl font-black text-teal-600 mb-4 uppercase">Ch·ªçn ƒë·ªô kh√≥</h3>
            <div class="flex flex-col gap-3">
                <button onclick="startMemoryGame('easy')" class="btn-3d w-full bg-green-500 text-white py-4 rounded-2xl font-bold text-lg border-green-700 flex justify-between px-6">
                    <span>üê£ D·ªÖ</span> <span class="text-green-100 text-sm mt-1">30 gi√¢y</span>
                </button>
                <button onclick="startMemoryGame('medium')" class="btn-3d w-full bg-blue-500 text-white py-4 rounded-2xl font-bold text-lg border-blue-700 flex justify-between px-6">
                    <span>üê∞ V·ª´a</span> <span class="text-blue-100 text-sm mt-1">60 gi√¢y</span>
                </button>
                <button onclick="startMemoryGame('hard')" class="btn-3d w-full bg-red-500 text-white py-4 rounded-2xl font-bold text-lg border-red-700 flex justify-between px-6">
                    <span>ü¶Å Kh√≥</span> <span class="text-red-100 text-sm mt-1">120 gi√¢y</span>
                </button>
            </div>
            <button onclick="document.getElementById('modal-memory-level').classList.add('hidden')" class="mt-4 text-gray-400 font-bold">Quay l·∫°i</button>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq,type,dur,vol=0.1) {
            if(audioCtx.state==='suspended') audioCtx.resume();
            const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
            osc.type=type; osc.frequency.setValueAtTime(freq,audioCtx.currentTime);
            g.gain.setValueAtTime(vol,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+dur);
            osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+dur);
        }
        const sfx = {
            click:()=>playTone(400,'triangle',0.05), correct:()=>{playTone(600,'sine',0.1);setTimeout(()=>playTone(1200,'sine',0.2),100)},
            wrong:()=>{playTone(200,'sawtooth',0.3);setTimeout(()=>playTone(150,'sawtooth',0.3),150)},
            flip:()=>playTone(300,'sine',0.05), match:()=>{playTone(800,'sine',0.1);setTimeout(()=>playTone(1500,'sine',0.2),150)},
            win:()=>{playTone(500,'square',0.1);setTimeout(()=>playTone(700,'square',0.1),100);setTimeout(()=>playTone(900,'square',0.4),200)}
        };

        const genMath = (count) => {
            const arr=[];
            for(let i=0;i<count;i++){
                const type = Math.random();
                if(type<0.3){ 
                    const a=Math.floor(Math.random()*10), b=Math.floor(Math.random()*10);
                    arr.push({q:`${a} + ${b} = ?`, a:[`${a+b}`,`${a+b+1}`,`${Math.abs(a+b-1)}`,`${a+b+2}`].sort(()=>0.5-Math.random()), c:0, correctVal:`${a+b}`, icon:'‚ûï'});
                } else if(type<0.6){
                    const a=Math.floor(Math.random()*10)+5, b=Math.floor(Math.random()*5);
                    arr.push({q:`${a} - ${b} = ?`, a:[`${a-b}`,`${a-b+1}`,`${a-b-1}`,`${a-b+2}`].sort(()=>0.5-Math.random()), c:0, correctVal:`${a-b}`, icon:'‚ûñ'});
                } else {
                    const a=Math.floor(Math.random()*20), b=Math.floor(Math.random()*20);
                    if(a==b){ i--; continue; }
                    const ans = a>b ? [`${a}`, `${b}`] : [`${b}`, `${a}`];
                    arr.push({q:`S·ªë n√†o l·ªõn h∆°n?`, a:ans, c:0, correctVal: Math.max(a,b)+"", icon:`${a}..${b}`});
                }
            }
            arr.forEach(x => { x.c = x.a.indexOf(x.correctVal); });
            return arr;
        };

        const staticQ = {
            tiengviet: [
                {q:"Con g√¨ k√™u 'Meo meo'?",a:["M√®o","Ch√≥","G√†","L·ª£n"],c:0,icon:"üê±"},{q:"Con g√¨ gi·ªØ nh√†?",a:["Ch√≥","M√®o","Chu·ªôt","Chim"],c:0,icon:"üê∂"},{q:"T·ª´ n√†o vi·∫øt ƒë√∫ng?",a:["Xinh x·∫Øn","Xinh s·∫Øn","Sinh x·∫Øn","Sinh s·∫Øn"],c:0},
                {q:"'ƒÇn qu·∫£ nh·ªõ k·∫ª tr·ªìng...'",a:["c√¢y","hoa","l√°","r·ª´ng"],c:0,icon:"üå≥"},{q:"Ba c√≤n g·ªçi l√† g√¨?",a:["B·ªë","M·∫π","√îng","Ch√∫"],c:0},{q:"M·∫π c·ªßa m·∫π g·ªçi l√†?",a:["B√† ngo·∫°i","B√† n·ªôi","D√¨","C√¥"],c:0,icon:"üëµ"},
                {q:"Tr√°i g√¨ v·ªè ƒë·ªè ru·ªôt tr·∫Øng h·∫°t ƒëen?",a:["D∆∞a h·∫•u","T√°o","·ªîi","Cam"],c:0,icon:"üçâ"},{q:"Con v·ªãt k√™u th·∫ø n√†o?",a:["C·∫°p c·∫°p","G√¢u g√¢u","Meo meo","√í √≥ o"],c:0,icon:"ü¶Ü"},
                {q:"Ch·ªØ c√°i ƒë·∫ßu ti√™n?",a:["A","B","C","D"],c:0},{q:"ƒêi·ªÅn t·ª´: 'L√° l√†nh ƒë√πm l√°...'",a:["r√°ch","n√°t","h√©o","t∆∞∆°i"],c:0},{q:"Con g√† tr·ªëng k√™u?",a:["√í √≥ o","C·ª•c t√°c","Chi·∫øp chi·∫øp","Qu√°c qu√°c"],c:0,icon:"üêì"},
                {q:"'Ch·ªã ng√£ em...'",a:["n√¢ng","ƒë·ª°","c∆∞·ªùi","kh√≥c"],c:0},{q:"Qu·∫£ g√¨ cay?",a:["·ªöt","Chanh","ƒê∆∞·ªùng","Mu·ªëi"],c:0,icon:"üå∂Ô∏è"},{q:"T·ª´ tr√°i nghƒ©a v·ªõi 'Cao'?",a:["Th·∫•p","D√†i","To","B√©o"],c:0},
                {q:"Con tr√¢u c√≥ m·∫•y ch√¢n?",a:["4","2","6","8"],c:0,icon:"üêÉ"},{q:"'H·ªçc th·∫ßy kh√¥ng t√†y h·ªçc...'",a:["b·∫°n","cha","m·∫π","anh"],c:0},{q:"B√°nh ch∆∞ng h√¨nh g√¨?",a:["Vu√¥ng","Tr√≤n","Tam gi√°c","Ch·ªØ nh·∫≠t"],c:0,icon:"üü©"},
                {q:"√îng m·∫∑t tr·ªùi m√†u g√¨?",a:["ƒê·ªè/V√†ng","Xanh","T√≠m","ƒêen"],c:0,icon:"‚òÄÔ∏è"},{q:"Con g√¨ bi·∫øt bay?",a:["Chim","C√°","Ch√≥","M√®o"],c:0,icon:"üê¶"},{q:"Xe ƒë·∫°p c√≥ m·∫•y b√°nh?",a:["2","3","4","1"],c:0,icon:"üö≤"},
                {q:"M√πa n√†o n√≥ng nh·∫•t?",a:["H√®","Thu","ƒê√¥ng","Xu√¢n"],c:0,icon:"‚òÄÔ∏è"},{q:"Em trai c·ªßa b·ªë g·ªçi l√†?",a:["Ch√∫","B√°c","C·∫≠u","D∆∞·ª£ng"],c:0},{q:"Ch·ªã g√°i c·ªßa m·∫π g·ªçi l√†?",a:["B√°c","D√¨","C√¥","M·ª£"],c:0},
                {q:"C√°i g√¨ d√πng ƒë·ªÉ vi·∫øt?",a:["B√∫t","Th∆∞·ªõc","T·∫©y","S√°ch"],c:0,icon:"‚úèÔ∏è"},{q:"C√°i g√¨ d√πng ƒë·ªÉ ƒë·ªôi ƒë·∫ßu?",a:["M≈©","Gi√†y","√Åo","Qu·∫ßn"],c:0,icon:"üß¢"},
                {q:"Con g√¨ ƒÉn c·ªè?",a:["B√≤","H·ªï","Ch√≥","M√®o"],c:0,icon:"üêÑ"},{q:"Con g√¨ s·ªëng d∆∞·ªõi n∆∞·ªõc?",a:["C√°","Chim","G√†","Kh·ªâ"],c:0,icon:"üêü"},{q:"B√¥ng hoa m√†u g√¨?",a:["ƒê·ªè","ƒêen","X√°m","N√¢u"],c:0,icon:"üåπ"},
                {q:"Qu·∫£ chu·ªëi m√†u g√¨?",a:["V√†ng","ƒê·ªè","T√≠m","Lam"],c:0,icon:"üçå"},{q:"C√¢y tre c√≥ ƒë·ªët kh√¥ng?",a:["C√≥","Kh√¥ng"],c:0,icon:"üéç"}
            ],
            tienganh: [
                {q:"Hello nghƒ©a l√†?",a:["Xin ch√†o","T·∫°m bi·ªát","C·∫£m ∆°n","Xin l·ªói"],c:0},{q:"Cat l√† con g√¨?",a:["M√®o","Ch√≥","L·ª£n","G√†"],c:0,icon:"üê±"},{q:"Dog l√† con g√¨?",a:["Ch√≥","M√®o","H·ªï","S∆∞ t·ª≠"],c:0,icon:"üêï"},
                {q:"Apple l√† qu·∫£ g√¨?",a:["T√°o","Cam","Chu·ªëi","Nho"],c:0,icon:"üçé"},{q:"Red l√† m√†u g√¨?",a:["ƒê·ªè","Xanh","V√†ng","T√≠m"],c:0,icon:"üü•"},{q:"One l√† s·ªë m·∫•y?",a:["1","2","3","4"],c:0,icon:"1Ô∏è‚É£"},
                {q:"Thank you l√†?",a:["C·∫£m ∆°n","Xin ch√†o","Xin l·ªói","T·∫°m bi·ªát"],c:0},{q:"Goodbye l√†?",a:["T·∫°m bi·ªát","Xin ch√†o","Ng·ªß ngon","C·∫£m ∆°n"],c:0},{q:"Blue l√† m√†u g√¨?",a:["Xanh d∆∞∆°ng","ƒê·ªè","V√†ng","Cam"],c:0,icon:"üü¶"},
                {q:"Banana l√† qu·∫£ g√¨?",a:["Chu·ªëi","T√°o","D∆∞a","·ªîi"],c:0,icon:"üçå"},{q:"Pig l√† con g√¨?",a:["L·ª£n","G√†","V·ªãt","B√≤"],c:0,icon:"üê∑"},{q:"Chicken l√† con g√¨?",a:["G√†","V·ªãt","Ng·ªóng","Chim"],c:0,icon:"üêî"},
                {q:"Father l√† ai?",a:["B·ªë","M·∫π","Anh","Ch·ªã"],c:0,icon:"üë®"},{q:"Mother l√† ai?",a:["M·∫π","B·ªë","B√†","√îng"],c:0,icon:"üë©"},{q:"Car l√† c√°i g√¨?",a:["√î t√¥","Xe m√°y","Xe ƒë·∫°p","M√°y bay"],c:0,icon:"üöó"},
                {q:"Ball l√† c√°i g√¨?",a:["Qu·∫£ b√≥ng","B√∫p b√™","C√°i gh·∫ø","C√°i b√†n"],c:0,icon:"‚öΩ"},{q:"Book l√† c√°i g√¨?",a:["S√°ch","B√∫t","V·ªü","Th∆∞·ªõc"],c:0,icon:"üìñ"},{q:"Pen l√† c√°i g√¨?",a:["B√∫t m·ª±c","B√∫t ch√¨","T·∫©y","Th∆∞·ªõc"],c:0,icon:"üñäÔ∏è"},
                {q:"School l√† ƒë√¢u?",a:["Tr∆∞·ªùng h·ªçc","B·ªánh vi·ªán","C√¥ng vi√™n","Nh√†"],c:0,icon:"üè´"},{q:"Teacher l√† ai?",a:["Gi√°o vi√™n","B√°c sƒ©","C√¥ng an","N√¥ng d√¢n"],c:0,icon:"üë©‚Äçüè´"},{q:"Doctor l√† ai?",a:["B√°c sƒ©","Y t√°","Gi√°o vi√™n","Ca sƒ©"],c:0,icon:"üë®‚Äç‚öïÔ∏è"},
                {q:"Eye l√† g√¨?",a:["M·∫Øt","M≈©i","Mi·ªáng","Tai"],c:0,icon:"üëÄ"},{q:"Nose l√† g√¨?",a:["M≈©i","M·∫Øt","Mi·ªáng","Tay"],c:0,icon:"üëÉ"},{q:"Hand l√† g√¨?",a:["B√†n tay","B√†n ch√¢n","ƒê·∫ßu","C·ªï"],c:0,icon:"üñêÔ∏è"},
                {q:"Sun l√† g√¨?",a:["M·∫∑t tr·ªùi","M·∫∑t trƒÉng","Sao","M√¢y"],c:0,icon:"‚òÄÔ∏è"},{q:"Moon l√† g√¨?",a:["M·∫∑t trƒÉng","M·∫∑t tr·ªùi","ƒê·∫•t","Bi·ªÉn"],c:0,icon:"üåô"},{q:"Fish l√† con g√¨?",a:["C√°","T√¥m","Cua","·ªêc"],c:0,icon:"üêü"},
                {q:"Bird l√† con g√¨?",a:["Chim","G√†","V·ªãt","B∆∞·ªõm"],c:0,icon:"üê¶"},{q:"Flower l√† g√¨?",a:["B√¥ng hoa","C√°i c√¢y","C·ªè","L√°"],c:0,icon:"üå∏"},{q:"Milk l√† g√¨?",a:["S·ªØa","N∆∞·ªõc","Tr√†","B√°nh"],c:0,icon:"ü•õ"}
            ],
            tunhien: [
                {q:"M·∫∑t tr·ªùi m·ªçc h∆∞·ªõng n√†o?",a:["ƒê√¥ng","T√¢y","Nam","B·∫Øc"],c:0,icon:"üåÖ"},{q:"C√° s·ªëng ·ªü ƒë√¢u?",a:["D∆∞·ªõi n∆∞·ªõc","Tr√™n c·∫°n","Tr√™n tr·ªùi","Trong ƒë·∫•t"],c:0,icon:"üêü"},
                {q:"ƒê√®n ƒë·ªè ph·∫£i l√†m g√¨?",a:["D·ª´ng l·∫°i","ƒêi ti·∫øp","Ch·∫°y nhanh","B·∫•m c√≤i"],c:0,icon:"üî¥"},{q:"Khi m∆∞a c·∫ßn g√¨?",a:["√î (d√π)","K√≠nh r√¢m","Kem ch·ªëng n·∫Øng","Qu·∫°t"],c:0,icon:"‚òî"},
                {q:"M√πa n√†o l·∫°nh nh·∫•t?",a:["ƒê√¥ng","H√®","Thu","Xu√¢n"],c:0,icon:"‚õÑ"},{q:"Con h·ªï ƒÉn g√¨?",a:["Th·ªãt","C·ªè","C∆°m","K·∫πo"],c:0,icon:"üêÖ"},{q:"N∆∞·ªõc bi·ªÉn v·ªã g√¨?",a:["M·∫∑n","Ng·ªçt","Chua","Cay"],c:0,icon:"üåä"},
                {q:"C·∫ßu v·ªìng m·∫•y m√†u?",a:["7","5","3","10"],c:0,icon:"üåà"},{q:"C√¢y c·∫ßn g√¨ ƒë·ªÉ s·ªëng?",a:["N∆∞·ªõc & √Ånh s√°ng","K·∫πo","Th·ªãt","B√°nh"],c:0,icon:"üå±"},{q:"Con g√¨ cho s·ªØa?",a:["B√≤","G√†","V·ªãt","Chim"],c:0,icon:"üêÑ"},
                {q:"BƒÉng tuy·∫øt m√†u g√¨?",a:["Tr·∫Øng","ƒêen","ƒê·ªè","V√†ng"],c:0,icon:"‚ùÑÔ∏è"},{q:"M·∫∑t trƒÉng th·∫•y khi n√†o?",a:["Ban ƒë√™m","Ban ng√†y","Bu·ªïi tr∆∞a","C·∫£ ng√†y"],c:0,icon:"üåô"},
                {q:"Con g√¨ c√≥ v√≤i d√†i?",a:["Voi","H·ªï","Kh·ªâ","Chu·ªôt"],c:0,icon:"üêò"},{q:"Con g√¨ c·ªï d√†i nh·∫•t?",a:["H∆∞∆°u cao c·ªï","Ng·ª±a","Tr√¢u","B√≤"],c:0,icon:"ü¶í"},{q:"Con g√¨ ch√∫a s∆°n l√¢m?",a:["H·ªï/S∆∞ t·ª≠","M√®o","Th·ªè","G√†"],c:0,icon:"ü¶Å"},
                {q:"G·∫°o n·∫•u th√†nh g√¨?",a:["C∆°m","Ch√°o","B√∫n","Ph·ªü"],c:0,icon:"üçö"},{q:"Con ong l√†m g√¨?",a:["H√∫t m·∫≠t","ƒÇn c·ªè","B·∫Øt chu·ªôt","Ng·ªß"],c:0,icon:"üêù"},{q:"Con nh·ªán giƒÉng g√¨?",a:["T∆°","L∆∞·ªõi","D√¢y","Ch·ªâ"],c:0,icon:"üï∏Ô∏è"},
                {q:"M√¢y m√†u g√¨?",a:["Tr·∫Øng","Xanh","ƒê·ªè","V√†ng"],c:0,icon:"‚òÅÔ∏è"},{q:"L·ª≠a n√≥ng hay l·∫°nh?",a:["N√≥ng","L·∫°nh"],c:0,icon:"üî•"},{q:"ƒê√° c·ª©ng hay m·ªÅm?",a:["C·ª©ng","M·ªÅm"],c:0,icon:"ü™®"},
                {q:"B√¥ng g√≤n nh·∫π hay n·∫∑ng?",a:["Nh·∫π","N·∫∑ng"],c:0},{q:"Con ·∫øch s·ªëng ·ªü ƒë√¢u?",a:["V·ª´a n∆∞·ªõc v·ª´a c·∫°n","Ch·ªâ d∆∞·ªõi n∆∞·ªõc","Ch·ªâ tr√™n c√¢y","Trong nh√†"],c:0,icon:"üê∏"},
                {q:"Con r√πa ƒëi th·∫ø n√†o?",a:["Ch·∫≠m","Nhanh","Nh·∫£y","Bay"],c:0,icon:"üê¢"},{q:"Con th·ªè th√≠ch ƒÉn g√¨?",a:["C√† r·ªët","Th·ªãt","C∆°m","C√°"],c:0,icon:"ü•ï"}
            ],
            logic: [
                {q:"C√°i g√¨ c√†ng r·ª≠a c√†ng b·∫©n?",a:["N∆∞·ªõc","B√°t","Qu·∫ßn √°o","Xe"],c:0,icon:"üíß"},{q:"S√°ng 4 ch√¢n, tr∆∞a 2 ch√¢n, chi·ªÅu 3 ch√¢n?",a:["Con ng∆∞·ªùi","Con b√≤","Con ch√≥","Con g√†"],c:0,icon:"üë∂üë®üë¥"},
                {q:"1kg s·∫Øt v√† 1kg b√¥ng c√°i n√†o n·∫∑ng?",a:["B·∫±ng nhau","S·∫Øt","B√¥ng","Kh√¥ng bi·∫øt"],c:0,icon:"‚öñÔ∏è"},{q:"C√°i g√¨ c√≥ ch√¢n kh√¥ng bi·∫øt ƒëi?",a:["C√°i b√†n","Con g√†","Em b√©","Con m√®o"],c:0,icon:"ü™ë"},
                {q:"Th√°ng 2 c√≥ bao nhi√™u ng√†y?",a:["28 ho·∫∑c 29","30","31","25"],c:0},{q:"M√®o con l√† con ai?",a:["M√®o m·∫π","Ch√≥ m·∫π","G√† m·∫π","V·ªãt m·∫π"],c:0,icon:"üêà"},
                {q:"C√°i g√¨ b·∫°n c√≥ nh∆∞ng ng∆∞·ªùi kh√°c g·ªçi?",a:["T√™n","Ti·ªÅn","Xe","Nh√†"],c:0},{q:"T√¨m h√¨nh kh√°c lo·∫°i?",a:["B√≥ng ƒë√°","C√°i b√°t","C√°i ƒëƒ©a","C√°i th√¨a"],c:0,icon:"‚öΩ"},
                {q:"C√°i g√¨ kh√¥ng c√°nh m√† bay?",a:["B√≥ng bay","M√°y bay","Chim","Ong"],c:0,icon:"üéà"},{q:"Nh√† Nam c√≥ 3 anh em: T√≠, T√®o v√† ...?",a:["Nam","B√¨nh","An","T√¢m"],c:0},
                {q:"Con g√¨ sinh ra ƒë√£ gi√†?",a:["Con √îng (Ong)","Con B∆∞·ªõm","Con Mu·ªói","Con Ru·ªìi"],c:0,icon:"üêù"},{q:"C√°i g√¨ ƒë·∫≠p th√¨ s·ªëng, kh√¥ng ƒë·∫≠p th√¨ ch·∫øt?",a:["Tr√°i tim","C√°i tr·ªëng","Qu·∫£ tr·ª©ng","Con mu·ªói"],c:0,icon:"‚ù§Ô∏è"},
                {q:"C√†ng k√©o c√†ng ng·∫Øn l√† g√¨?",a:["ƒêi·∫øu thu·ªëc","S·ª£i d√¢y","C√°i k·∫πo","C√¢y th∆∞·ªõc"],c:0},{q:"C√°i g√¨ ƒëi th√¨ n·∫±m, ƒë·ª©ng th√¨ n·∫±m, n·∫±m th√¨ ƒë·ª©ng?",a:["B√†n ch√¢n","B√†n tay","C√°i ƒë·∫ßu","C√°i b·ª•ng"],c:0,icon:"ü¶∂"},
                {q:"L·ªãch n√†o d√†i nh·∫•t?",a:["L·ªãch s·ª≠","L·ªãch treo t∆∞·ªùng","L·ªãch b√†n","L·ªãch v·∫°n ni√™n"],c:0,icon:"üìö"},{q:"Qu·∫ßn g√¨ r·ªông nh·∫•t?",a:["Qu·∫ßn ƒë·∫£o","Qu·∫ßn ƒë√πi","Qu·∫ßn d√†i","Qu·∫ßn b√≤"],c:0,icon:"üèùÔ∏è"},
                {q:"X√£ n√†o ƒë√¥ng nh·∫•t?",a:["X√£ h·ªôi","X√£ ƒë√†n","X√£ t·∫Øc","X√£ giao"],c:0},{q:"Con g√¨ ƒë·∫≠p th√¨ ch·∫øt, kh√¥ng ƒë·∫≠p th√¨ s·ªëng?",a:["Con tim","Con mu·ªói","Con ru·ªìi","Con ki·∫øn"],c:0},
                {q:"C√°i g√¨ c√†ng th·∫Øng c√†ng thua?",a:["ƒêua xe ƒë·∫°p (Th·∫Øng phanh)","ƒê√°nh b√†i","ƒê√° b√≥ng","Ch·∫°y thi"],c:0},{q:"Bi·ªÉn n√†o kh√¥ng c√≥ n∆∞·ªõc?",a:["Bi·ªÉn b√°o/B·∫£n ƒë·ªì","Bi·ªÉn ƒê√¥ng","Bi·ªÉn h·ªì","Bi·ªÉn ch·∫øt"],c:0}
            ]
        };

        const questionBank = {
            toan: genMath(60),
            tiengviet: [...staticQ.tiengviet, ...staticQ.tiengviet],
            tienganh: [...staticQ.tienganh, ...staticQ.tienganh],
            tunhien: [...staticQ.tunhien, ...staticQ.tunhien],
            logic: [...staticQ.logic, ...staticQ.logic]
        };

        const flashcardData = {
            animals: [ {id:'c',e:'Cat',v:'M√®o',i:'üê±'}, {id:'d',e:'Dog',v:'Ch√≥',i:'üê∂'}, {id:'l',e:'Lion',v:'S∆∞ t·ª≠',i:'ü¶Å'}, {id:'p',e:'Pig',v:'Heo',i:'üê∑'}, {id:'b',e:'Bird',v:'Chim',i:'üê¶'}, {id:'f',e:'Fish',v:'C√°',i:'üêü'}, {id:'m',e:'Monkey',v:'Kh·ªâ',i:'üêµ'}, {id:'ti',e:'Tiger',v:'H·ªï',i:'üêØ'}, {id:'pa',e:'Panda',v:'G·∫•u tr√∫c',i:'üêº'}, {id:'ch',e:'Chicken',v:'G√†',i:'üêî'} ],
            transport: [ {id:'ca',e:'Car',v:'√î t√¥',i:'üöó'}, {id:'bu',e:'Bus',v:'Bu√Ωt',i:'üöå'}, {id:'bi',e:'Bike',v:'Xe ƒë·∫°p',i:'üö≤'}, {id:'pl',e:'Plane',v:'M√°y bay',i:'‚úàÔ∏è'}, {id:'tr',e:'Train',v:'T√†u h·ªèa',i:'üöÇ'}, {id:'sh',e:'Ship',v:'T√†u th·ªßy',i:'üö¢'}, {id:'mo',e:'Moto',v:'Xe m√°y',i:'üõµ'}, {id:'tru',e:'Truck',v:'Xe t·∫£i',i:'üöö'}, {id:'amb',e:'Ambulance',v:'C·ª©u th∆∞∆°ng',i:'üöë'}, {id:'roc',e:'Rocket',v:'T√™n l·ª≠a',i:'üöÄ'} ],
            mix: [ {id:'su',e:'Sun',v:'M·∫∑t tr·ªùi',i:'‚òÄÔ∏è'}, {id:'moo',e:'Moon',v:'M·∫∑t trƒÉng',i:'üåô'}, {id:'fl',e:'Flower',v:'Hoa',i:'üå∏'}, {id:'tr',e:'Tree',v:'C√¢y',i:'üå≥'}, {id:'ap',e:'Apple',v:'T√°o',i:'üçé'}, {id:'ba',e:'Ball',v:'B√≥ng',i:'‚öΩ'}, {id:'bo',e:'Book',v:'S√°ch',i:'üìñ'}, {id:'pe',e:'Pen',v:'B√∫t',i:'üñäÔ∏è'}, {id:'ho',e:'Home',v:'Nh√†',i:'üè†'}, {id:'st',e:'Star',v:'Sao',i:'‚≠ê'} ]
        };

        const topics = { 'toan':'To√°n H·ªçc', 'tiengviet':'Ti·∫øng Vi·ªát', 'tienganh':'Ti·∫øng Anh', 'tunhien':'Th·∫ø Gi·ªõi', 'logic':'T∆∞ Duy', 'tonghop':'T·ªïng H·ª£p', 'memory':'Tr√≠ Nh·ªõ' };
        const avatars = ['üê±','ü¶Å','üê∞','üêº','ü¶Ñ','ü§ñ','ü¶ñ','üêù','ü¶ä','üê∏'];
        
        let users = JSON.parse(localStorage.getItem('rcv_users_v2')) || [];
        if(users.length===0){ users=[{id:Date.now(),name:"Kem",avatar:"üê±"}]; localStorage.setItem('rcv_users_v2',JSON.stringify(users)); }
        let history = JSON.parse(localStorage.getItem('rcv_history_v2')) || [];
        
        let currentUser=null, selectedAvatar=avatars[0], editUserId=null, performanceChart=null, activeExitScreen=null;
        let quizState={topic:'',questions:[],currentIndex:0,score:0,timer:null,timeLeft:15,maxQuestions:15};
        let memoryState={cards:[],flipped:[],matched:[],moves:0,canFlip:true,level:'', timer: null, timeLeft: 30, totalTime: 30};

        const screens = { user:document.getElementById('screen-user'), topic:document.getElementById('screen-topic'), game:document.getElementById('screen-game'), memory:document.getElementById('screen-memory'), result:document.getElementById('screen-result'), dashboard:document.getElementById('screen-dashboard') };

        // --- INIT & USER ---
        function init(){ renderAvatarSelector(); renderUserList(); }
        function switchScreen(n){ sfx.click(); Object.values(screens).forEach(el=>el.classList.add('hidden')); screens[n].classList.remove('hidden'); }
        function renderAvatarSelector(){ const c=document.getElementById('avatar-selector'); c.innerHTML=''; avatars.forEach(av=>{ const d=document.createElement('div'); d.className=`avatar-option text-4xl p-2 select-none ${av===selectedAvatar?'avatar-selected':''}`; d.innerText=av; d.onclick=()=>{sfx.click();selectedAvatar=av;renderAvatarSelector();}; c.appendChild(d); }); }
        function renderUserList(){ const l=document.getElementById('user-list'); l.innerHTML=''; users.forEach(u=>{ l.innerHTML+=`<div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center justify-between shadow-sm active:border-blue-300 transition"><div class="flex items-center gap-3 cursor-pointer flex-grow w-full" onclick="login(${u.id})"><span class="text-3xl">${u.avatar}</span><span class="font-bold text-gray-700 text-lg">${u.name}</span></div><button onclick="startEditUser(${u.id},event)" class="text-gray-300 hover:text-blue-500 p-2"><i class="fa-solid fa-pen-to-square"></i></button></div>`; }); }
        function handleUserAction(){ const n=document.getElementById('new-username').value.trim(); if(!n) return alert("B√© ch∆∞a nh·∫≠p t√™n!"); if(editUserId){ const i=users.findIndex(u=>u.id===editUserId); if(i!==-1){users[i].name=n;users[i].avatar=selectedAvatar;saveUsers();cancelEdit();} } else { const u={id:Date.now(),name:n,avatar:selectedAvatar}; users.push(u); saveUsers(); login(u.id); } document.getElementById('new-username').value=''; }
        function startEditUser(uid,e){ e.stopPropagation(); sfx.click(); const u=users.find(x=>x.id===uid); if(!u)return; editUserId=uid; document.getElementById('new-username').value=u.name; selectedAvatar=u.avatar; renderAvatarSelector(); const b=document.getElementById('btn-create-user'); b.innerHTML='<i class="fa-solid fa-check"></i> L∆∞u'; b.className='btn-3d w-full bg-orange-500 border-orange-700 text-white font-bold py-3 rounded-xl text-lg shadow-lg'; document.getElementById('btn-cancel-edit').classList.remove('hidden'); }
        function cancelEdit(){ editUserId=null; document.getElementById('new-username').value=''; const b=document.getElementById('btn-create-user'); b.innerHTML='<i class="fa-solid fa-play mr-2"></i> B·∫Øt ƒë·∫ßu ngay'; b.className='btn-3d w-full bg-green-500 border-green-700 text-white font-bold py-3 rounded-xl text-lg shadow-lg'; document.getElementById('btn-cancel-edit').classList.add('hidden'); selectedAvatar=avatars[0]; renderAvatarSelector(); }
        function saveUsers(){ localStorage.setItem('rcv_users_v2',JSON.stringify(users)); renderUserList(); }
        function login(uid){ currentUser=users.find(u=>u.id===uid); if(currentUser){ document.getElementById('display-avatar').innerText=currentUser.avatar; document.getElementById('display-username').innerText=currentUser.name; switchScreen('topic'); } }
        function logout(){ currentUser=null; cancelEdit(); switchScreen('user'); }

        // --- QUIZ LOGIC ---
        function startGame(tk){
            let qs = (tk==='tonghop') ? Object.values(questionBank).flat() : [...questionBank[tk]];
            qs = qs.sort(()=>0.5-Math.random()).slice(0,15);
            quizState={topic:tk,questions:qs,currentIndex:0,score:0,timer:null,timeLeft:15,maxQuestions:qs.length};
            document.getElementById('game-topic-name').innerText=topics[tk]; document.getElementById('score').innerText='0';
            switchScreen('game'); loadQuestion();
        }
        function loadQuestion(){
            if(quizState.currentIndex>=quizState.questions.length){ endQuizGame(); return; }
            const q=quizState.questions[quizState.currentIndex];
            document.getElementById('question-counter').innerText=`${quizState.currentIndex+1}/${quizState.maxQuestions}`;
            document.getElementById('question-text').innerText=q.q;
            const img=document.getElementById('question-image'); if(q.icon){img.innerText=q.icon;img.classList.remove('hidden');}else img.classList.add('hidden');
            const ac=document.getElementById('answers-container'); ac.innerHTML='';
            q.a.forEach((ans,i)=>{ const b=document.createElement('button'); b.className='btn-3d w-full bg-white text-blue-600 font-bold py-3 rounded-xl border-2 border-blue-200 hover:bg-blue-50 text-xl shadow-sm transition active:bg-blue-100'; b.innerText=ans; b.onclick=()=>checkAnswer(i,b,q.c); ac.appendChild(b); });
            quizState.timeLeft=15; updateTimerBar();
            if(quizState.timer) clearInterval(quizState.timer);
            quizState.timer=setInterval(()=>{ quizState.timeLeft--; updateTimerBar(); if(quizState.timeLeft<=0) handleTimeOut(); },1000);
        }
        function updateTimerBar(){ const b=document.getElementById('timer-bar'); b.style.width=`${(quizState.timeLeft/15)*100}%`; b.style.backgroundColor=quizState.timeLeft<5?'#ef4444':'#22c55e'; }
        function handleTimeOut(){ clearInterval(quizState.timer); sfx.wrong(); disableInputs(); setTimeout(()=>{quizState.currentIndex++; loadQuestion();},1500); }
        function checkAnswer(si,el,ci){ clearInterval(quizState.timer); disableInputs(); if(si===ci){ sfx.correct(); el.classList.add('correct-anim'); quizState.score+=10; document.getElementById('score').innerText=quizState.score; } else { sfx.wrong(); el.classList.add('wrong-anim'); document.getElementById('answers-container').children[ci].classList.add('correct-anim','opacity-80'); } setTimeout(()=>{quizState.currentIndex++; loadQuestion();},1500); }
        function disableInputs(){ Array.from(document.getElementById('answers-container').children).forEach(b=>b.disabled=true); }
        function endQuizGame(){ saveHistory(quizState.score, topics[quizState.topic], quizState.topic); showResult(quizState.score, quizState.maxQuestions*10); }

        // --- MEMORY LOGIC ---
        function showMemoryDifficultyModal(){ sfx.click(); document.getElementById('modal-memory-level').classList.remove('hidden'); }
        function startMemoryGame(level){
            document.getElementById('modal-memory-level').classList.add('hidden');
            let pairCount = 3; let gridClass = 'grid-cols-3'; let source = 'mix'; let time = 30;
            if(level==='easy') { pairCount=3; gridClass='grid-cols-3'; source=['animals','transport','mix'][Math.floor(Math.random()*3)]; time=30; }
            if(level==='medium') { pairCount=6; gridClass='grid-cols-3'; source='mix'; time=60; }
            if(level==='hard') { pairCount=10; gridClass='grid-cols-4'; source='mix'; time=120; }
            
            // Get data
            let pool = [];
            if(source==='mix') pool=[...flashcardData.animals, ...flashcardData.transport, ...flashcardData.mix];
            else pool = flashcardData[source];
            
            pool = pool.sort(()=>0.5-Math.random()).slice(0, pairCount);
            let cards = [];
            pool.forEach(x => { cards.push({...x}); cards.push({...x}); });
            cards = cards.sort(()=>0.5-Math.random());

            memoryState = { cards: cards, flipped: [], matched: [], moves: 0, canFlip: true, level: level, timeLeft: time, totalTime: time, timer: null };
            document.getElementById('memory-level-display').innerText = `ƒê·ªò KH√ì: ${level==='easy'?'D·ªÑ':(level==='medium'?'V·ª™A':'KH√ì')}`;
            document.getElementById('memory-moves').innerText = '0';
            
            const grid = document.getElementById('memory-grid');
            grid.className = `grid gap-2 flex-grow content-center justify-center ${gridClass}`;
            grid.innerHTML = '';
            
            cards.forEach((c,i) => {
                const el = document.createElement('div');
                el.className = `perspective w-full h-24 cursor-pointer card`;
                el.dataset.index = i; el.onclick = () => flipCard(i);
                el.innerHTML = `<div class="card-inner w-full h-full relative text-center"><div class="card-face card-front"></div><div class="card-face card-back bg-white border-2 border-blue-200"><div class="text-3xl mb-1">${c.i}</div><div class="text-[10px] font-bold text-blue-600 uppercase leading-none">${c.e}</div><div class="text-[9px] text-gray-400 leading-none mt-0.5">${c.v}</div></div></div>`;
                grid.appendChild(el);
            });
            switchScreen('memory');
            
            // Start Timer
            updateMemoryTimerBar();
            if(memoryState.timer) clearInterval(memoryState.timer);
            memoryState.timer = setInterval(()=>{
                memoryState.timeLeft--;
                updateMemoryTimerBar();
                if(memoryState.timeLeft <= 0) handleMemoryTimeOut();
            }, 1000);
        }

        function updateMemoryTimerBar() {
            const bar = document.getElementById('memory-timer-bar');
            const pct = (memoryState.timeLeft / memoryState.totalTime) * 100;
            bar.style.width = `${pct}%`;
            bar.style.backgroundColor = memoryState.timeLeft < 10 ? '#ef4444' : '#14b8a6'; // red : teal
        }

        function handleMemoryTimeOut() {
            clearInterval(memoryState.timer);
            sfx.wrong();
            // Show game over result
            showResult(0, 100, true, true); // true, true = isMemory, isTimeOut
        }

        function flipCard(i){
            if(!memoryState.canFlip || memoryState.flipped.includes(i) || memoryState.matched.includes(i) || memoryState.timeLeft <= 0) return;
            sfx.flip(); memoryState.flipped.push(i);
            document.querySelector(`.card[data-index="${i}"]`).classList.add('flipped');
            if(memoryState.flipped.length===2){
                memoryState.moves++; document.getElementById('memory-moves').innerText=memoryState.moves;
                checkMatch();
            }
        }
        function checkMatch(){
            memoryState.canFlip=false;
            const [i1, i2] = memoryState.flipped;
            if(memoryState.cards[i1].id === memoryState.cards[i2].id){
                sfx.match(); memoryState.matched.push(i1,i2); memoryState.flipped=[]; memoryState.canFlip=true;
                if(memoryState.matched.length===memoryState.cards.length) {
                    clearInterval(memoryState.timer); // Stop timer on win
                    setTimeout(endMemoryGame,800);
                }
            } else {
                setTimeout(()=>{
                    document.querySelector(`.card[data-index="${i1}"]`).classList.remove('flipped');
                    document.querySelector(`.card[data-index="${i2}"]`).classList.remove('flipped');
                    memoryState.flipped=[]; memoryState.canFlip=true;
                },1000);
            }
        }
        function endMemoryGame(){
            // Score based on level + bonus time
            let baseScore = memoryState.level==='easy'?50 : (memoryState.level==='medium'?100 : 150);
            // Bonus points for time left (1pt per second)
            let score = baseScore + memoryState.timeLeft;
            
            let displayLevel = memoryState.level==='easy'?' (D·ªÖ)':(memoryState.level==='medium'?' (V·ª´a)':' (Kh√≥)');
            saveHistory(score, "Tr√≠ Nh·ªõ"+displayLevel, "memory");
            showResult(score, score, true);
        }

        // --- COMMON ---
        function saveHistory(score, tName, tKey){
            const r = { userId:currentUser.id, date:new Date().toLocaleDateString('vi-VN'), topicKey:tKey, topicName:tName, score:score };
            history.unshift(r); localStorage.setItem('rcv_history_v2',JSON.stringify(history));
        }
        function showResult(score, max, isMem=false, isTimeOut=false){
            const t=document.getElementById('result-title'), i=document.getElementById('result-icon'), f=document.getElementById('result-feedback');
            document.getElementById('final-score').innerText=score;
            
            if(isTimeOut) {
                t.innerText = "H·∫øt gi·ªù r·ªìi!"; t.className="text-3xl font-bold text-gray-500 mb-2";
                i.innerText = "‚è∞";
                f.innerText = "Ti·∫øc qu√°, l·∫ßn sau nhanh tay h∆°n nh√©!";
            } else if(isMem){
                sfx.win();
                t.innerText="Tr√≠ nh·ªõ si√™u ph√†m!"; t.className="text-3xl font-bold text-teal-500 mb-2";
                i.innerText="üß†‚ú®"; 
                f.innerText=`Ho√†n th√†nh! C√≤n d∆∞ ${memoryState.timeLeft} gi√¢y!`;
                confetti({particleCount:150,spread:70,origin:{y:0.6}});
            } else {
                sfx.win();
                const r=score/max;
                if(r>=0.8){ t.innerText="Xu·∫•t s·∫Øc!"; t.className="text-3xl font-bold text-yellow-500 mb-2"; i.innerText="üèÜüîî"; f.innerText="Con l√† thi√™n t√†i!"; confetti({particleCount:150,spread:70,origin:{y:0.6}}); }
                else if(r>=0.5){ t.innerText="L√†m t·ªët l·∫Øm!"; t.className="text-3xl font-bold text-blue-500 mb-2"; i.innerText="üéà"; f.innerText="C·ªë l√™n h·∫°ng nh·∫•t nha!"; }
                else { t.innerText="C·ªë l√™n nh√©!"; t.className="text-3xl font-bold text-gray-500 mb-2"; i.innerText="üí™"; f.innerText="Luy·ªán th√™m x√≠u n·ªØa!"; }
            }
            switchScreen('result');
        }

        // --- DASHBOARD ---
        function showExitModal(s='game'){ sfx.click(); activeExitScreen=s; document.getElementById('modal-exit').classList.remove('hidden'); }
        function closeExitModal(){ sfx.click(); document.getElementById('modal-exit').classList.add('hidden'); }
        function realExitGame(){ 
            sfx.click(); 
            document.getElementById('modal-exit').classList.add('hidden'); 
            if(activeExitScreen==='game') clearInterval(quizState.timer);
            if(activeExitScreen==='memory') clearInterval(memoryState.timer);
            switchScreen('topic'); 
        }
        function backToTopics(){ switchScreen('topic'); }
        function showDashboard(){ switchScreen('dashboard'); switchTab('chart'); }
        function switchTab(t){
            ['chart','rank','history'].forEach(x=>document.getElementById(`content-${x}`).classList.add('hidden')); document.getElementById(`content-${t}`).classList.remove('hidden');
            ['tab-chart','tab-rank','tab-history'].forEach(x=>document.getElementById(x).className="flex-1 py-2 rounded-lg text-xs font-bold transition text-gray-400 bg-gray-100");
            document.getElementById(`tab-${t}`).className="flex-1 py-2 rounded-lg text-xs font-bold transition bg-white shadow text-blue-600";
            if(t==='chart') setTimeout(renderChart,50); if(t==='rank') renderRank('tonghop'); if(t==='history') renderHistory();
        }
        function renderChart(){
            document.getElementById('chart-username').innerText=currentUser.name;
            const ctx=document.getElementById('performanceChart').getContext('2d');
            const keys=['toan','tiengviet','tienganh','tunhien','logic','memory'];
            const labels=['To√°n','T.Vi·ªát','T.Anh','T.Gi·ªõi','Logic','Tr√≠ Nh·ªõ'];
            const data=keys.map(k=>{
                const rs=history.filter(h=>h.userId===currentUser.id && h.topicKey===k);
                if(!rs.length) return 0;
                if(k==='memory') {
                    // Normalize memory scores to roughly 0-100 range for visualization
                    let total=0; rs.forEach(r=>{
                        let max=100; // Base baseline
                        if(r.topicName.includes('D·ªÖ')) max=50; if(r.topicName.includes('Kh√≥')) max=150;
                        let normalized = (r.score / max) * 100;
                        if(normalized > 100) normalized = 100; // Cap at 100 for graph beauty
                        total += normalized; 
                    });
                    return Math.round(total/rs.length);
                }
                return Math.round(rs.reduce((a,b)=>a+b.score,0)/rs.length);
            });
            if(performanceChart) performanceChart.destroy();
            performanceChart=new Chart(ctx,{type:'radar',data:{labels:labels,datasets:[{label:'ƒêi·ªÉm TB',data:data,backgroundColor:'rgba(59,130,246,0.2)',borderColor:'rgba(59,130,246,1)',pointBackgroundColor:'#FBBF24',borderWidth:2}]},options:{scales:{r:{angleLines:{display:false},suggestedMin:0,suggestedMax:100,pointLabels:{font:{size:11,family:'Baloo 2'}},ticks:{display:false}}},plugins:{legend:{display:false}},maintainAspectRatio:false}});
        }
        function renderRank(k){
            const c=document.getElementById('rank-filters'); c.innerHTML='';
            ['tonghop',...Object.keys(topics)].forEach(key=>{
                const b=document.createElement('button'); b.className=`whitespace-nowrap px-3 py-1 rounded-full text-[10px] font-bold border ${key===k?'bg-blue-500 text-white border-blue-600 shadow-md':'bg-white text-gray-500 border-gray-200'}`;
                b.innerText=topics[key]||"T·ªïng H·ª£p"; b.onclick=()=>renderRank(key); c.appendChild(b);
            });
            const ums=[]; users.forEach(u=>{ const rs=history.filter(h=>h.userId===u.id&&(k==='tonghop'||h.topicKey===k)); if(rs.length) ums.push({u,s:Math.max(...rs.map(r=>r.score))}); });
            ums.sort((a,b)=>b.s-a.s);
            const l=document.getElementById('rank-list'); l.innerHTML=ums.length?'': '<tr><td colspan="3" class="p-4 text-center text-gray-400">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            ums.forEach((x,i)=>{ l.innerHTML+=`<tr class="${i<3?'bg-yellow-50':''}"><td class="p-3 align-middle">${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':i+1}</td><td class="p-3 flex items-center gap-2"><span class="text-xl">${x.u.avatar}</span> <span>${x.u.name}</span></td><td class="p-3 text-right text-blue-600">${x.s}</td></tr>`; });
        }
        function renderHistory(){
            const h=history.filter(x=>x.userId===currentUser.id);
            const l=document.getElementById('history-list'); const e=document.getElementById('empty-history');
            if(!h.length){l.innerHTML=`<tr><td class="text-center p-4 text-gray-400"><i class="fa-solid fa-ghost text-2xl mb-1 block"></i>Ch∆∞a c√≥ l·ªãch s·ª≠</td></tr>`;} 
            else { l.innerHTML=h.map(x=>`<tr class="border-b border-gray-100"><td class="py-3 px-1"><div class="text-[10px] text-gray-400 font-bold">${x.date}</div><div class="font-bold text-blue-600 text-xs">${x.topicName}</div></td><td class="py-3 px-1 text-right"><span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-xs font-bold">${x.score}ƒë</span></td></tr>`).join(''); }
        }

        init();
    </script>
</body>
</html>

