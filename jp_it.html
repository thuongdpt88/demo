<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyá»‡n thi Tiáº¿ng Nháº­t IT (Full Data)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Nunito', 'Noto Sans JP', sans-serif; }
        .hidden { display: none !important; }
        
        /* 3D Flip */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes bounceIn { 
            0% { opacity: 0; transform: scale(0.3); } 
            50% { transform: scale(1.05); } 
            70% { transform: scale(0.9); } 
            100% { transform: scale(1); opacity: 1; } 
        }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000) forwards; }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .animate-pop { animation: pop 0.3s ease-in-out; }

        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        .animate-shake-victory { animation: shake 0.5s ease-in-out infinite; }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }

        /* Avatar Selection */
        .avatar-option.selected {
            border-color: #6366f1; /* Indigo 500 */
            background-color: #e0e7ff; /* Indigo 100 */
            transform: scale(1.1);
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 overflow-x-hidden">

    <!-- APP CONTAINER -->
    <div id="app" class="relative min-h-screen flex flex-col">
        
        <!-- LOADING SCREEN -->
        <div id="screen-loading" class="fixed inset-0 bg-blue-50 z-50 flex flex-col items-center justify-center text-blue-600 transition-opacity duration-500">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
            <p class="font-bold text-lg animate-pulse">Äang táº£i dá»¯ liá»‡u...</p>
        </div>

        <!-- LOGIN SCREEN -->
        <div id="screen-login" class="screen hidden min-h-screen bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center p-4">
            <div class="bg-white rounded-[2rem] shadow-2xl p-6 md:p-8 max-w-md w-full text-center border-4 border-white/20 animate-bounce-in relative overflow-hidden">
                
                <!-- Header Logo -->
                <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                    <i data-lucide="book-open" class="w-10 h-10 text-indigo-600"></i>
                </div>
                <h1 class="text-2xl font-black text-gray-800 mb-1">IT Japanese</h1>
                <p class="text-gray-500 mb-6 font-medium text-sm">Luyá»‡n thi chuyÃªn ngÃ nh IT (N5 & N4)</p>

                <!-- VIEW 1: USER LIST (Select existing) -->
                <div id="login-view-list" class="hidden">
                    <p class="text-gray-600 font-bold mb-4 text-left px-2">Ai Ä‘ang há»c tháº¿?</p>
                    <div id="user-list-grid" class="grid grid-cols-2 gap-3 mb-6 max-h-60 overflow-y-auto custom-scrollbar p-1">
                        <!-- Users injected here -->
                    </div>
                    <button id="btn-show-create" class="w-full py-3 rounded-xl border-2 border-dashed border-gray-300 text-gray-500 font-bold hover:border-indigo-500 hover:text-indigo-600 hover:bg-indigo-50 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="plus" class="w-5 h-5"></i> Táº¡o ngÆ°á»i má»›i
                    </button>
                </div>

                <!-- VIEW 2: CREATE USER -->
                <div id="login-view-create" class="hidden">
                    <div class="space-y-4">
                        <div class="text-left">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 ml-1">TÃªn cá»§a báº¡n</label>
                            <input type="text" id="create-user-input" placeholder="Nháº­p tÃªn..." class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:outline-none font-bold text-gray-700 bg-gray-50">
                        </div>

                        <div class="text-left">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1">Chá»n Avatar</label>
                            <div id="avatar-grid" class="grid grid-cols-5 gap-2">
                                <!-- Avatars injected here -->
                            </div>
                        </div>

                        <div class="flex gap-2 pt-2">
                            <button id="btn-cancel-create" class="hidden flex-1 bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-3 rounded-xl transition-all">
                                Quay láº¡i
                            </button>
                            <button id="btn-confirm-create" class="flex-[2] bg-indigo-500 hover:bg-indigo-600 shadow-lg shadow-indigo-200 text-white font-bold py-3 rounded-xl transition-all active:scale-95 flex items-center justify-center gap-2">
                                Báº¯t Ä‘áº§u <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- DASHBOARD SCREEN -->
        <div id="screen-dashboard" class="screen hidden pb-12 animate-fade-in">
            <!-- Header -->
            <div class="bg-white px-6 py-4 shadow-sm flex justify-between items-center sticky top-0 z-20">
                <div class="flex items-center gap-3">
                    <!-- Avatar Display -->
                    <div id="dashboard-avatar" class="w-10 h-10 rounded-xl flex items-center justify-center text-xl shadow-lg bg-gray-100">
                        ğŸ‘¤
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-400 font-black uppercase tracking-wider">Há»c viÃªn</p>
                        <p id="user-display-name" class="text-lg font-bold text-gray-800 leading-none">User</p>
                    </div>
                </div>
                <button id="btn-logout" class="text-gray-400 hover:text-red-500 transition-colors p-2 rounded-lg hover:bg-red-50" title="Äá»•i ngÆ°á»i há»c">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="container mx-auto p-4 max-w-6xl mt-6">
                <!-- Hero Banner -->
                <div class="bg-gradient-to-r from-indigo-600 to-purple-700 rounded-3xl p-8 text-white shadow-xl shadow-indigo-200 mb-10 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6">
                        <div>
                            <h2 class="text-3xl font-black mb-2 flex items-center gap-2">Xin chÃ o! ğŸ‘‹</h2>
                            <p class="text-indigo-100 font-medium">HÃ´m nay báº¡n muá»‘n há»c gÃ¬?</p>
                        </div>
                        <div class="bg-white/10 p-5 rounded-2xl backdrop-blur-md text-center border border-white/20 min-w-[120px] shadow-lg">
                            <span id="user-score-count" class="block text-4xl font-black">0</span>
                            <span class="text-xs uppercase font-bold tracking-widest opacity-80">BÃ i thi</span>
                        </div>
                    </div>
                </div>

                <!-- 100 QUESTIONS CHALLENGE BANNER -->
                <div class="mb-8">
                    <div class="bg-gradient-to-r from-pink-500 to-rose-500 rounded-3xl p-1 shadow-lg transform transition hover:scale-[1.01] cursor-pointer group" onclick="app.openGameConfig('All', 'mixed')">
                        <div class="bg-white/10 backdrop-blur-sm rounded-[20px] p-6 flex flex-col sm:flex-row items-center justify-between text-white h-full gap-4">
                            <div class="flex items-center gap-4">
                                <div class="p-4 bg-white/20 rounded-full shadow-inner animate-pulse">
                                     <i data-lucide="swords" class="w-8 h-8 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-black flex items-center gap-2">
                                        Thá»­ thÃ¡ch tá»•ng há»£p
                                        <span class="bg-yellow-400 text-yellow-900 text-[10px] px-2 py-0.5 rounded-full uppercase tracking-wider font-bold">HOT</span>
                                    </h3>
                                    <p class="text-pink-100 font-medium opacity-90 group-hover:opacity-100">100 cÃ¢u há»i ngáº«u nhiÃªn tá»« N5 & N4</p>
                                </div>
                            </div>
                            <div class="bg-white text-rose-600 font-bold px-8 py-4 rounded-xl shadow-lg flex items-center gap-2 group-hover:bg-rose-50 transition-colors">
                                Chiáº¿n ngay <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Actions Column -->
                    <div class="lg:col-span-2 space-y-8">
                        <!-- N5 Section -->
                        <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <span class="bg-emerald-100 text-emerald-700 font-black px-3 py-1 rounded-lg">N5</span>
                                    <h3 class="text-xl font-bold text-gray-800">IT CÆ¡ Báº£n</h3>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <button onclick="app.openGameConfig('N5', 'jp_vn')" class="game-btn bg-white text-gray-700 border-2 border-gray-200 hover:bg-emerald-50 hover:border-emerald-300 hover:text-emerald-700 font-bold py-3 px-4 rounded-xl transition-all flex items-center justify-start gap-2">
                                    <span class="bg-gray-100 p-1 rounded text-xs">ğŸ‡¯ğŸ‡µ âœ ğŸ‡»ğŸ‡³</span> Nháº­t - Viá»‡t
                                </button>
                                <button onclick="app.openGameConfig('N5', 'vn_jp')" class="game-btn bg-white text-gray-700 border-2 border-gray-200 hover:bg-emerald-50 hover:border-emerald-300 hover:text-emerald-700 font-bold py-3 px-4 rounded-xl transition-all flex items-center justify-start gap-2">
                                    <span class="bg-gray-100 p-1 rounded text-xs">ğŸ‡»ğŸ‡³ âœ ğŸ‡¯ğŸ‡µ</span> Viá»‡t - Nháº­t
                                </button>
                                <button onclick="app.openGameConfig('N5', 'kanji_hira')" class="game-btn bg-white text-gray-700 border-2 border-gray-200 hover:bg-emerald-50 hover:border-emerald-300 hover:text-emerald-700 font-bold py-3 px-4 rounded-xl transition-all flex items-center justify-start gap-2">
                                    <span class="bg-gray-100 p-1 rounded text-xs">æ¼¢ âœ ã‚</span> Kanji - Hira
                                </button>
                                <button onclick="app.openGameConfig('N5', 'hira_kanji')" class="game-btn bg-white text-gray-700 border-2 border-gray-200 hover:bg-emerald-50 hover:border-emerald-300 hover:text-emerald-700 font-bold py-3 px-4 rounded-xl transition-all flex items-center justify-start gap-2">
                                    <span class="bg-gray-100 p-1 rounded text-xs">ã‚ âœ æ¼¢</span> Hira - Kanji
                                </button>
                            </div>
                        </div>

                        <!-- N4 Section -->
                        <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <span class="bg-amber-100 text-amber-700 font-black px-3 py-1 rounded-lg">N4</span>
                                    <h3 class="text-xl font-bold text-gray-800">Business & Email (+New Data)</h3>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <button onclick="app.openGameConfig('N4', 'jp_vn')" class="game-btn bg-white text-gray-700 border-2 border-gray-200 hover:bg-amber-50 hover:border-amber-300 hover:text-amber-700 font-bold py-3 px-4 rounded-xl transition-all flex items-center justify-start gap-2">
                                    <span class="bg-gray-100 p-1 rounded text-xs">ğŸ‡¯ğŸ‡µ âœ ğŸ‡»ğŸ‡³</span> Nháº­t - Viá»‡t
                                </button>
                                <button onclick="app.openGameConfig('N4', 'vn_jp')" class="game-btn bg-white text-gray-700 border-2 border-gray-200 hover:bg-amber-50 hover:border-amber-300 hover:text-amber-700 font-bold py-3 px-4 rounded-xl transition-all flex items-center justify-start gap-2">
                                    <span class="bg-gray-100 p-1 rounded text-xs">ğŸ‡»ğŸ‡³ âœ ğŸ‡¯ğŸ‡µ</span> Viá»‡t - Nháº­t
                                </button>
                                <button onclick="app.openGameConfig('N4', 'kanji_hira')" class="game-btn bg-white text-gray-700 border-2 border-gray-200 hover:bg-amber-50 hover:border-amber-300 hover:text-amber-700 font-bold py-3 px-4 rounded-xl transition-all flex items-center justify-start gap-2">
                                    <span class="bg-gray-100 p-1 rounded text-xs">æ¼¢ âœ ã‚</span> Kanji - Hira
                                </button>
                            </div>
                        </div>

                         <!-- Features -->
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="app.startFlashcard('N5')" class="bg-orange-500 hover:bg-orange-600 border-b-4 border-orange-700 text-white font-bold py-4 px-6 rounded-xl transition-all transform active:scale-95 flex items-center justify-center gap-2 shadow-lg shadow-orange-200">
                                <i data-lucide="gallery-vertical-end" class="w-5 h-5"></i> <span>Flashcard</span>
                            </button>
                            <button onclick="app.showDictionary()" class="bg-blue-500 hover:bg-blue-600 border-b-4 border-blue-700 text-white font-bold py-4 px-6 rounded-xl transition-all transform active:scale-95 flex items-center justify-center gap-2 shadow-lg shadow-blue-200">
                                <i data-lucide="book" class="w-5 h-5"></i> <span>Tá»« Ä‘iá»ƒn</span>
                            </button>
                        </div>
                    </div>

                    <!-- Leaderboard Column -->
                    <div class="bg-white rounded-3xl shadow-sm border border-gray-100 flex flex-col h-[600px]">
                        <div class="p-4 border-b border-gray-100 bg-gradient-to-r from-yellow-50 to-white rounded-t-3xl">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold text-gray-800 flex items-center gap-2">
                                    <i data-lucide="trophy" class="w-5 h-5 text-yellow-500 fill-yellow-500"></i> Báº£ng vÃ ng
                                </h3>
                                <div class="flex items-center gap-1 bg-green-50 text-green-600 px-2 py-1 rounded text-xs font-bold">
                                    <i data-lucide="hard-drive" class="w-3 h-3"></i> Local
                                </div>
                            </div>
                            <!-- FILTER DROPDOWN -->
                            <div class="relative">
                                <i data-lucide="filter" class="absolute left-2 top-2 w-4 h-4 text-gray-400"></i>
                                <select id="leaderboard-filter" onchange="app.filterLeaderboard(this.value)" class="w-full pl-8 pr-4 py-1.5 text-sm bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 font-bold text-gray-600 cursor-pointer">
                                    <option value="all">Táº¥t cáº£ cÃ¡c bÃ i thi</option>
                                    <option value="All_mixed" class="font-bold text-rose-500">âš¡ Thá»­ thÃ¡ch 100 cÃ¢u</option>
                                    <optgroup label="Cáº¥p Ä‘á»™ N5">
                                        <option value="N5_jp_vn">ğŸ‡¯ğŸ‡µ Nháº­t - Viá»‡t</option>
                                        <option value="N5_vn_jp">ğŸ‡»ğŸ‡³ Viá»‡t - Nháº­t</option>
                                        <option value="N5_kanji_hira">æ¼¢ Kanji - Hira</option>
                                        <option value="N5_hira_kanji">ã‚ Hira - Kanji</option>
                                    </optgroup>
                                    <optgroup label="Cáº¥p Ä‘á»™ N4">
                                        <option value="N4_jp_vn">ğŸ‡¯ğŸ‡µ Nháº­t - Viá»‡t</option>
                                        <option value="N4_vn_jp">ğŸ‡»ğŸ‡³ Viá»‡t - Nháº­t</option>
                                        <option value="N4_kanji_hira">æ¼¢ Kanji - Hira</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        <div id="leaderboard-container" class="p-4 space-y-3 overflow-y-auto flex-1 custom-scrollbar">
                            <!-- Items inserted by JS -->
                            <div class="flex flex-col items-center justify-center h-full text-gray-400">
                                <p class="text-sm">ChÆ°a cÃ³ dá»¯ liá»‡u.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GAME CONFIG MODAL (New) -->
        <div id="modal-game-config" class="hidden fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
             <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl animate-bounce-in">
                 <div class="flex items-center gap-2 text-indigo-500 mb-4">
                     <i data-lucide="settings-2" class="w-6 h-6"></i>
                     <h3 class="text-xl font-bold text-gray-800">Cáº¥u hÃ¬nh bÃ i thi</h3>
                 </div>
                 
                 <div class="mb-6 bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <p class="text-sm font-bold text-gray-500 uppercase mb-3">Cháº¿ Ä‘á»™</p>
                    <p id="config-mode-name" class="text-lg font-black text-indigo-700 mb-6">...</p>
                    
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-bold text-gray-800">Giá»›i háº¡n thá»i gian</p>
                            <p class="text-xs text-gray-500">15 giÃ¢y / cÃ¢u há»i</p>
                        </div>
                        
                        <!-- Toggle Switch -->
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="config-timer-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 checked:right-0 checked:border-green-400 transition-all duration-300" checked/>
                            <label for="config-timer-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer checked:bg-green-400 transition-colors duration-300"></label>
                        </div>
                    </div>
                 </div>

                 <div class="flex gap-3 justify-end">
                     <button onclick="document.getElementById('modal-game-config').classList.add('hidden')" class="text-gray-500 hover:bg-gray-100 font-bold py-3 px-6 rounded-xl transition-colors">Há»§y</button>
                     <button id="btn-start-configured-game" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-colors shadow-lg shadow-indigo-200 flex items-center gap-2">
                         Báº¯t Ä‘áº§u <i data-lucide="play" class="w-4 h-4 fill-current"></i>
                     </button>
                 </div>
             </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="screen-game" class="screen hidden min-h-screen bg-slate-100 flex flex-col">
            <div class="bg-white shadow-md p-3 px-4 flex justify-between items-center z-10 sticky top-0">
                <div class="flex flex-col">
                    <span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Cháº¿ Ä‘á»™</span>
                    <span id="game-mode-title" class="text-lg font-black text-indigo-700 leading-none">...</span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex flex-col items-end">
                        <span class="text-[10px] font-bold text-gray-400 uppercase">CÃ¢u há»i</span>
                        <span id="game-progress" class="text-xl font-black text-gray-800 leading-none">0/0</span>
                    </div>
                    <button id="btn-quit-game" class="bg-rose-500 hover:bg-rose-600 border-b-4 border-rose-700 text-white font-bold py-2 px-3 rounded-lg transition-all active:scale-95">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <!-- Timer Bar -->
            <div class="w-full bg-gray-200 h-1.5">
                <div id="timer-bar" class="h-full bg-blue-500 transition-all duration-1000 linear" style="width: 100%;"></div>
            </div>

            <div class="flex-1 container mx-auto p-4 max-w-4xl flex flex-col justify-center">
                <div id="question-card" class="bg-white rounded-3xl shadow-xl border-b-8 border-gray-100 p-8 md:p-12 mb-6 text-center relative overflow-hidden min-h-[250px] flex flex-col items-center justify-center transition-transform duration-300">
                    <!-- Feedback Overlay -->
                    <div id="feedback-overlay" class="hidden absolute inset-0 z-20 bg-white/95 backdrop-blur-sm flex items-center justify-center">
                        <div id="feedback-content" class="text-center"></div>
                    </div>
                    
                    <h2 id="question-text" class="text-3xl md:text-5xl font-black text-gray-800 mb-4 leading-tight">...</h2>
                    <div class="text-gray-400 text-xs font-bold uppercase tracking-[0.2em] bg-gray-50 inline-block px-3 py-1 rounded-full">Chá»n Ä‘Ã¡p Ã¡n Ä‘Ãºng</div>
                </div>

                <div id="answers-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Options injected by JS -->
                </div>
            </div>
        </div>

        <!-- FLASHCARD SCREEN -->
        <div id="screen-flashcard" class="screen hidden min-h-screen bg-amber-50 flex flex-col">
            <div class="bg-white shadow-sm p-4 flex items-center gap-4 sticky top-0 z-10">
                <button onclick="app.showDashboard()" class="text-gray-500 hover:bg-gray-100 p-2 rounded-lg"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <div class="flex-1 flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2">
                    <h1 class="text-xl font-black text-amber-700">FLASHCARD</h1>
                    <select id="fc-level-select" class="bg-amber-100 text-amber-800 font-bold text-sm py-1 px-3 rounded-lg border-none focus:ring-2 focus:ring-amber-500 cursor-pointer">
                        <option value="N5">Cáº¥p Ä‘á»™ N5</option>
                        <option value="N4">Cáº¥p Ä‘á»™ N4</option>
                    </select>
                </div>
                <span id="flashcard-count" class="font-mono font-bold text-gray-400 text-sm sm:text-base">1 / 10</span>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center p-6">
                <!-- Card Container -->
                <div id="flashcard-container" class="w-full max-w-sm aspect-[3/4] perspective-1000 cursor-pointer group">
                    <div id="flashcard-inner" class="relative w-full h-full transition-all duration-500 transform-style-3d">
                        <!-- Front -->
                        <div class="absolute inset-0 backface-hidden bg-white rounded-3xl shadow-xl border-b-8 border-amber-200 flex flex-col items-center justify-center p-8 text-center hover:shadow-2xl transition-shadow">
                            <span class="text-xs font-bold text-amber-400 uppercase tracking-widest mb-4">Kanji / Tá»« vá»±ng</span>
                            <h2 id="fc-front-text" class="text-5xl md:text-6xl font-black text-gray-800 mb-4 break-words w-full">...</h2>
                            <p class="text-gray-400 text-sm animate-pulse mt-auto">(Cháº¡m Ä‘á»ƒ láº­t)</p>
                        </div>
                        <!-- Back -->
                        <div class="absolute inset-0 backface-hidden rotate-y-180 bg-amber-600 rounded-3xl shadow-xl border-b-8 border-amber-800 flex flex-col items-center justify-center p-8 text-center text-white">
                             <div class="mb-6 w-full">
                                <span class="text-xs font-bold text-amber-200 uppercase tracking-widest block mb-1">CÃ¡ch Ä‘á»c</span>
                                <p id="fc-back-reading" class="text-3xl md:text-4xl font-bold break-words">...</p>
                             </div>
                             <div class="w-16 h-1 bg-amber-400/50 rounded-full mb-6 shrink-0"></div>
                             <div class="w-full">
                                <span class="text-xs font-bold text-amber-200 uppercase tracking-widest block mb-1">Ã nghÄ©a</span>
                                <p id="fc-back-meaning" class="text-xl md:text-2xl font-medium break-words">...</p>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex gap-4 mt-8">
                    <button id="fc-prev" class="rounded-full w-14 h-14 bg-white border-2 border-gray-200 text-gray-600 flex items-center justify-center hover:bg-gray-50 active:scale-95 transition-transform"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                    <button id="fc-shuffle" class="rounded-full w-14 h-14 bg-amber-50 border-2 border-amber-200 text-amber-600 flex items-center justify-center hover:bg-amber-100 active:scale-95 transition-transform"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
                    <button id="fc-next" class="rounded-full w-14 h-14 bg-white border-2 border-gray-200 text-gray-600 flex items-center justify-center hover:bg-gray-50 active:scale-95 transition-transform"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                </div>
            </div>
        </div>

        <!-- DICTIONARY SCREEN -->
        <div id="screen-dictionary" class="screen hidden min-h-screen bg-gray-50 flex flex-col">
            <div class="bg-white shadow p-4 flex items-center gap-4 sticky top-0 z-20">
                <button onclick="app.showDashboard()" class="text-gray-500 hover:bg-gray-100 p-2 rounded-lg"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <h1 class="text-xl font-black text-gray-800 flex-1">Tá»ª ÄIá»‚N</h1>
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                    <input type="text" id="dict-search" placeholder="TÃ¬m kiáº¿m..." class="pl-9 pr-4 py-2 bg-gray-100 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="container mx-auto p-4 max-w-5xl">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-500 uppercase text-xs font-bold tracking-wider border-b border-gray-100">
                                <tr>
                                    <th class="p-5">Gá»‘c</th>
                                    <th class="p-5">Reading</th>
                                    <th class="p-5">NghÄ©a</th>
                                </tr>
                            </thead>
                            <tbody id="dict-body" class="divide-y divide-gray-100">
                                <!-- Generated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL -->
        <div id="modal-overlay" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
            <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl animate-bounce-in">
                <div class="flex items-center gap-2 text-rose-500 mb-2">
                    <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                    <h3 id="modal-title" class="text-xl font-bold text-gray-800">ThÃ´ng bÃ¡o</h3>
                </div>
                <div id="modal-content" class="mb-6 text-gray-600 leading-relaxed">Ná»™i dung...</div>
                <div class="flex gap-3 justify-end">
                    <button id="modal-btn-cancel" class="text-gray-500 hover:bg-gray-100 font-bold py-2 px-4 rounded-lg transition-colors">Há»§y</button>
                    <button id="modal-btn-confirm" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md shadow-rose-200">OK</button>
                </div>
            </div>
        </div>
        
        <!-- VICTORY OVERLAY (High Score) -->
        <div id="victory-overlay" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 animate-fade-in">
             <div class="bg-gradient-to-br from-yellow-300 to-orange-400 p-1 rounded-3xl shadow-2xl animate-bounce-in max-w-sm w-full">
                 <div class="bg-white rounded-[20px] p-8 text-center">
                     <div class="mb-4 inline-block p-4 rounded-full bg-yellow-100 text-yellow-500 animate-shake-victory">
                         <i data-lucide="crown" class="w-16 h-16 fill-current"></i>
                     </div>
                     <h2 class="text-3xl font-black text-gray-800 mb-2">XUáº¤T Sáº®C!</h2>
                     <p class="text-gray-500 mb-6" id="victory-message">Báº¡n Ä‘Ã£ phÃ¡ ká»· lá»¥c cá»§a chÃ­nh mÃ¬nh!</p>
                     
                     <div class="text-6xl font-black text-indigo-600 mb-2" id="victory-score">10/10</div>
                     <div class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-8">Äiá»ƒm sá»‘</div>
                     
                     <button onclick="app.closeVictoryModal()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-all active:scale-95 shadow-lg shadow-indigo-200">
                         Tuyá»‡t vá»i!
                     </button>
                 </div>
             </div>
        </div>

        <!-- COMPLETION OVERLAY (Normal) -->
        <div id="completion-overlay" class="hidden fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 animate-fade-in">
             <div class="bg-gradient-to-br from-indigo-300 to-purple-400 p-1 rounded-3xl shadow-2xl animate-bounce-in max-w-sm w-full">
                 <div class="bg-white rounded-[20px] p-8 text-center">
                     <div class="mb-4 inline-block p-4 rounded-full bg-indigo-100 text-indigo-500 animate-pop">
                         <i data-lucide="check-circle-2" class="w-16 h-16"></i>
                     </div>
                     <h2 class="text-2xl font-black text-gray-800 mb-2">HOÃ€N THÃ€NH!</h2>
                     <p class="text-gray-500 mb-6">Báº¡n Ä‘Ã£ lÃ m ráº¥t tá»‘t. HÃ£y cá»‘ gáº¯ng phÃ¡ ká»· lá»¥c láº§n sau nhÃ©!</p>
                     
                     <div class="text-5xl font-black text-gray-700 mb-2" id="completion-score">8/10</div>
                     <div class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-8">Äiá»ƒm sá»‘</div>
                     
                     <button onclick="app.closeCompletionModal()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-xl transition-all active:scale-95">
                         Vá» trang chá»§
                     </button>
                 </div>
             </div>
        </div>

    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- DATA ---
        const N5_VOCAB = [
            { no: 1, kanji: "è¨­è¨ˆ", reading: "ã›ã£ã‘ã„", vn: "Thiáº¿t káº¿" },
            { no: 2, kanji: "ç”»é¢", reading: "ãŒã‚ã‚“", vn: "MÃ n hÃ¬nh" },
            { no: 3, kanji: "é …ç›®", reading: "ã“ã†ã‚‚ã", vn: "Item (Háº¡ng má»¥c)" },
            { no: 4, kanji: "èª¬æ˜", reading: "ã›ã¤ã‚ã„", vn: "Giáº£i thÃ­ch" },
            { no: 5, kanji: "åˆæœŸ", reading: "ã—ã‚‡ã", vn: "Khá»Ÿi táº¡o, ban Ä‘áº§u" },
            { no: 6, kanji: "ä½¿ç”¨", reading: "ã—ã‚ˆã†", vn: "Sá»­ dá»¥ng" },
            { no: 7, kanji: "å®Ÿè¡Œ", reading: "ã˜ã£ã“ã†", vn: "Thá»±c thi" },
            { no: 8, kanji: "å–å¾—", reading: "ã—ã‚…ã¨ã", vn: "Láº¥y (Get)" },
            { no: 9, kanji: "å–æ¶ˆ", reading: "ã¨ã‚Šã‘ã—", vn: "Huá»· bá»" },
            { no: 10, kanji: "å¤‰æ›´", reading: "ã¸ã‚“ã“ã†", vn: "Thay Ä‘á»•i" },
            { no: 11, kanji: "ç™»éŒ²", reading: "ã¨ã†ã‚ã", vn: "ÄÄƒng kÃ½" },
            { no: 12, kanji: "ç¢ºèª", reading: "ã‹ãã«ã‚“", vn: "XÃ¡c nháº­n" },
            { no: 13, kanji: "ä¿®æ­£", reading: "ã—ã‚…ã†ã›ã„", vn: "Chá»‰nh sá»­a" },
            { no: 14, kanji: "æ›´æ–°", reading: "ã“ã†ã—ã‚“", vn: "Cáº­p nháº­t" },
            { no: 15, kanji: "æ–°è¦", reading: "ã—ã‚“ã", vn: "LÃ m má»›i" },
            { no: 16, kanji: "ä½œæˆ", reading: "ã•ãã›ã„", vn: "Táº¡o" },
            { no: 17, kanji: "è¿½åŠ ", reading: "ã¤ã„ã‹", vn: "ThÃªm" },
            { no: 18, kanji: "å…¥åŠ›", reading: "ã«ã‚…ã†ã‚Šã‚‡ã", vn: "Nháº­p" },
            { no: 19, kanji: "å‡ºåŠ›", reading: "ã—ã‚…ã¤ã‚Šã‚‡ã", vn: "Xuáº¥t" },
            { no: 20, kanji: "æŠ¼ä¸‹", reading: "ãŠã†ã‹", vn: "Nháº¥n (click)" },
            { no: 21, kanji: "å‡¦ç†", reading: "ã—ã‚‡ã‚Š", vn: "Xá»­ lÃ½" },
            { no: 22, kanji: "è¨­å®š", reading: "ã›ã£ã¦ã„", vn: "Thiáº¿t láº­p" },
            { no: 23, kanji: "èµ·å‹•", reading: "ãã©ã†", vn: "Khá»Ÿi Ä‘á»™ng" },
            { no: 24, kanji: "è¡Œ", reading: "ãã‚‡ã†", vn: "DÃ²ng" },
            { no: 25, kanji: "æ¡", reading: "ã‘ãŸ", vn: "Sá»‘ chá»¯ / sá»‘ kÃ½ tá»±" }
        ];

        const N5_KANA = [
            { no: 1, kana: "ã‚¨ãƒ©ãƒ¼", english: "Error (Lá»—i)", vn: "Lá»—i (Error)" },
            { no: 2, kana: "ãƒ‡ãƒ¼ã‚¿", english: "Data", vn: "Dá»¯ liá»‡u (Data)" },
            { no: 3, kana: "ã‚³ãƒ¼ãƒ‰", english: "Code", vn: "MÃ£ (Code)" },
            { no: 4, kana: "ã‚½ãƒ¼ã‚¹", english: "Source", vn: "Nguá»“n (Source)" },
            { no: 5, kana: "ãƒªã‚¹ãƒˆ", english: "List", vn: "Danh sÃ¡ch (List)" },
            { no: 6, kana: "ãƒ†ã‚¹ãƒˆ", english: "Test", vn: "Kiá»ƒm thá»­ (Test)" },
            { no: 7, kana: "ãƒã‚¹ã‚¿", english: "Master", vn: "Master data" },
            { no: 8, kana: "ãƒ•ãƒ©ã‚°", english: "Flag", vn: "Cá» (Flag)" },
            { no: 9, kana: "ãƒ¬ãƒ™ãƒ«", english: "Level", vn: "Cáº¥p Ä‘á»™ (Level)" },
            { no: 10, kana: "ãƒ©ãƒ™ãƒ«", english: "Label", vn: "NhÃ£n (Label)" },
            { no: 11, kana: "ãƒ¦ãƒ¼ã‚¶", english: "User", vn: "NgÆ°á»i dÃ¹ng (User)" },
            { no: 12, kana: "ã‚µãƒ¼ãƒãƒ¼", english: "Server", vn: "MÃ¡y chá»§ (Server)" },
            { no: 13, kana: "ãƒ•ãƒ­ãƒ¼", english: "Flow", vn: "Luá»“ng (Flow)" },
            { no: 14, kana: "ã‚µãƒãƒª", english: "Summary", vn: "TÃ³m táº¯t (Summary)" },
            { no: 15, kana: "ãƒ†ãƒ¼ãƒ–ãƒ«", english: "Table", vn: "Báº£ng (Table)" },
            { no: 16, kana: "ã‚¿ã‚¤ãƒˆãƒ«", english: "Title", vn: "TiÃªu Ä‘á» (Title)" },
            { no: 17, kana: "ãƒ•ã‚¡ã‚¤ãƒ«", english: "File", vn: "Táº­p tin (File)" },
            { no: 18, kana: "ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰", english: "Field", vn: "TrÆ°á»ng (Field)" },
            { no: 19, kana: "ãƒ•ã‚©ãƒ«ãƒ€", english: "Folder", vn: "ThÆ° má»¥c (Folder)" },
            { no: 20, kana: "ãƒã‚§ãƒƒã‚¯", english: "Check", vn: "Kiá»ƒm tra (Check)" },
            { no: 21, kana: "ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ", english: "Layout", vn: "Bá»‘ cá»¥c (Layout)" },
            { no: 22, kana: "ã‚·ã‚¹ãƒ†ãƒ ", english: "System", vn: "Há»‡ thá»‘ng (System)" },
            { no: 23, kana: "ãƒ—ãƒ­ã‚°ãƒ©ãƒ ", english: "Program", vn: "ChÆ°Æ¡ng trÃ¬nh (Program)" },
            { no: 24, kana: "ãƒ†ã‚­ã‚¹ãƒˆ", english: "Text", vn: "VÄƒn báº£n (Text)" },
            { no: 25, kana: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", english: "Status", vn: "Tráº¡ng thÃ¡i (Status)" },
            { no: 26, kana: "ãƒ˜ãƒƒãƒ€ãƒ¼", english: "Header", vn: "Header" },
            { no: 27, kana: "ãƒ—ãƒ­ã‚»ã‚¹", english: "Process", vn: "Quy trÃ¬nh (Process)" },
            { no: 28, kana: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", english: "Message", vn: "ThÃ´ng bÃ¡o (Message)" },
            { no: 29, kana: "ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ", english: "Format", vn: "Äá»‹nh dáº¡ng (Format)" },
            { no: 30, kana: "ãƒ‘ã‚¿ãƒ¼ãƒ³", english: "Pattern", vn: "Máº«u (Pattern)" }
        ];

        const N4_MAIL = [
            { no: 1, jp: "QAã‚µã‚¤ãƒˆã«Q&A No.3ã€4ã€11ã€12ã€17ï½19ã®å›ç­”ã‚’è¨˜å…¥è‡´ã—ã¾ã—ãŸã®ã§ã€é€£çµ¡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚ã”ç¢ºèªã‚’ãŠé¡˜ã„è‡´ã—ã¾ã™ã€‚", vn: "TÃ´i Ä‘Ã£ ghi cÃ¢u tráº£ lá»i cho Q&A sá»‘ 3, 4, 11, 12, 17â€“19 trÃªn site QA... Nhá» anh/chá»‹ xÃ¡c nháº­n giÃºp." },
            { no: 2, jp: "ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ¥­å‹™ã®ä¸‹è¨˜ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã¦ç”»é¢ä¿®æ­£ãŒç™ºç”Ÿã„ãŸã—ã¾ã—ãŸã®ã§ã€æœ€æ–°ã®ç”»é¢å¸³ç¥¨è¨­è¨ˆæ›¸ã‚’é€ä»˜ã„ãŸã—ã¾ã™ã€‚", vn: "Trong quÃ¡ trÃ¬nh setup, chÆ°Æ¡ng trÃ¬nh bÃªn dÆ°á»›i phÃ¡t sinh chá»‰nh sá»­a mÃ n hÃ¬nh nÃªn tÃ´i xin gá»­i báº£n thiáº¿t káº¿ má»›i nháº¥t." },
            { no: 3, jp: "å¤§å¤‰å¤±ç¤¼è‡´ã—ã¾ã—ãŸãŒã€å…ˆã»ã©ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’èª¤ã£ã¦è¨˜è¼‰ã—ã¦ã—ã¾ã„ã¾ã—ãŸã®ã§ã€å†é€ã•ã›ã¦é ‚ãã¾ã™ã€‚", vn: "ThÃ nh tháº­t xin lá»—i vÃ¬ lÃºc nÃ£y tÃ´i Ä‘Ã£ ghi sai tiÃªu Ä‘á» project nÃªn xin phÃ©p gá»­i láº¡i." },
            { no: 4, jp: "ä½œæ¥­å„ªå…ˆé †ä½ã®ã”é€£çµ¡ãŒé…ããªã‚Šã¾ã—ã¦ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚ç¾åœ¨ãŠé¡˜ã„ã—ã¦ãŠã‚Šã¾ã™ä½œæ¥­ã¯ã€ä»¥ä¸‹ã®å„ªå…ˆé †ä½ã§é€²ã‚ã¦é ‚ã‘ã‚‹ã§ã—ã‚‡ã†ã‹ã€‚", vn: "Xin lá»—i vÃ¬ thÃ´ng bÃ¡o thá»© tá»± Æ°u tiÃªn cÃ´ng viá»‡c bá»‹ cháº­m. CÃ¡c cÃ´ng viá»‡c hiá»‡n táº¡i cÃ³ thá»ƒ tiáº¿n hÃ nh theo thá»© tá»± Æ°u tiÃªn bÃªn dÆ°á»›i Ä‘Æ°á»£c khÃ´ng?" },
            { no: 5, jp: "ä½œæ¥­ãŒäºˆå®šã‚ˆã‚Šé…ããªã£ã¦ã—ã¾ã„ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã§ã—ãŸã€‚ä½œæ¥­çµ‚äº†æ™‚ç‚¹ã®Ver7ç’°å¢ƒã‚’å¾¡ç¤¾FTPã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã„ãŸã—ã¾ã—ãŸã€‚", vn: "Xin lá»—i vÃ¬ cÃ´ng viá»‡c bá»‹ trá»…. TÃ´i Ä‘Ã£ upload mÃ´i trÆ°á»ng Ver7 lÃªn FTP server cá»§a quÃ½ cÃ´ng ty." }
        ];

        const N4_GRAMMAR = [
            { pattern: "ï½ã‚’å¯èƒ½ã«ã™ã‚‹", vn: "Cho phÃ©p / CÃ³ kháº£ nÄƒng" },
            { pattern: "ï½ã‚’ï½ã«ã‚»ãƒƒãƒˆã™ã‚‹", vn: "Set / Thiáº¿t láº­p ~ vÃ o ~" },
            { pattern: "ï½ã‚’ï½ã«è¿½åŠ ã™ã‚‹", vn: "ThÃªm ~ vÃ o ~" },
            { pattern: "ï½ã‚’ï½ã«å¤‰æ›´ã™ã‚‹", vn: "Thay Ä‘á»•i ~ thÃ nh ~" },
            { pattern: "ï½ã‹ã‚‰å¤–ã™", vn: "Loáº¡i bá» khá»i ~" },
            { pattern: "ï½ã‹ã‚‰å‰Šé™¤ã™ã‚‹", vn: "XÃ³a khá»i ~" },
            { pattern: "ï½ã«æˆ»ã™", vn: "Tráº£ vá» / Quay láº¡i" },
            { pattern: "ï½ã«å¯¾ã—ã¦", vn: "Äá»‘i vá»›i / LiÃªn quan Ä‘áº¿n" },
            { pattern: "ï½ã‚’æº€ãŸã™", vn: "Thoáº£ Ä‘iá»u kiá»‡n" },
            { pattern: "ï½ã‚’ã‚‚ã¨ã«", vn: "Dá»±a trÃªn ~" }
        ];

        const N4_VOCAB = [
            { jp: "è¨­è¨ˆ", reading: "ã›ã£ã‘ã„", vn: "Thiáº¿t káº¿" },
            { jp: "ç”»é¢", reading: "ãŒã‚ã‚“", vn: "MÃ n hÃ¬nh" },
            { jp: "é …ç›®", reading: "ã“ã†ã‚‚ã", vn: "Item" },
            { jp: "åˆæœŸ", reading: "ã—ã‚‡ã", vn: "Khá»Ÿi táº¡o" },
            { jp: "å®Ÿè¡Œ", reading: "ã˜ã£ã“ã†", vn: "Thá»±c thi" },
            { jp: "å¤‰æ›´", reading: "ã¸ã‚“ã“ã†", vn: "Thay Ä‘á»•i" },
            { jp: "ç™»éŒ²", reading: "ã¨ã†ã‚ã", vn: "ÄÄƒng kÃ½" },
            { jp: "ä¿®æ­£", reading: "ã—ã‚…ã†ã›ã„", vn: "Chá»‰nh sá»­a" },
            { jp: "æ›´æ–°", reading: "ã“ã†ã—ã‚“", vn: "Cáº­p nháº­t" },
            { jp: "è¿½åŠ ", reading: "ã¤ã„ã‹", vn: "ThÃªm" },
            { jp: "å…¥åŠ›", reading: "ã«ã‚…ã†ã‚Šã‚‡ã", vn: "Nháº­p" },
            { jp: "å‡ºåŠ›", reading: "ã—ã‚…ã¤ã‚Šã‚‡ã", vn: "Xuáº¥t" },
            { jp: "å‡¦ç†", reading: "ã—ã‚‡ã‚Š", vn: "Xá»­ lÃ½" },
            { jp: "è¨­å®š", reading: "ã›ã£ã¦ã„", vn: "Thiáº¿t láº­p" },
            { jp: "èµ·å‹•", reading: "ãã©ã†", vn: "Khá»Ÿi Ä‘á»™ng" },
            { jp: "ä¼šè­°", reading: "ã‹ã„ã", vn: "Cuá»™c há»p" },
            { jp: "ä¼šè­°å®¤", reading: "ã‹ã„ãã—ã¤", vn: "PhÃ²ng há»p" },
            { jp: "äºˆç´„", reading: "ã‚ˆã‚„ã", vn: "Äáº·t trÆ°á»›c" },
            { jp: "éƒ¨å±‹", reading: "ã¸ã‚„", vn: "PhÃ²ng" },
            { jp: "å…¥å®¤", reading: "ã«ã‚…ã†ã—ã¤", vn: "VÃ o phÃ²ng" },
            { jp: "é€€å®¤", reading: "ãŸã„ã—ã¤", vn: "Ra phÃ²ng" },
            { jp: "æ³¨æ–‡æ›¸", reading: "ã¡ã‚…ã†ã‚‚ã‚“ã—ã‚‡", vn: "ÄÆ¡n Ä‘áº·t hÃ ng" },
            { jp: "ç™ºæ³¨", reading: "ã¯ã£ã¡ã‚…ã†", vn: "Äáº·t hÃ ng" },
            { jp: "å—æ³¨", reading: "ã˜ã‚…ã¡ã‚…ã†", vn: "Nháº­n Ä‘Æ¡n" },
            { jp: "å¥‘ç´„", reading: "ã‘ã„ã‚„ã", vn: "Há»£p Ä‘á»“ng" },
            { jp: "ç´å“", reading: "ã®ã†ã²ã‚“", vn: "Giao hÃ ng" },
            { jp: "ç´æœŸ", reading: "ã®ã†ã", vn: "Háº¡n giao" },
            { jp: "å£²ä¸Š", reading: "ã†ã‚Šã‚ã’", vn: "Doanh thu" },
            { jp: "ä»•å…¥", reading: "ã—ã„ã‚Œ", vn: "Nháº­p hÃ ng" },
            { jp: "ç”Ÿç”£", reading: "ã›ã„ã•ã‚“", vn: "Sáº£n xuáº¥t" }
        ];

        // --- NEW N4 DATA ---
        const N4_NEW_GRAMMAR = [
            { "no": 1, "japanese": "ï½ã‚’ï½ã¨ã™ã‚‹ / ï½ã‚’ï½ã«ã™ã‚‹", "meaning_vn": "cho ~ lÃ  ~", "example": "ä¸€è¦§è¡¨ã®æœ€å¤§è¡¨ç¤ºä»¶æ•°ã‚’ç•¥ç§°ã¨ã™ã‚‹ã€‚" },
            { "no": 2, "japanese": "ï½ã‚’ï½ã«ã‚»ãƒƒãƒˆã™ã‚‹ / è¨­å®šã™ã‚‹", "meaning_vn": "set / setting ~ vÃ o ~", "example": "å„é …ç›®...ã®å€¤ã‚’è©²å½“ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚»ãƒƒãƒˆã™ã‚‹ã€‚" },
            { "no": 3, "japanese": "ï½ã‚’ï½ã«(æ–°è¦)è¿½åŠ ã™ã‚‹", "meaning_vn": "add thÃªm (má»›i) ~ vÃ o ~", "example": "ä»¥ä¸‹ã®å†…å®¹ã‚’å‡ºåŠ›å€¤ã«è¿½åŠ ã™ã‚‹ã€‚" },
            { "no": 4, "japanese": "ï½ã‚’ï½ã«å¤‰æ›´ã™ã‚‹ / ï½ã‚’ï½ã‹ã‚‰ï½ã«å¤‰æ›´ã™ã‚‹", "meaning_vn": "thay Ä‘á»•i ~ thÃ nh ~ / thay Ä‘á»•i ~ tá»« ~ thÃ nh ~", "example": "å±æ€§(eee)ã‚’0D-ã‹ã‚‰ADUã«å¤‰æ›´ã™ã‚‹ã€‚" },
            { "no": 5, "japanese": "ï½ã‚’ï½ã‹ã‚‰å¤–ã™ / ï½ã‹ã‚‰å¤–ã™ / ï½ã‹ã‚‰ï½ã‚’å‰Šé™¤ã™ã‚‹", "meaning_vn": "thÃ¡o khá»i ~ / thÃ¡o ~ ra khá»i ~ / xÃ³a ~ khá»i ~", "example": "è¨ˆç®—å¯¾è±¡ã‹ã‚‰å¤–ã™ã€‚" }
        ];

        const N4_NEW_BUSINESS = [
            { "kanji": "ä¼šè­°", "hiragana": "ã‹ã„ã", "meaning_vn": "Cuá»™c há»p" },
            { "kanji": "ä¼šè­°å®¤", "hiragana": "ã‹ã„ãã—ã¤", "meaning_vn": "PhÃ²ng há»p" },
            { "kanji": "äºˆç´„", "hiragana": "ã‚ˆã‚„ã", "meaning_vn": "Äáº·t trÆ°á»›c" },
            { "kanji": "éƒ¨å±‹", "hiragana": "ã¸ã‚„", "meaning_vn": "PhÃ²ng" },
            { "kanji": "å…¥å®¤", "hiragana": "ã«ã‚…ã†ã—ã¤", "meaning_vn": "VÃ o phÃ²ng" },
            { "kanji": "é€€å®¤", "hiragana": "ãŸã„ã—ã¤", "meaning_vn": "Ra phÃ²ng" },
            { "kanji": "æ³¨æ–‡æ›¸", "hiragana": "ã¡ã‚…ã†ã‚‚ã‚“ã—ã‚‡", "meaning_vn": "ÄÆ¡n Ä‘áº·t hÃ ng" },
            { "kanji": "ç™ºæ³¨", "hiragana": "ã¯ã£ã¡ã‚…ã†", "meaning_vn": "Äáº·t hÃ ng (Outgoing)" },
            { "kanji": "å—æ³¨", "hiragana": "ã˜ã‚…ã¡ã‚…ã†", "meaning_vn": "Nháº­n Ä‘Æ¡n (Incoming)" },
            { "kanji": "å¥‘ç´„", "hiragana": "ã‘ã„ã‚„ã", "meaning_vn": "Há»£p Ä‘á»“ng" },
            { "kanji": "ç´å“", "hiragana": "ã®ã†ã²ã‚“", "meaning_vn": "Giao hÃ ng (sáº£n pháº©m)" },
            { "kanji": "ç´æœŸ", "hiragana": "ã®ã†ã", "meaning_vn": "Háº¡n giao hÃ ng" },
            { "kanji": "å£²ä¸Š", "hiragana": "ã†ã‚Šã‚ã’", "meaning_vn": "Doanh thu" },
            { "kanji": "ä»•å…¥", "hiragana": "ã—ã„ã‚Œ", "meaning_vn": "Mua hÃ ng/Nháº­p hÃ ng" },
            { "kanji": "ç”Ÿç”£", "hiragana": "ã›ã„ã•ã‚“", "meaning_vn": "Sáº£n xuáº¥t" },
            { "kanji": "ä½œæˆ", "hiragana": "ã•ãã›ã„", "meaning_vn": "Táº¡o (document, file)" },
            { "kanji": "è¨ˆä¸Š", "hiragana": "ã‘ã„ã˜ã‚‡ã†", "meaning_vn": "Háº¡ch toÃ¡n/Ghi nháº­n" },
            { "kanji": "è«‹æ±‚", "hiragana": "ã›ã„ãã‚…ã†", "meaning_vn": "YÃªu cáº§u thanh toÃ¡n (Claim)" },
            { "kanji": "å›ç­”", "hiragana": "ã‹ã„ã¨ã†", "meaning_vn": "Tráº£ lá»i" },
            { "kanji": "ç¢ºèª", "hiragana": "ã‹ãã«ã‚“", "meaning_vn": "XÃ¡c nháº­n" },
            { "kanji": "æ‰¿èª", "hiragana": "ã—ã‚‡ã†ã«ã‚“", "meaning_vn": "PhÃª duyá»‡t (Approval)" },
            { "kanji": "å´ä¸‹", "hiragana": "ãã‚ƒã£ã‹", "meaning_vn": "Tá»« chá»‘i/BÃ¡c bá» (Reject)" },
            { "kanji": "å–æ¶ˆ", "hiragana": "ã¨ã‚Šã‘ã—", "meaning_vn": "Há»§y bá» (Cancel)" },
            { "kanji": "å®Œäº†", "hiragana": "ã‹ã‚“ã‚Šã‚‡ã†", "meaning_vn": "HoÃ n thÃ nh" },
            { "kanji": "åœ¨åº«", "hiragana": "ã–ã„ã“", "meaning_vn": "Tá»“n kho" },
            { "kanji": "æ£šå¸", "hiragana": "ãŸãªãŠã‚ã—", "meaning_vn": "Kiá»ƒm kÃª" },
            { "kanji": "å€‰åº«", "hiragana": "ãã†ã“", "meaning_vn": "Kho" },
            { "kanji": "æ‹…å½“è€…", "hiragana": "ãŸã‚“ã¨ã†ã—ã‚ƒ", "meaning_vn": "NgÆ°á»i phá»¥ trÃ¡ch" },
            { "kanji": "è²¬ä»»è€…", "hiragana": "ã›ãã«ã‚“ã—ã‚ƒ", "meaning_vn": "NgÆ°á»i chá»‹u trÃ¡ch nhiá»‡m" },
            { "kanji": "ç®¡ç†è€…", "hiragana": "ã‹ã‚“ã‚Šã—ã‚ƒ", "meaning_vn": "NgÆ°á»i quáº£n lÃ½ (Admin)" },
            { "kanji": "æ¨©é™", "hiragana": "ã‘ã‚“ã’ã‚“", "meaning_vn": "Quyá»n háº¡n" },
            { "kanji": "è¨±å¯", "hiragana": "ãã‚‡ã‹", "meaning_vn": "Cho phÃ©p" },
            { "kanji": "ç¦æ­¢", "hiragana": "ãã‚“ã—", "meaning_vn": "Cáº¥m" },
            { "kanji": "è¦å‰‡", "hiragana": "ããã", "meaning_vn": "Quy táº¯c" },
            { "kanji": "æ³•å¾‹", "hiragana": "ã»ã†ã‚Šã¤", "meaning_vn": "PhÃ¡p luáº­t" },
            { "kanji": "æ¡ä»¶", "hiragana": "ã˜ã‚‡ã†ã‘ã‚“", "meaning_vn": "Äiá»u kiá»‡n" },
            { "kanji": "å ´åˆ", "hiragana": "ã°ã‚ã„", "meaning_vn": "TrÆ°á»ng há»£p" },
            { "kanji": "çŠ¶æ³", "hiragana": "ã˜ã‚‡ã†ãã‚‡ã†", "meaning_vn": "TÃ¬nh tráº¡ng/Bá»‘i cáº£nh" },
            { "kanji": "çŠ¶æ…‹", "hiragana": "ã˜ã‚‡ã†ãŸã„", "meaning_vn": "Tráº¡ng thÃ¡i (State)" },
            { "kanji": "ç¾è±¡", "hiragana": "ã’ã‚“ã—ã‚‡ã†", "meaning_vn": "Hiá»‡n tÆ°á»£ng" },
            { "kanji": "ç†ç”±", "hiragana": "ã‚Šã‚†ã†", "meaning_vn": "LÃ½ do" },
            { "kanji": "åŸå› ", "hiragana": "ã’ã‚“ã„ã‚“", "meaning_vn": "NguyÃªn nhÃ¢n" },
            { "kanji": "çµæœ", "hiragana": "ã‘ã£ã‹", "meaning_vn": "Káº¿t quáº£" },
            { "kanji": "æ–¹æ³•", "hiragana": "ã»ã†ã»ã†", "meaning_vn": "PhÆ°Æ¡ng phÃ¡p" },
            { "kanji": "æ‰‹æ®µ", "hiragana": "ã—ã‚…ã ã‚“", "meaning_vn": "Thá»§ Ä‘oáº¡n/CÃ¡ch thá»©c" },
            { "kanji": "ç›®çš„", "hiragana": "ã‚‚ãã¦ã", "meaning_vn": "Má»¥c Ä‘Ã­ch" },
            { "kanji": "ç›®æ¨™", "hiragana": "ã‚‚ãã²ã‚‡ã†", "meaning_vn": "Má»¥c tiÃªu" },
            { "kanji": "è¨ˆç”»", "hiragana": "ã‘ã„ã‹ã", "meaning_vn": "Káº¿ hoáº¡ch" },
            { "kanji": "äºˆå®š", "hiragana": "ã‚ˆã¦ã„", "meaning_vn": "Dá»± Ä‘á»‹nh" },
            { "kanji": "å®Ÿç¸¾", "hiragana": "ã˜ã£ã›ã", "meaning_vn": "Thá»±c táº¿/ThÃ nh tÃ­ch" },
            { "kanji": "äºˆç®—", "hiragana": "ã‚ˆã•ã‚“", "meaning_vn": "NgÃ¢n sÃ¡ch" },
            { "kanji": "è²»ç”¨", "hiragana": "ã²ã‚ˆã†", "meaning_vn": "Chi phÃ­" },
            { "kanji": "çµŒè²»", "hiragana": "ã‘ã„ã²", "meaning_vn": "Kinh phÃ­" },
            { "kanji": "ã‚³ã‚¹ãƒˆ", "hiragana": "ã“ã™ã¨", "meaning_vn": "Cost" },
            { "kanji": "åˆ©ç›Š", "hiragana": "ã‚Šãˆã", "meaning_vn": "Lá»£i nhuáº­n" },
            { "kanji": "æå¤±", "hiragana": "ãã‚“ã—ã¤", "meaning_vn": "Tá»•n tháº¥t" },
            { "kanji": "èµ¤å­—", "hiragana": "ã‚ã‹ã˜", "meaning_vn": "Lá»— (Red letter)" },
            { "kanji": "é»’å­—", "hiragana": "ãã‚ã˜", "meaning_vn": "LÃ£i (Black letter)" },
            { "kanji": "é‡‘é¡", "hiragana": "ãã‚“ãŒã", "meaning_vn": "Sá»‘ tiá»n" },
            { "kanji": "ç¨è¾¼", "hiragana": "ãœã„ã“ã¿", "meaning_vn": "ÄÃ£ bao gá»“m thuáº¿" },
            { "kanji": "ç¨æŠœ", "hiragana": "ãœã„ã¬ã", "meaning_vn": "ChÆ°a bao gá»“m thuáº¿" },
            { "kanji": "å°è¨ˆ", "hiragana": "ã—ã‚‡ã†ã‘ã„", "meaning_vn": "Tá»•ng phá»¥ (Subtotal)" },
            { "kanji": "åˆè¨ˆ", "hiragana": "ã”ã†ã‘ã„", "meaning_vn": "Tá»•ng cá»™ng (Total)" },
            { "kanji": "å·®å¼•", "hiragana": "ã•ã—ã²ã", "meaning_vn": "Kháº¥u trá»«/Sá»‘ dÆ°" },
            { "kanji": "æ®‹é«˜", "hiragana": "ã–ã‚“ã ã‹", "meaning_vn": "Sá»‘ dÆ° tÃ i khoáº£n" },
            { "kanji": "æŒ¯è¾¼", "hiragana": "ãµã‚Šã“ã¿", "meaning_vn": "Chuyá»ƒn khoáº£n" },
            { "kanji": "æ‰‹æ•°æ–™", "hiragana": "ã¦ã™ã†ã‚Šã‚‡ã†", "meaning_vn": "PhÃ­ dá»‹ch vá»¥" },
            { "kanji": "é ˜åæ›¸", "hiragana": "ã‚Šã‚‡ã†ã—ã‚…ã†ã—ã‚‡", "meaning_vn": "HÃ³a Ä‘Æ¡n biÃªn lai" },
            { "kanji": "è«‹æ±‚æ›¸", "hiragana": "ã›ã„ãã‚…ã†ã—ã‚‡", "meaning_vn": "Giáº¥y yÃªu cáº§u thanh toÃ¡n" },
            { "kanji": "è¦‹ç©æ›¸", "hiragana": "ã¿ã¤ã‚‚ã‚Šã—ã‚‡", "meaning_vn": "Báº£ng bÃ¡o giÃ¡" },
            { "kanji": "ç´å“æ›¸", "hiragana": "ã®ã†ã²ã‚“ã—ã‚‡", "meaning_vn": "Phiáº¿u giao hÃ ng" },
            { "kanji": "å¥‘ç´„æ›¸", "hiragana": "ã‘ã„ã‚„ãã—ã‚‡", "meaning_vn": "Báº£n há»£p Ä‘á»“ng" },
            { "kanji": "ä»•æ§˜æ›¸", "hiragana": "ã—ã‚ˆã†ã—ã‚‡", "meaning_vn": "TÃ i liá»‡u Ä‘áº·c táº£ (Spec)" },
            { "kanji": "èª¬æ˜æ›¸", "hiragana": "ã›ã¤ã‚ã„ã—ã‚‡", "meaning_vn": "TÃ i liá»‡u hÆ°á»›ng dáº«n" },
            { "kanji": "å ±å‘Šæ›¸", "hiragana": "ã»ã†ã“ãã—ã‚‡", "meaning_vn": "BÃ¡o cÃ¡o" },
            { "kanji": "ææ¡ˆæ›¸", "hiragana": "ã¦ã„ã‚ã‚“ã—ã‚‡", "meaning_vn": "Báº£n Ä‘á» xuáº¥t" },
            { "kanji": "ä¼ç”»æ›¸", "hiragana": "ãã‹ãã—ã‚‡", "meaning_vn": "Báº£n káº¿ hoáº¡ch" }
        ];

        const N4_NEW_IT = [
            { "kanji": "è¨­è¨ˆ", "hiragana": "ã›ã£ã‘ã„", "meaning_vn": "Thiáº¿t káº¿" },
            { "kanji": "ç”»é¢", "hiragana": "ãŒã‚ã‚“", "meaning_vn": "MÃ n hÃ¬nh" },
            { "kanji": "æ©Ÿèƒ½", "hiragana": "ãã®ã†", "meaning_vn": "Chá»©c nÄƒng" },
            { "kanji": "é …ç›®", "hiragana": "ã“ã†ã‚‚ã", "meaning_vn": "Item/Má»¥c" },
            { "kanji": "è©³ç´°", "hiragana": "ã—ã‚‡ã†ã•ã„", "meaning_vn": "Chi tiáº¿t" },
            { "kanji": "æ¦‚è¦", "hiragana": "ãŒã„ã‚ˆã†", "meaning_vn": "KhÃ¡i quÃ¡t/Overview" },
            { "kanji": "èƒŒæ™¯", "hiragana": "ã¯ã„ã‘ã„", "meaning_vn": "Bá»‘i cáº£nh" },
            { "kanji": "ç¯„å›²", "hiragana": "ã¯ã‚“ã„", "meaning_vn": "Pháº¡m vi" },
            { "kanji": "å¯¾è±¡", "hiragana": "ãŸã„ã—ã‚‡ã†", "meaning_vn": "Äá»‘i tÆ°á»£ng" },
            { "kanji": "ä¾‹å¤–", "hiragana": "ã‚Œã„ãŒã„", "meaning_vn": "Ngoáº¡i lá»‡ (Exception)" },
            { "kanji": "åˆæœŸ", "hiragana": "ã—ã‚‡ã", "meaning_vn": "Ban Ä‘áº§u/Khá»Ÿi táº¡o" },
            { "kanji": "ä½¿ç”¨", "hiragana": "ã—ã‚ˆã†", "meaning_vn": "Sá»­ dá»¥ng" },
            { "kanji": "åˆ©ç”¨", "hiragana": "ã‚Šã‚ˆã†", "meaning_vn": "Sá»­ dá»¥ng (lá»£i dá»¥ng)" },
            { "kanji": "é‹ç”¨", "hiragana": "ã†ã‚“ã‚ˆã†", "meaning_vn": "Váº­n hÃ nh (Operation)" },
            { "kanji": "ä¿å®ˆ", "hiragana": "ã»ã—ã‚…", "meaning_vn": "Báº£o trÃ¬" },
            { "kanji": "é–‹ç™º", "hiragana": "ã‹ã„ã¯ã¤", "meaning_vn": "PhÃ¡t triá»ƒn (Dev)" },
            { "kanji": "è©¦é¨“", "hiragana": "ã—ã‘ã‚“", "meaning_vn": "Kiá»ƒm thá»­ (Test)" },
            { "kanji": "å®Ÿè¡Œ", "hiragana": "ã˜ã£ã“ã†", "meaning_vn": "Thá»±c thi (Run/Exec)" },
            { "kanji": "åœæ­¢", "hiragana": "ã¦ã„ã—", "meaning_vn": "Dá»«ng" },
            { "kanji": "é–‹å§‹", "hiragana": "ã‹ã„ã—", "meaning_vn": "Báº¯t Ä‘áº§u" },
            { "kanji": "çµ‚äº†", "hiragana": "ã—ã‚…ã†ã‚Šã‚‡ã†", "meaning_vn": "Káº¿t thÃºc" },
            { "kanji": "ä¸­æ­¢", "hiragana": "ã¡ã‚…ã†ã—", "meaning_vn": "Há»§y bá»/Ngá»«ng giá»¯a chá»«ng" },
            { "kanji": "ä¸­æ–­", "hiragana": "ã¡ã‚…ã†ã ã‚“", "meaning_vn": "GiÃ¡n Ä‘oáº¡n" },
            { "kanji": "å†é–‹", "hiragana": "ã•ã„ã‹ã„", "meaning_vn": "TÃ¡i khá»Ÿi Ä‘á»™ng/LÃ m láº¡i" },
            { "kanji": "æ¥ç¶š", "hiragana": "ã›ã¤ãã", "meaning_vn": "Káº¿t ná»‘i" },
            { "kanji": "åˆ‡æ–­", "hiragana": "ã›ã¤ã ã‚“", "meaning_vn": "Ngáº¯t káº¿t ná»‘i" },
            { "kanji": "é€šä¿¡", "hiragana": "ã¤ã†ã—ã‚“", "meaning_vn": "Truyá»n thÃ´ng/Giao tiáº¿p" },
            { "kanji": "é€ä¿¡", "hiragana": "ãã†ã—ã‚“", "meaning_vn": "Gá»­i (Send)" },
            { "kanji": "å—ä¿¡", "hiragana": "ã˜ã‚…ã—ã‚“", "meaning_vn": "Nháº­n (Receive)" },
            { "kanji": "è»¢é€", "hiragana": "ã¦ã‚“ãã†", "meaning_vn": "Chuyá»ƒn tiáº¿p (Forward)" },
            { "kanji": "è¿”ä¿¡", "hiragana": "ã¸ã‚“ã—ã‚“", "meaning_vn": "Tráº£ lá»i (Reply)" },
            { "kanji": "å–å¾—", "hiragana": "ã—ã‚…ã¨ã", "meaning_vn": "Láº¥y (Get)" },
            { "kanji": "æ¤œç´¢", "hiragana": "ã‘ã‚“ã•ã", "meaning_vn": "TÃ¬m kiáº¿m" },
            { "kanji": "æŠ½å‡º", "hiragana": "ã¡ã‚…ã†ã—ã‚…ã¤", "meaning_vn": "TrÃ­ch xuáº¥t" },
            { "kanji": "ç™»éŒ²", "hiragana": "ã¨ã†ã‚ã", "meaning_vn": "ÄÄƒng kÃ½" },
            { "kanji": "ä¿®æ­£", "hiragana": "ã—ã‚…ã†ã›ã„", "meaning_vn": "Chá»‰nh sá»­a (Fix)" },
            { "kanji": "å¤‰æ›´", "hiragana": "ã¸ã‚“ã“ã†", "meaning_vn": "Thay Ä‘á»•i (Change)" },
            { "kanji": "æ›´æ–°", "hiragana": "ã“ã†ã—ã‚“", "meaning_vn": "Cáº­p nháº­t (Update)" },
            { "kanji": "å‰Šé™¤", "hiragana": "ã•ãã˜ã‚‡", "meaning_vn": "XÃ³a (Delete)" },
            { "kanji": "è¿½åŠ ", "hiragana": "ã¤ã„ã‹", "meaning_vn": "ThÃªm (Add)" },
            { "kanji": "æŒ¿å…¥", "hiragana": "ãã†ã«ã‚…ã†", "meaning_vn": "ChÃ¨n (Insert)" },
            { "kanji": "ç§»å‹•", "hiragana": "ã„ã©ã†", "meaning_vn": "Di chuyá»ƒn" },
            { "kanji": "è¤‡å†™", "hiragana": "ãµãã—ã‚ƒ", "meaning_vn": "Sao chÃ©p (Copy)" },
            { "kanji": "ä¿å­˜", "hiragana": "ã»ãã‚“", "meaning_vn": "LÆ°u (Save)" },
            { "kanji": "ç ´æ£„", "hiragana": "ã¯ã", "meaning_vn": "Há»§y bá» (Discard)" },
            { "kanji": "å…¥åŠ›", "hiragana": "ã«ã‚…ã†ã‚Šã‚‡ã", "meaning_vn": "Nháº­p (Input)" },
            { "kanji": "å‡ºåŠ›", "hiragana": "ã—ã‚…ã¤ã‚Šã‚‡ã", "meaning_vn": "Xuáº¥t (Output)" },
            { "kanji": "å°åˆ·", "hiragana": "ã„ã‚“ã•ã¤", "meaning_vn": "In (Print)" },
            { "kanji": "è¡¨ç¤º", "hiragana": "ã²ã‚‡ã†ã˜", "meaning_vn": "Hiá»ƒn thá»‹" },
            { "kanji": "éè¡¨ç¤º", "hiragana": "ã²ã²ã‚‡ã†ã˜", "meaning_vn": "áº¨n (Hidden)" },
            { "kanji": "é¸æŠ", "hiragana": "ã›ã‚“ãŸã", "meaning_vn": "Lá»±a chá»n" },
            { "kanji": "æŒ‡å®š", "hiragana": "ã—ã¦ã„", "meaning_vn": "Chá»‰ Ä‘á»‹nh" },
            { "kanji": "è¨­å®š", "hiragana": "ã›ã£ã¦ã„", "meaning_vn": "Thiáº¿t láº­p (Setting)" },
            { "kanji": "æ§‹æˆ", "hiragana": "ã“ã†ã›ã„", "meaning_vn": "Cáº¥u hÃ¬nh (Config)" },
            { "kanji": "ç’°å¢ƒ", "hiragana": "ã‹ã‚“ãã‚‡ã†", "meaning_vn": "MÃ´i trÆ°á»ng" },
            { "kanji": "å®šç¾©", "hiragana": "ã¦ã„ã", "meaning_vn": "Äá»‹nh nghÄ©a" },
            { "kanji": "å®£è¨€", "hiragana": "ã›ã‚“ã’ã‚“", "meaning_vn": "Khai bÃ¡o" },
            { "kanji": "å¤‰æ•°", "hiragana": "ã¸ã‚“ã™ã†", "meaning_vn": "Biáº¿n sá»‘" },
            { "kanji": "å®šæ•°", "hiragana": "ã¦ã„ã™ã†", "meaning_vn": "Háº±ng sá»‘" },
            { "kanji": "å¼•æ•°", "hiragana": "ã²ãã™ã†", "meaning_vn": "Tham sá»‘ (Argument)" },
            { "kanji": "æˆ»ã‚Šå€¤", "hiragana": "ã‚‚ã©ã‚Šã¡", "meaning_vn": "GiÃ¡ trá»‹ tráº£ vá»" },
            { "kanji": "é–¢æ•°", "hiragana": "ã‹ã‚“ã™ã†", "meaning_vn": "HÃ m (Function)" },
            { "kanji": "å‡¦ç†", "hiragana": "ã—ã‚‡ã‚Š", "meaning_vn": "Xá»­ lÃ½" },
            { "kanji": "è¨ˆç®—", "hiragana": "ã‘ã„ã•ã‚“", "meaning_vn": "TÃ­nh toÃ¡n" },
            { "kanji": "æ¼”ç®—", "hiragana": "ãˆã‚“ã–ã‚“", "meaning_vn": "PhÃ©p toÃ¡n" },
            { "kanji": "æ¯”è¼ƒ", "hiragana": "ã²ã‹ã", "meaning_vn": "So sÃ¡nh" },
            { "kanji": "åˆ¶å¾¡", "hiragana": "ã›ã„ãã‚‡", "meaning_vn": "Äiá»u khiá»ƒn (Control)" },
            { "kanji": "æ§‹é€ ", "hiragana": "ã“ã†ãã†", "meaning_vn": "Cáº¥u trÃºc" },
            { "kanji": "éšå±¤", "hiragana": "ã‹ã„ãã†", "meaning_vn": "PhÃ¢n táº§ng (Hierarchy)" },
            { "kanji": "é€£æº", "hiragana": "ã‚Œã‚“ã‘ã„", "meaning_vn": "LiÃªn káº¿t/Phá»‘i há»£p" },
            { "kanji": "çµ±åˆ", "hiragana": "ã¨ã†ã”ã†", "meaning_vn": "TÃ­ch há»£p" },
            { "kanji": "åˆ†é›¢", "hiragana": "ã¶ã‚“ã‚Š", "meaning_vn": "TÃ¡ch biá»‡t" },
            { "kanji": "åˆ†å‰²", "hiragana": "ã¶ã‚“ã‹ã¤", "meaning_vn": "Chia nhá»" },
            { "kanji": "å…±é€š", "hiragana": "ãã‚‡ã†ã¤ã†", "meaning_vn": "Chung/Common" },
            { "kanji": "å€‹åˆ¥", "hiragana": "ã“ã¹ã¤", "meaning_vn": "RiÃªng biá»‡t" },
            { "kanji": "æ—¢å­˜", "hiragana": "ããã‚“", "meaning_vn": "ÄÃ£ cÃ³/Hiá»‡n táº¡i" },
            { "kanji": "æ–°è¦", "hiragana": "ã—ã‚“ã", "meaning_vn": "Má»›i (New)" },
            { "kanji": "æœ€å¤§", "hiragana": "ã•ã„ã ã„", "meaning_vn": "Tá»‘i Ä‘a" },
            { "kanji": "æœ€å°", "hiragana": "ã•ã„ã—ã‚‡ã†", "meaning_vn": "Tá»‘i thiá»ƒu" },
            { "kanji": "å¹³å‡", "hiragana": "ã¸ã„ãã‚“", "meaning_vn": "Trung bÃ¬nh" },
            { "kanji": "åˆè¨ˆ", "hiragana": "ã”ã†ã‘ã„", "meaning_vn": "Tá»•ng cá»™ng" },
            { "kanji": "ä»¶æ•°", "hiragana": "ã‘ã‚“ã™ã†", "meaning_vn": "Sá»‘ lÆ°á»£ng (báº£n ghi)" },
            { "kanji": "å›æ•°", "hiragana": "ã‹ã„ã™ã†", "meaning_vn": "Sá»‘ láº§n" },
            { "kanji": "ç•ªå·", "hiragana": "ã°ã‚“ã”ã†", "meaning_vn": "Sá»‘ (No.)" },
            { "kanji": "æ—¥ä»˜", "hiragana": "ã²ã¥ã‘", "meaning_vn": "NgÃ y thÃ¡ng" },
            { "kanji": "æ™‚åˆ»", "hiragana": "ã˜ã“ã", "meaning_vn": "Thá»i kháº¯c" },
            { "kanji": "æœŸé–“", "hiragana": "ãã‹ã‚“", "meaning_vn": "Khoáº£ng thá»i gian" },
            { "kanji": "æ™‚é–“", "hiragana": "ã˜ã‹ã‚“", "meaning_vn": "Thá»i gian" }
        ];

        // --- APP LOGIC ---
        
        class JapaneseApp {
            constructor() {
                // Initial State
                this.state = {
                    currentUser: null,
                    users: JSON.parse(localStorage.getItem('it_jp_users_profile') || '[]'),
                    screen: 'login', 
                    game: {
                        active: false,
                        questions: [],
                        currentIndex: 0,
                        score: 0,
                        timer: 15,
                        interval: null,
                        mode: null,
                        level: null,
                        timerEnabled: true
                    },
                    flashcard: { list: [], index: 0, flipped: false },
                    scores: JSON.parse(localStorage.getItem('it_jp_scores') || '[]'),
                    leaderboardFilter: 'all',
                    selectedAvatar: null,
                    pendingGame: null
                };

                // Cute Avatars
                this.avatars = [
                    { icon: 'ğŸ±', color: 'bg-orange-100' },
                    { icon: 'ğŸ¶', color: 'bg-blue-100' },
                    { icon: 'ğŸ°', color: 'bg-pink-100' },
                    { icon: 'ğŸ¼', color: 'bg-gray-100' },
                    { icon: 'ğŸ¦Š', color: 'bg-red-100' },
                    { icon: 'ğŸ¯', color: 'bg-yellow-100' },
                    { icon: 'ğŸ¸', color: 'bg-green-100' },
                    { icon: 'ğŸ·', color: 'bg-rose-100' },
                    { icon: 'ğŸ¨', color: 'bg-slate-200' },
                    { icon: 'ğŸ£', color: 'bg-yellow-50' }
                ];

                // Remove loading immediately since we are local
                setTimeout(() => this.finishLoading(), 500);

                this.bindEvents();
            }

            finishLoading() {
                document.getElementById('screen-loading').classList.add('hidden');
                // Check local storage for last logged in user
                const lastUser = localStorage.getItem('it_jp_username');
                
                if (lastUser && this.state.users.find(u => u.name === lastUser)) {
                    const userObj = this.state.users.find(u => u.name === lastUser);
                    this.login(userObj);
                } else {
                    this.renderLoginScreen();
                    this.showScreen('screen-login');
                }
            }

            // --- USER MANAGEMENT ---
            
            renderLoginScreen() {
                const hasUsers = this.state.users.length > 0;
                const viewList = document.getElementById('login-view-list');
                const viewCreate = document.getElementById('login-view-create');
                const btnCancel = document.getElementById('btn-cancel-create');

                if (hasUsers) {
                    viewList.classList.remove('hidden');
                    viewCreate.classList.add('hidden');
                    btnCancel.classList.remove('hidden'); // Allow cancel if users exist
                    this.renderUserList();
                } else {
                    viewList.classList.add('hidden');
                    viewCreate.classList.remove('hidden');
                    btnCancel.classList.add('hidden'); // Cannot cancel if no users
                    this.renderAvatarSelection();
                }
            }

            renderUserList() {
                const container = document.getElementById('user-list-grid');
                container.innerHTML = this.state.users.map(u => `
                    <div class="user-card cursor-pointer bg-gray-50 hover:bg-white hover:shadow-md border border-gray-100 rounded-xl p-3 flex flex-col items-center gap-2 transition-all active:scale-95" onclick="app.loginByName('${u.name}')">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl ${u.color || 'bg-gray-100'}">
                            ${u.avatar || 'ğŸ‘¤'}
                        </div>
                        <span class="font-bold text-gray-700 text-sm truncate w-full text-center">${u.name}</span>
                    </div>
                `).join('');
            }

            renderAvatarSelection() {
                const container = document.getElementById('avatar-grid');
                container.innerHTML = this.avatars.map((a, idx) => `
                    <div class="avatar-option cursor-pointer rounded-xl aspect-square flex items-center justify-center text-2xl border-2 border-transparent hover:bg-gray-50 transition-all ${a.color}" 
                         onclick="app.selectAvatar(${idx}, this)">
                        ${a.icon}
                    </div>
                `).join('');
                this.state.selectedAvatar = null;
            }

            selectAvatar(idx, el) {
                document.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected', 'ring-2', 'ring-indigo-400'));
                el.classList.add('selected', 'ring-2', 'ring-indigo-400');
                this.state.selectedAvatar = this.avatars[idx];
            }

            showCreateUser() {
                document.getElementById('login-view-list').classList.add('hidden');
                document.getElementById('login-view-create').classList.remove('hidden');
                document.getElementById('create-user-input').value = '';
                this.renderAvatarSelection();
            }

            cancelCreateUser() {
                this.renderLoginScreen();
            }

            createUser() {
                const name = document.getElementById('create-user-input').value.trim();
                const avatar = this.state.selectedAvatar;

                if (!name) {
                    alert("Vui lÃ²ng nháº­p tÃªn!");
                    return;
                }
                if (!avatar) {
                    alert("Vui lÃ²ng chá»n má»™t Avatar!");
                    return;
                }
                
                // Check duplicate
                if (this.state.users.some(u => u.name === name)) {
                    alert("TÃªn nÃ y Ä‘Ã£ tá»“n táº¡i, vui lÃ²ng chá»n tÃªn khÃ¡c!");
                    return;
                }

                const newUser = {
                    name: name,
                    avatar: avatar.icon,
                    color: avatar.color
                };

                this.state.users.push(newUser);
                localStorage.setItem('it_jp_users_profile', JSON.stringify(this.state.users));
                
                this.login(newUser);
            }

            loginByName(name) {
                const user = this.state.users.find(u => u.name === name);
                if (user) this.login(user);
            }

            login(user) {
                this.state.currentUser = user;
                localStorage.setItem('it_jp_username', user.name);
                
                // Update Dashboard UI
                document.getElementById('user-display-name').textContent = user.name;
                const avatarEl = document.getElementById('dashboard-avatar');
                avatarEl.textContent = user.avatar;
                avatarEl.className = `w-10 h-10 rounded-xl flex items-center justify-center text-xl shadow-lg ${user.color}`;

                this.showDashboard();
            }

            logout() {
                this.state.currentUser = null;
                localStorage.removeItem('it_jp_username');
                this.renderLoginScreen();
                this.showScreen('screen-login');
            }

            // --- NAVIGATION ---
            showScreen(id) {
                document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                window.scrollTo(0,0);
                this.state.screen = id;
            }

            showDashboard() {
                if (!this.state.currentUser) return;
                this.loadLeaderboard();
                this.showScreen('screen-dashboard');
            }

            // --- LEADERBOARD & FILTER ---
            loadLeaderboard() {
                const filter = this.state.leaderboardFilter;
                
                // Filter Logic
                let filteredData = this.state.scores.filter(s => {
                    if (filter === 'all') return true;
                    // Format in data: N5, jp_vn -> we match with value e.g "N5_jp_vn"
                    const entryKey = `${s.level}_${s.mode}`;
                    return entryKey === filter;
                });

                // Sort Descending
                filteredData.sort((a, b) => b.score - a.score);
                
                // Take top 50
                const data = filteredData.slice(0, 50);

                const container = document.getElementById('leaderboard-container');
                
                if (data.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-400 py-4 italic">ChÆ°a cÃ³ dá»¯ liá»‡u cho má»¥c nÃ y.</p>`;
                } else {
                    container.innerHTML = data.map((s, idx) => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white ${idx < 3 ? 'bg-yellow-400' : 'bg-gray-300'}">${idx + 1}</div>
                                <div>
                                    <p class="font-bold text-gray-700 text-sm">${s.userName}</p>
                                    <p class="text-[10px] text-gray-400 uppercase font-bold text-indigo-400">${this.getModeLabel(s.level, s.mode)}</p>
                                </div>
                            </div>
                            <span class="font-black text-indigo-600">${s.score}/${s.total}</span>
                        </div>
                    `).join('');
                }
                lucide.createIcons();
                
                // Update Total Count (Total exams taken by user, regardless of filter)
                const userScores = this.state.scores.filter(s => s.userName === this.state.currentUser.name);
                document.getElementById('user-score-count').innerText = userScores.length;
            }

            filterLeaderboard(value) {
                this.state.leaderboardFilter = value;
                this.loadLeaderboard();
            }

            getModeLabel(level, mode) {
                if (level === 'All') return 'Tá»•ng há»£p 100 cÃ¢u';
                
                const map = { 
                    'jp_vn': 'Nháº­t âœ Viá»‡t', 
                    'vn_jp': 'Viá»‡t âœ Nháº­t', 
                    'kanji_hira': 'Kanji âœ Hiragana', 
                    'hira_kanji': 'Hiragana âœ Kanji',
                    'mixed': 'Trá»™n N5 & N4'
                };
                return `${level} â€¢ ${map[mode] || mode}`;
            }

            // --- DICTIONARY ---
            showDictionary() {
                this.renderDictionary();
                this.showScreen('screen-dictionary');
            }

            renderDictionary(filter = '') {
                // Combine OLD and NEW data
                const allData = [
                    ...N5_VOCAB, 
                    ...N5_KANA, 
                    ...N4_VOCAB, 
                    ...N4_MAIL, 
                    ...N4_GRAMMAR,
                    // New N4 Data mappings for dictionary
                    ...N4_NEW_BUSINESS.map(v => ({ kanji: v.kanji, reading: v.hiragana, vn: v.meaning_vn })),
                    ...N4_NEW_IT.map(v => ({ kanji: v.kanji, reading: v.hiragana, vn: v.meaning_vn })),
                    ...N4_NEW_GRAMMAR.map(g => ({ kanji: g.japanese, vn: g.meaning_vn, reading: 'Grammar' }))
                ];

                const tbody = document.getElementById('dict-body');
                const term = filter.toLowerCase();
                
                const filtered = allData.filter(item => {
                     const t1 = (item.kanji || item.kana || item.pattern || item.jp || '').toLowerCase();
                     const t2 = (item.reading || item.english || '').toLowerCase();
                     const t3 = (item.vn || '').toLowerCase();
                     return t1.includes(term) || t2.includes(term) || t3.includes(term);
                });

                tbody.innerHTML = filtered.map(item => `
                    <tr class="hover:bg-blue-50/50 transition-colors">
                       <td class="p-5 font-black text-gray-800">${item.kanji || item.kana || item.pattern || item.jp}</td>
                       <td class="p-5 text-blue-500">${item.reading || item.english || '-'}</td>
                       <td class="p-5 text-gray-600">${item.vn}</td>
                    </tr>
                `).join('');
            }

            // --- GAME LOGIC ---
            
            // New: Open Config Modal
            openGameConfig(level, mode) {
                this.state.pendingGame = { level, mode };
                
                // Update Modal UI
                const title = this.getModeTitle(mode);
                document.getElementById('config-mode-name').textContent = level === 'All' ? title : `${level} - ${title}`;
                
                // Reset Toggle to ON by default
                document.getElementById('config-timer-toggle').checked = true;
                
                document.getElementById('modal-game-config').classList.remove('hidden');
            }

            // New: Confirm start from modal
            confirmStartGame() {
                if (!this.state.pendingGame) return;
                
                const timerEnabled = document.getElementById('config-timer-toggle').checked;
                this.startGame(this.state.pendingGame.level, this.state.pendingGame.mode, timerEnabled);
                
                document.getElementById('modal-game-config').classList.add('hidden');
                this.state.pendingGame = null;
            }

            startGame(level, mode, timerEnabled = true) {
                this.state.game.level = level;
                this.state.game.mode = mode;
                this.state.game.timerEnabled = timerEnabled; // Set timer config
                this.state.game.questions = this.generateQuestions(level, mode);
                this.state.game.currentIndex = 0;
                this.state.game.score = 0;
                this.state.game.active = true;
                
                // UI update
                document.getElementById('game-mode-title').textContent = this.getModeTitle(mode);
                this.showScreen('screen-game');
                this.renderQuestion();
            }

            getModeTitle(mode) {
                if (mode === 'mixed') return 'Tá»•ng há»£p N5 & N4';
                const map = { 'jp_vn': 'Nháº­t âœ Viá»‡t', 'vn_jp': 'Viá»‡t âœ Nháº­t', 'kanji_hira': 'Kanji âœ Hiragana', 'hira_kanji': 'Hiragana âœ Kanji' };
                return map[mode] || mode;
            }

            generateQuestions(level, mode) {
                let pool = [];
                let limit = 10;

                // --- DATA MAPPING HELPERS ---
                // Helper to map the new N4 structure to the old standard {kanji, reading, vn}
                const mapNewN4Vocab = (list) => list.map(v => ({ kanji: v.kanji, reading: v.hiragana, vn: v.meaning_vn }));
                const mapNewN4Grammar = (list) => list.map(g => ({ kanji: g.japanese, vn: g.meaning_vn, reading: 'Grammar', isLong: true }));

                if (level === 'All' && mode === 'mixed') {
                    // Combine ALL sources (Old + New)
                    pool = [
                        ...N5_VOCAB, 
                        ...N5_KANA.map(k => ({kanji: k.kana, reading: k.kana, vn: k.vn})),
                        ...N4_VOCAB.map(v => ({...v, kanji: v.jp})),
                        ...N4_MAIL.map(m => ({kanji: m.jp, vn: m.vn, reading: 'Mail Sample', isLong: true})), 
                        ...N4_GRAMMAR.map(g => ({kanji: g.pattern, vn: g.vn, reading: 'Grammar', isLong: true})),
                        // ADD NEW DATA HERE
                        ...mapNewN4Vocab(N4_NEW_BUSINESS),
                        ...mapNewN4Vocab(N4_NEW_IT),
                        ...mapNewN4Grammar(N4_NEW_GRAMMAR)
                    ];
                    limit = 100;
                }
                else if (level === 'N5') {
                    pool = [
                        ...N5_VOCAB, 
                        ...N5_KANA.map(k => ({...k, kanji: k.kana, reading: k.kana, isKatakana: true}))
                    ];
                } else {
                    // N4 Level (Old + New Data merged for better experience)
                    pool = [
                        ...N4_VOCAB.map(v => ({ ...v, kanji: v.jp })), 
                        ...N4_MAIL.map(m => ({kanji: m.jp, vn: m.vn, reading: 'Mail Sample', isLong: true})), 
                        ...N4_GRAMMAR.map(g => ({kanji: g.pattern, vn: g.vn, reading: 'Grammar', isLong: true})),
                         // ADD NEW DATA HERE
                        ...mapNewN4Vocab(N4_NEW_BUSINESS),
                        ...mapNewN4Vocab(N4_NEW_IT),
                        ...mapNewN4Grammar(N4_NEW_GRAMMAR)
                    ];
                }

                // Filtering based on mode (Only for specific modes, mixed skips this)
                if (mode === 'kanji_hira' || mode === 'hira_kanji') {
                    pool = pool.filter(i => !i.isKatakana && !i.isLong && i.kanji && i.reading && i.kanji !== i.reading);
                }

                // Randomize Pool
                pool.sort(() => 0.5 - Math.random());
                
                // Select Items
                const count = Math.min(pool.length, limit);
                const items = pool.slice(0, count);

                return items.map(item => {
                    let q, a, distractors;
                    
                    const getDis = (field) => {
                        return pool
                            .filter(i => i !== item && i[field])
                            .sort(() => 0.5 - Math.random())
                            .slice(0, 3)
                            .map(i => i[field]);
                    };

                    if (mode === 'mixed') {
                         // Randomize question type for each item in mixed mode
                         const type = Math.random();
                         if (item.isLong) {
                             // Always JP -> VN for long text
                             q = item.kanji; a = item.vn; distractors = getDis('vn');
                         } else if (type < 0.33) {
                             // JP -> VN
                             q = item.kanji; a = item.vn; distractors = getDis('vn');
                         } else if (type < 0.66) {
                             // VN -> JP
                             q = item.vn; a = item.kanji; distractors = getDis('kanji');
                         } else {
                             // Reading check (Kanji -> Hira)
                             q = item.kanji; a = item.reading; distractors = getDis('reading');
                         }
                    } 
                    else if (mode === 'jp_vn') {
                        q = item.kanji; a = item.vn; distractors = getDis('vn');
                    } else if (mode === 'vn_jp') {
                        q = item.vn; a = item.kanji; distractors = getDis('kanji');
                    } else if (mode === 'kanji_hira') {
                        q = item.kanji; a = item.reading; distractors = getDis('reading');
                    } else if (mode === 'hira_kanji') {
                        q = item.reading; a = item.kanji; distractors = getDis('kanji');
                    }
                    
                    // Safety check
                    if (!q || !a || distractors.length < 3) return null;

                    return { 
                        q, a, 
                        opts: [a, ...distractors].sort(() => 0.5 - Math.random()),
                        explain: `${item.kanji} âœ ${item.vn}`
                    };
                }).filter(q => q !== null);
            }

            renderQuestion() {
                const g = this.state.game;
                const q = g.questions[g.currentIndex];
                
                // Update UI
                document.getElementById('game-progress').textContent = `${g.currentIndex + 1}/${g.questions.length}`;
                document.getElementById('question-text').textContent = q.q;
                
                const grid = document.getElementById('answers-grid');
                grid.innerHTML = q.opts.map(opt => `
                    <button class="answer-btn h-20 text-lg md:text-xl font-bold text-gray-600 bg-white border-2 border-gray-200 rounded-xl hover:text-indigo-600 hover:border-indigo-400 hover:bg-indigo-50 transition-all active:scale-[0.98] shadow-sm overflow-hidden p-2 leading-tight">
                        ${opt}
                    </button>
                `).join('');

                // Bind click
                grid.querySelectorAll('.answer-btn').forEach(btn => {
                    btn.onclick = () => this.handleAnswer(btn.innerText.trim());
                });

                // Reset Timer
                this.startTimer();
                
                // Hide feedback
                document.getElementById('feedback-overlay').classList.add('hidden');
            }

            startTimer() {
                if (this.state.game.interval) clearInterval(this.state.game.interval);
                
                const bar = document.getElementById('timer-bar');
                
                // Handle Disable Timer Logic
                if (!this.state.game.timerEnabled) {
                    bar.style.width = '100%';
                    bar.classList.remove('bg-blue-500', 'bg-red-500');
                    bar.classList.add('bg-gray-300'); // Grey bar to indicate no timer
                    return; // EXIT FUNCTION, NO INTERVAL
                }

                // Standard Timer Logic
                this.state.game.timer = 15;
                bar.classList.remove('bg-gray-300');
                
                const updateBar = () => {
                    const pct = (this.state.game.timer / 15) * 100;
                    bar.style.width = `${pct}%`;
                    if (this.state.game.timer < 5) {
                        bar.classList.remove('bg-blue-500');
                        bar.classList.add('bg-red-500');
                    } else {
                        bar.classList.add('bg-blue-500');
                        bar.classList.remove('bg-red-500');
                    }
                };
                updateBar();

                this.state.game.interval = setInterval(() => {
                    this.state.game.timer--;
                    updateBar();
                    if (this.state.game.timer <= 0) {
                        this.playSound('wrong');
                        this.handleAnswer("___TIMEOUT___");
                    }
                }, 1000);
            }

            handleAnswer(selected) {
                if (!this.state.game.active) return;
                clearInterval(this.state.game.interval);
                
                const g = this.state.game;
                const q = g.questions[g.currentIndex];
                const isCorrect = selected === q.a;

                // Show Feedback
                const overlay = document.getElementById('feedback-overlay');
                const content = document.getElementById('feedback-content');
                overlay.classList.remove('hidden');

                if (isCorrect) {
                    this.playSound('correct');
                    g.score++;
                    content.innerHTML = `
                        <div class="flex flex-col items-center text-emerald-500 animate-bounce">
                            <!-- Raw SVG for Check Circle -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-2 text-emerald-500 fill-current text-white"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            <span class="font-black text-2xl">ÄÃšNG!</span>
                        </div>
                    `;
                } else {
                    this.playSound('wrong');
                    content.innerHTML = `
                        <div class="flex flex-col items-center text-rose-500">
                            <!-- Raw SVG for X Circle -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-2 fill-current text-white animate-pulse"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                            <span class="font-black text-2xl mb-1">SAI!</span>
                            <div class="bg-rose-50 px-4 py-2 rounded-lg text-rose-700 text-sm font-bold">ÄÃ¡p Ã¡n: ${q.a}</div>
                        </div>
                    `;
                }
                
                // Next Q
                setTimeout(() => {
                    if (g.currentIndex < g.questions.length - 1) {
                        g.currentIndex++;
                        this.renderQuestion();
                    } else {
                        this.endGame();
                    }
                }, 1000);
            }

            checkHighScore(currentScore, level, mode) {
                // Filter all scores for current user AND current mode AND current level
                const history = this.state.scores.filter(s => 
                    s.userName === this.state.currentUser.name && 
                    s.level === level && 
                    s.mode === mode
                );

                // Requirement: Only trigger if there IS history and score is better
                if (history.length === 0) return false; 

                // Find max previous score
                const maxPrevious = history.reduce((max, s) => Math.max(max, s.score), 0);
                
                return currentScore > maxPrevious;
            }

            async endGame() {
                const g = this.state.game;
                g.active = false;
                
                // Check High Score BEFORE pushing new entry
                const isHighScore = this.checkHighScore(g.score, g.level, g.mode);
                const isPerfect = g.score === g.questions.length;

                // Save to Local Storage
                const newEntry = {
                    userName: this.state.currentUser.name,
                    level: g.level,
                    mode: g.mode,
                    score: g.score,
                    total: g.questions.length,
                    timestamp: new Date().toISOString()
                };

                this.state.scores.push(newEntry);
                
                localStorage.setItem('it_jp_scores', JSON.stringify(this.state.scores));

                // TRIGGER EFFECTS
                if (isHighScore || isPerfect) {
                    this.playSound('win');
                    // Intense Confetti for High Score
                    this.triggerConfetti({ intense: true });
                    
                    if (isHighScore) {
                        document.getElementById('victory-message').innerText = "Báº¡n Ä‘Ã£ phÃ¡ ká»· lá»¥c cá»§a chÃ­nh mÃ¬nh!";
                    } else {
                        document.getElementById('victory-message').innerText = "Äiá»ƒm tuyá»‡t Ä‘á»‘i!";
                    }
                    
                    document.getElementById('victory-score').innerText = `${g.score}/${g.questions.length}`;
                    document.getElementById('victory-overlay').classList.remove('hidden');
                } else {
                    this.playSound('win');
                    // Mild Confetti for Completion
                    this.triggerConfetti({ intense: false });
                    
                    document.getElementById('completion-score').innerText = `${g.score}/${g.questions.length}`;
                    document.getElementById('completion-overlay').classList.remove('hidden');
                }
            }
            
            closeVictoryModal() {
                document.getElementById('victory-overlay').classList.add('hidden');
                this.showDashboard();
            }

            closeCompletionModal() {
                document.getElementById('completion-overlay').classList.add('hidden');
                this.showDashboard();
            }

            triggerConfetti(options = { intense: false }) {
                if (typeof confetti === 'function') {
                    if (options.intense) {
                        // Intense: Multi-cannon, longer
                        const duration = 3000;
                        const end = Date.now() + duration;

                        (function frame() {
                            confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#6366f1', '#fbbf24', '#f43f5e'] });
                            confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#6366f1', '#fbbf24', '#f43f5e'] });
                            if (Date.now() < end) requestAnimationFrame(frame);
                        }());
                    } else {
                        // Mild: Single burst
                        confetti({
                            particleCount: 100,
                            spread: 70,
                            origin: { y: 0.6 },
                            colors: ['#a855f7', '#3b82f6', '#10b981']
                        });
                    }
                }
            }

            // --- FLASHCARD LOGIC ---
            startFlashcard(level) {
                // Update Select Box
                const select = document.getElementById('fc-level-select');
                if(select) select.value = level;
                
                this.loadFlashcardData(level);
                this.showScreen('screen-flashcard');
            }

            loadFlashcardData(level) {
                let list;
                
                // Helper mapping new N4 data to flashcard format
                const mapNewN4Vocab = (list) => list.map(v => ({ kanji: v.kanji, reading: v.hiragana, vn: v.meaning_vn }));

                if (level === 'N5') {
                    list = [...N5_VOCAB];
                } else {
                    // N4 Flashcards now include new data
                    list = [
                        ...N4_VOCAB.map(v => ({ ...v, kanji: v.jp })),
                        ...mapNewN4Vocab(N4_NEW_BUSINESS),
                        ...mapNewN4Vocab(N4_NEW_IT)
                    ];
                }
                
                this.state.flashcard.list = list.sort(() => 0.5 - Math.random());
                this.state.flashcard.index = 0;
                this.state.flashcard.flipped = false;
                this.renderFlashcard();
            }

            renderFlashcard() {
                const f = this.state.flashcard;
                if (!f.list || f.list.length === 0) return;

                const card = f.list[f.index];
                
                // Reset Flip
                f.flipped = false;
                document.getElementById('flashcard-inner').classList.remove('rotate-y-180');

                // Update content
                document.getElementById('flashcard-count').innerText = `${f.index + 1} / ${f.list.length}`;
                document.getElementById('fc-front-text').innerText = card.kanji || card.jp;
                document.getElementById('fc-back-reading').innerText = card.reading;
                document.getElementById('fc-back-meaning').innerText = card.vn;
            }

            toggleFlashcard() {
                this.state.flashcard.flipped = !this.state.flashcard.flipped;
                const el = document.getElementById('flashcard-inner');
                if (this.state.flashcard.flipped) {
                    el.classList.add('rotate-y-180');
                    this.playSound('flip');
                } else {
                    el.classList.remove('rotate-y-180');
                    this.playSound('flip');
                }
            }

            // --- EVENTS ---
            bindEvents() {
                // User Create Events
                document.getElementById('btn-show-create').onclick = () => this.showCreateUser();
                document.getElementById('btn-cancel-create').onclick = () => this.cancelCreateUser();
                document.getElementById('btn-confirm-create').onclick = () => this.createUser();

                // Logout
                document.getElementById('btn-logout').onclick = () => this.logout();
                
                // Config Modal Events
                document.getElementById('btn-start-configured-game').onclick = () => this.confirmStartGame();

                // Game Quit
                document.getElementById('btn-quit-game').onclick = () => this.showModal("ThoÃ¡t bÃ i kiá»ƒm tra?", "Káº¿t quáº£ sáº½ khÃ´ng Ä‘Æ°á»£c lÆ°u.", () => {
                    clearInterval(this.state.game.interval);
                    this.showDashboard();
                });

                // Dictionary Search
                document.getElementById('dict-search').oninput = (e) => this.renderDictionary(e.target.value);

                // Flashcard Controls
                document.getElementById('flashcard-container').onclick = () => this.toggleFlashcard();
                document.getElementById('fc-next').onclick = () => {
                    const f = this.state.flashcard;
                    if (f.index < f.list.length - 1) { f.index++; this.renderFlashcard(); }
                };
                document.getElementById('fc-prev').onclick = () => {
                    const f = this.state.flashcard;
                    if (f.index > 0) { f.index--; this.renderFlashcard(); }
                };
                document.getElementById('fc-shuffle').onclick = () => {
                    const f = this.state.flashcard;
                    f.list.sort(() => 0.5 - Math.random());
                    f.index = 0;
                    this.renderFlashcard();
                };
                
                // Flashcard Level Selector Event
                document.getElementById('fc-level-select').onchange = (e) => {
                    this.loadFlashcardData(e.target.value);
                };

                // Modal
                document.getElementById('modal-btn-cancel').onclick = () => document.getElementById('modal-overlay').classList.add('hidden');
            }

            showModal(title, text, onConfirm) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-content').innerText = text;
                const overlay = document.getElementById('modal-overlay');
                overlay.classList.remove('hidden');
                
                const btn = document.getElementById('modal-btn-confirm');
                btn.onclick = () => {
                    onConfirm();
                    overlay.classList.add('hidden');
                };
            }

            playSound(type) {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gn = ctx.createGain();
                osc.connect(gn);
                gn.connect(ctx.destination);
                const t = ctx.currentTime;

                if (type === 'correct') {
                    osc.frequency.setValueAtTime(500, t); osc.frequency.exponentialRampToValueAtTime(1000, t + 0.1);
                    gn.gain.setValueAtTime(0.1, t); gn.gain.exponentialRampToValueAtTime(0.01, t + 0.4);
                    osc.start(t); osc.stop(t + 0.4);
                } else if (type === 'wrong') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, t); osc.frequency.linearRampToValueAtTime(100, t + 0.2);
                    gn.gain.setValueAtTime(0.1, t); gn.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
                    osc.start(t); osc.stop(t + 0.3);
                } else if (type === 'click') {
                    osc.frequency.setValueAtTime(600, t); gn.gain.setValueAtTime(0.05, t); gn.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
                    osc.start(t); osc.stop(t + 0.05);
                } else if (type === 'flip') {
                    osc.frequency.setValueAtTime(300, t); osc.frequency.linearRampToValueAtTime(400, t + 0.05);
                    gn.gain.setValueAtTime(0.05, t); gn.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                    osc.start(t); osc.stop(t + 0.1);
                } else if (type === 'win') {
                    [523, 659, 783, 1046].forEach((f, i) => {
                        const o = ctx.createOscillator(); const g = ctx.createGain();
                        o.connect(g); g.connect(ctx.destination);
                        o.frequency.value = f;
                        g.gain.setValueAtTime(0.05, t + i*0.1); g.gain.exponentialRampToValueAtTime(0.001, t + i*0.1 + 0.3);
                        o.start(t + i*0.1); o.stop(t + i*0.1 + 0.3);
                    });
                }
            }
        }

        // Init App
        window.app = new JapaneseApp();
        lucide.createIcons();
    </script>
</body>
</html>